<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>On Pointe Prevention </title>
    <link rel="stylesheet" href="./style.css">

  </head>
    
  <body>
  <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>On Pointe Prevention</title>
  <meta name="theme-color" content="#0B0B0D" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="On Pointe">
  <style>
    :root{
      --bg:#0B0B0D;
      --card:#121218;
      --card2:#171721;
      --muted:#9AA0A6;
      --text:#F4F5F7;
      --line:rgba(255,255,255,.08);
      --accent:#E8E2D6; /* soft ballet neutral */
      --accent2:#BCA98E; /* warm taupe */
      --ok:#39d98a;
      --caution:#ffb020;
      --high:#ff5c5c;
      --shadow: 0 16px 38px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --pad:16px;
      --pad2:20px;
      --font: -apple-system,BlinkMacSystemFont, "SF Pro Display","SF Pro Text", Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(232,226,214,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 0%, rgba(188,169,142,.16), transparent 50%),
        radial-gradient(900px 700px at 50% 110%, rgba(232,226,214,.09), transparent 55%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom: 0; /* moved to main container */
    }

    /* Top bar */
    .top{
      position:sticky;
      top:0;
      z-index:20;
      padding: calc(env(safe-area-inset-top) + 10px) var(--pad) 12px;
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom, rgba(11,11,13,.92), rgba(11,11,13,.55));
      border-bottom:1px solid var(--line);
    }
    .brandRow{
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, rgba(232,226,214,.95), rgba(188,169,142,.95));
      box-shadow: 0 10px 22px rgba(0,0,0,.3);
      position:relative;
      flex:0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute; inset:8px 10px 10px 8px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.25);
      opacity:.35;
    }
    .titleWrap{min-width:0}
    .title{
      font-weight:700;
      letter-spacing:.2px;
      font-size:16px;
      line-height:1.1;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      margin:0;
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .topActions{display:flex; gap:10px; align-items:center}
    .pillBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .pillBtn:active{transform:scale(.98)}
    .tinyDot{
      width:8px;height:8px;border-radius:999px;
      background: var(--accent);
      opacity:.9;
    }

    /* Layout */
    .container{padding: 14px var(--pad)}
    .grid{
      display:grid;
      gap:12px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardInner{padding: var(--pad2)}
    .cardHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .h{
      margin:0;
      font-size:14px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .small{
      font-size:12px; color:var(--muted); margin-top:3px; line-height:1.25;
    }

    .metrics{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .metric{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px 12px;
      min-width:0;
    }
    .metric .k{font-size:11px;color:var(--muted)}
    .metric .v{margin-top:4px;font-size:16px;font-weight:750; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .metric .s{margin-top:3px;font-size:11px;color:rgba(255,255,255,.65)}

    /* Status badge */
    .badge{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
      background: rgba(255,255,255,.04);
    }
    .badgeDot{width:8px;height:8px;border-radius:999px}
    .badge.ok .badgeDot{background:var(--ok)}
    .badge.caution .badgeDot{background:var(--caution)}
    .badge.high .badgeDot{background:var(--high)}

    /* Buttons */
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      border:1px solid var(--line);
      background: rgba(232,226,214,.08);
      color: var(--text);
      padding:12px 14px;
      border-radius: 14px;
      font-size:13px;
      font-weight:650;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; gap:10px;
    }
    .btn.secondary{
      background: rgba(255,255,255,.04);
    }
    .btn:active{transform:scale(.99)}
    .btn .ic{opacity:.9}

    /* Form */
    .form{
      display:grid;
      gap:14px;
    }
    .field{
      display:grid;
      gap:6px;
    }
    .labelRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:12px;
      color: rgba(255,255,255,.85);
    }
    .val{
      font-variant-numeric: tabular-nums;
      color: rgba(255,255,255,.88);
      font-weight:650;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    input[type="date"], input[type="text"], textarea{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{min-height:70px; resize:vertical}
    .hint{font-size:11px;color:var(--muted); line-height:1.25}

    /* Lists */
    .list{
      display:grid; gap:10px;
      margin-top:10px;
    }
    .row{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .rowMain{min-width:0}
    .rowTop{
      display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;
      margin-bottom:2px;
    }
    .rowTitle{font-weight:750; font-size:13px}
    .rowMeta{font-size:12px;color:rgba(255,255,255,.65)}
    .rowSub{font-size:12px;color:var(--muted); line-height:1.3}
    .rowRight{
      display:flex; flex-direction:column; align-items:flex-end; gap:6px;
      flex:0 0 auto;
    }
    .chip{
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      font-size:11px;
      color: rgba(255,255,255,.85);
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }
    .iconBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:active{transform:scale(.98)}
    .iconBtn.danger{border-color: rgba(255,92,92,.35); background: rgba(255,92,92,.08)}
    .iconBtn.good{border-color: rgba(57,217,138,.3); background: rgba(57,217,138,.08)}

    /* Tabs */
    .tabs{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      z-index:30;
      padding: 10px 12px calc(env(safe-area-inset-bottom) + 10px);
      background: linear-gradient(to top, rgba(11,11,13,.94), rgba(11,11,13,.65));
      border-top:1px solid var(--line);
      backdrop-filter: blur(16px);
    }
    .tabRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.86);
      border-radius: 16px;
      padding:10px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size:11px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(232,226,214,.10);
      border-color: rgba(232,226,214,.25);
      color: var(--text);
    }
    .tab .emoji{font-size:16px; line-height:1}

    /* Chart */
    canvas{
      width:100%;
      height:160px;
      display:block;
      background: rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius: 16px;
    }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:50;
      padding: 12px 12px calc(env(safe-area-inset-bottom) + 12px);
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:100%;
      max-width:520px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,18,24,.96), rgba(18,18,24,.90));
      border-radius: 22px;
      box-shadow: 0 25px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalTop{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalTitle{font-weight:800; font-size:14px; margin:0}
    .close{cursor:pointer}
    .modalBody{padding: 14px 16px; max-height: 70vh; overflow:auto}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size:12px;
      margin-bottom:10px;
      color: rgba(255,255,255,.88);
    }
    .bullet{margin:8px 0; color: rgba(255,255,255,.82); font-size:13px; line-height:1.35}
    .bullet strong{color:var(--text)}
    .divider{height:1px;background:var(--line); margin:12px 0}
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 100px;
      z-index:60;
      background: rgba(18,18,24,.92);
      border:1px solid var(--line);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.9);
      display:none;
      box-shadow: 0 15px 40px rgba(0,0,0,.55);
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="top">
    <div class="brandRow">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="titleWrap">
          <p class="title">On Pointe Prevention‚Ñ¢</p>
          <p class="subtitle" id="subline">PT-guided load monitoring + conditioning</p>
        </div>
      </div>
      <div class="topActions">
        <button class="pillBtn" id="installBtn" style="display:none">
          <span class="tinyDot"></span> Install
        </button>
        <button class="pillBtn" id="exportBtn">
          <span class="tinyDot"></span> Export CSV
        </button>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- DASHBOARD -->
    <section id="view-dashboard" class="grid">
      <div class="card">
        <div class="cardInner">
          <div class="cardHeader">
            <div>
              <p class="h">Injury Risk Snapshot</p>
              <div class="small" id="dashNote">Based on acute/chronic load + recovery markers.</div>
            </div>
            <div class="badge ok" id="statusBadge">
              <span class="badgeDot"></span><span id="statusText">OK</span>
            </div>
          </div>

          <div class="metrics">
            <div class="metric">
              <div class="k">ACWR</div>
              <div class="v" id="mACWR">‚Äî</div>
              <div class="s" id="mACWRHint">acute / chronic</div>
            </div>
            <div class="metric">
              <div class="k">Acute (7d avg)</div>
              <div class="v" id="mAcute">‚Äî</div>
              <div class="s">session load</div>
            </div>
            <div class="metric">
              <div class="k">Chronic (28d avg)</div>
              <div class="v" id="mChronic">‚Äî</div>
              <div class="s">session load</div>
            </div>
          </div>

          <div class="divider"></div>
          <p class="h" style="margin:0 0 6px 0;">Guidance</p>
          <div class="small" id="guidance">‚Äî</div>

          <div class="btnRow">
            <button class="btn" id="quickTodayBtn"><span class="ic">üìù</span> Today‚Äôs Check-In</button>
            <button class="btn secondary" id="goExercisesBtn"><span class="ic">ü©∞</span> Exercise Library</button>
            <button class="btn secondary" id="clearBtn"><span class="ic">üóëÔ∏è</span> Clear Data</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardInner">
          <div class="cardHeader">
            <div>
              <p class="h">Trends</p>
              <div class="small">Last 14 sessions (session load).</div>
            </div>
            <div class="chip" id="trendChip">‚Äî</div>
          </div>
          <canvas id="chart" width="800" height="320"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="cardInner">
          <div class="cardHeader">
            <div>
              <p class="h">Last 7 Days</p>
              <div class="small">Quick view of recent entries.</div>
            </div>
          </div>
          <div class="list" id="recentList"></div>
        </div>
      </div>
    </section>

    <!-- CHECK-IN -->
    <section id="view-checkin" class="grid" style="display:none">
      <div class="card">
        <div class="cardInner">
          <div class="cardHeader">
            <div>
              <p class="h">Daily Check-In</p>
              <div class="small">Minutes + RPE = session load. Track recovery & symptoms.</div>
            </div>
            <div class="chip" id="sessionLoadChip">Load: ‚Äî</div>
          </div>

          <div class="form">
            <div class="field">
              <div class="labelRow">
                <span>Date</span>
                <span class="val" id="datePretty">‚Äî</span>
              </div>
              <input type="date" id="date" />
              <div class="hint">Tip: you can edit past days too.</div>
            </div>

            <div class="field">
              <div class="labelRow">
                <span>Dance Minutes</span><span class="val" id="vMinutes">60</span>
              </div>
              <input type="range" min="0" max="360" step="5" value="60" id="minutes" />
              <div class="hint">Includes rehearsal + class + run-throughs.</div>
            </div>

            <div class="field">
              <div class="labelRow">
                <span>RPE (1‚Äì10)</span><span class="val" id="vRPE">6</span>
              </div>
              <input type="range" min="1" max="10" step="1" value="6" id="rpe" />
              <div class="hint">Perceived exertion (how hard it felt).</div>
            </div>

            <div class="field">
              <div class="labelRow">
                <span>Sleep Hours</span><span class="val" id="vSleep">7.0</span>
              </div>
              <input type="range" min="0" max="12" step="0.5" value="7" id="sleep" />
              <div class="hint">Recovery marker: low sleep increases overload risk.</div>
            </div>

            <div class="field">
              <div class="labelRow">
                <span>Soreness (0‚Äì10)</span><span class="val" id="vSoreness">3</span>
              </div>
              <input type="range" min="0" max="10" step="1" value="3" id="soreness" />
            </div>

            <div class="field">
              <div class="labelRow">
                <span>Fatigue (0‚Äì10)</span><span class="val" id="vFatigue">4</span>
              </div>
              <input type="range" min="0" max="10" step="1" value="4" id="fatigue" />
            </div>

            <div class="field">
              <div class="labelRow">
                <span>Notes (optional)</span><span class="val" id="notesCount">0</span>
              </div>
              <textarea id="notes" placeholder="e.g., long rehearsal, more jumps, pointe work, pain location, travel, stress‚Ä¶"></textarea>
              <div class="hint">Useful for PT decision-making and identifying spikes (time, travel, stress, performance week).</div>
            </div>

            <div class="btnRow">
              <button class="btn" id="saveBtn"><span class="ic">üíæ</span> Save</button>
              <button class="btn secondary" id="loadTodayBtn"><span class="ic">üìå</span> Load Today</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- EXERCISES -->
    <section id="view-exercises" class="grid" style="display:none">
      <div class="card">
        <div class="cardInner">
          <div class="cardHeader">
            <div>
              <p class="h">Exercise Library</p>
              <div class="small">Dance-specific strength + neuromuscular control (30 min, 2‚Äì3√ó/week).</div>
            </div>
            <div class="chip" id="favChip">‚òÖ 0</div>
          </div>

          <div class="form" style="gap:10px">
            <input id="search" type="text" placeholder="Search exercises‚Ä¶" />
            <div class="btnRow" style="margin-top:0">
              <button class="btn secondary" data-cat="all">All</button>
              <button class="btn secondary" data-cat="Foot & Ankle">Foot/Ankle</button>
              <button class="btn secondary" data-cat="Knee & Hip">Knee/Hip</button>
              <button class="btn secondary" data-cat="Core & Lumbar">Core/Lumbar</button>
              <button class="btn secondary" data-cat="Balance & Neuromuscular">Balance</button>
              <button class="btn secondary" data-cat="Conditioning">Conditioning</button>
              <button class="btn secondary" id="toggleFavsBtn">‚òÖ Favorites</button>
            </div>
          </div>

          <div class="list" id="exerciseList"></div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="view-history" class="grid" style="display:none">
      <div class="card">
        <div class="cardInner">
          <div class="cardHeader">
            <div>
              <p class="h">History</p>
              <div class="small">Edit/delete entries. Summaries help justify program value.</div>
            </div>
            <div class="chip" id="countChip">0 entries</div>
          </div>

          <div class="metrics" style="grid-template-columns: repeat(3, 1fr); margin-top:0">
            <div class="metric">
              <div class="k">7d total load</div>
              <div class="v" id="sum7">‚Äî</div>
              <div class="s">sum</div>
            </div>
            <div class="metric">
              <div class="k">28d total load</div>
              <div class="v" id="sum28">‚Äî</div>
              <div class="s">sum</div>
            </div>
            <div class="metric">
              <div class="k">Avg RPE (7d)</div>
              <div class="v" id="avgRPE7">‚Äî</div>
              <div class="s">mean</div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="list" id="historyList"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tabRow">
      <button class="tab active" data-view="dashboard"><div class="emoji">üìä</div><div>Dashboard</div></button>
      <button class="tab" data-view="checkin"><div class="emoji">üìù</div><div>Check-In</div></button>
      <button class="tab" data-view="exercises"><div class="emoji">ü©∞</div><div>Exercises</div></button>
      <button class="tab" data-view="history"><div class="emoji">üóìÔ∏è</div><div>History</div></button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalTop">
        <p class="modalTitle" id="modalTitle">Exercise</p>
        <button class="pillBtn close" id="closeModal"><span class="tinyDot"></span> Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast">Saved ‚úì</div>

<script>
/* =========================
   On Pointe Prevention‚Ñ¢
   Single-file PWA MVP
   ========================= */

const STORAGE_KEY = "opp_entries_v2";
const FAV_KEY = "opp_favs_v1";

const $ = (id) => document.getElementById(id);

// Views
const views = {
  dashboard: $("view-dashboard"),
  checkin: $("view-checkin"),
  exercises: $("view-exercises"),
  history: $("view-history"),
};

// Tabs
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=> switchView(btn.dataset.view));
});

function switchView(name){
  Object.values(views).forEach(v=> v.style.display="none");
  views[name].style.display="grid";
  document.querySelectorAll(".tab").forEach(t=> t.classList.toggle("active", t.dataset.view===name));
  if(name==="dashboard") renderDashboard();
  if(name==="exercises") renderExercises();
  if(name==="history") renderHistory();
  if(name==="checkin") syncCheckinUI();
}

// Data helpers
function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function prettyDate(iso){
  const d = new Date(iso+"T12:00:00");
  return d.toLocaleDateString(undefined, {weekday:"short", month:"short", day:"numeric"});
}
function loadEntries(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }
  catch{ return []; }
}
function saveEntries(list){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}
function loadFavs(){
  try{ return JSON.parse(localStorage.getItem(FAV_KEY)||"[]"); }
  catch{ return []; }
}
function saveFavs(list){
  localStorage.setItem(FAV_KEY, JSON.stringify(list));
}
function normalizeEntries(list){
  // ensure iso date and computed load
  return list
    .filter(e=> e && e.date)
    .map(e=>({
      date: e.date,
      minutes: Number(e.minutes||0),
      rpe: Number(e.rpe||1),
      sleep: Number(e.sleep||0),
      soreness: Number(e.soreness||0),
      fatigue: Number(e.fatigue||0),
      notes: String(e.notes||""),
      load: Math.max(0, Math.round(Number(e.minutes||0) * Number(e.rpe||1)))
    }))
    .sort((a,b)=> a.date.localeCompare(b.date));
}
function upsertEntry(entry){
  let list = normalizeEntries(loadEntries());
  const idx = list.findIndex(x=> x.date===entry.date);
  if(idx>=0) list[idx]=entry; else list.push(entry);
  list = normalizeEntries(list);
  saveEntries(list);
  return list;
}
function deleteEntry(dateISO){
  let list = normalizeEntries(loadEntries());
  list = list.filter(e=> e.date!==dateISO);
  saveEntries(list);
  return list;
}
function getEntry(dateISO){
  const list = normalizeEntries(loadEntries());
  return list.find(e=> e.date===dateISO) || null;
}

// Seed exercises
const EXERCISES = [
  {
    id:"shortfoot",
    name:"Short Foot (Arch Doming)",
    category:"Foot & Ankle",
    goal:"Improve intrinsic foot strength and arch control for releve/landing.",
    dosage:"2‚Äì3 sets of 8‚Äì12 reps, 3‚Äì5 sec holds, 3√ó/week",
    cues:["Keep toes long; don‚Äôt claw.","Maintain tripod contact (heel, 1st & 5th met heads).","Gently draw ball of foot toward heel."],
    regressions:["Seated short foot","Reduce hold time"],
    progressions:["Single-leg stance + short foot","Add controlled releve with slow lowering"]
  },
  {
    id:"calfecc",
    name:"Eccentric Calf Raise (Straight Knee)",
    category:"Foot & Ankle",
    goal:"Build plantarflexor capacity for repeated pointe/releve demands.",
    dosage:"3 sets of 6‚Äì10 each side, 2‚Äì3√ó/week",
    cues:["Up with both, down slowly with one (3‚Äì4 sec).","Avoid sickling; heel tracks straight.","Stop before form breaks."],
    regressions:["Both legs up/down","Smaller range"],
    progressions:["Add load (backpack)","Tempo: 5 sec eccentric"]
  },
  {
    id:"soleus",
    name:"Soleus Raise (Bent Knee)",
    category:"Foot & Ankle",
    goal:"Improve bent-knee plantarflexor endurance for jumps and sustained work.",
    dosage:"2‚Äì4 sets of 10‚Äì20, 2‚Äì3√ó/week",
    cues:["Knee stays forward over 2nd toe.","Control tempo; full available range.","Keep arch supported."],
    regressions:["Double-leg","Reduce range"],
    progressions:["Single-leg","Add load"]
  },
  {
    id:"slrdl",
    name:"Single-Leg RDL (Hip Hinge)",
    category:"Knee & Hip",
    goal:"Posterior chain control + single-limb stability for landings/turns.",
    dosage:"2‚Äì3 sets of 6‚Äì10 each side, 2‚Äì3√ó/week",
    cues:["Hips square; avoid rotation.","Soft knee; hinge at the hip.","Reach long through the heel."],
    regressions:["Hands supported","Kickstand RDL"],
    progressions:["Add load","Add 3-direction reach"]
  },
  {
    id:"split",
    name:"Rear-Foot Elevated Split Squat (RFESS)",
    category:"Knee & Hip",
    goal:"Build unilateral strength to tolerate volume without knee collapse.",
    dosage:"3 sets of 6‚Äì10 each side, 2√ó/week",
    cues:["Front knee tracks over 2nd toe.","Maintain tall trunk; control descent.","Drive through full foot tripod."],
    regressions:["Split squat (no elevation)","Shorter range"],
    progressions:["Add load","Tempo: 3 sec eccentric"]
  },
  {
    id:"deadbug",
    name:"Dead Bug (Breath + Core Control)",
    category:"Core & Lumbar",
    goal:"Trunk control and fatigue-resistant alignment.",
    dosage:"2‚Äì3 sets of 6‚Äì10/side, 3√ó/week",
    cues:["Exhale to set ribs down.","Move slow; keep pelvis steady.","Stop if back arches."],
    regressions:["Heel taps only","Shorter lever arms"],
    progressions:["Band resistance","Long-lever dead bug"]
  },
  {
    id:"sideplank",
    name:"Side Plank (Hip Abduction Bias)",
    category:"Core & Lumbar",
    goal:"Lateral trunk/hip control for single-limb stability.",
    dosage:"2‚Äì3 sets of 20‚Äì40 sec each side, 2‚Äì4√ó/week",
    cues:["Long line from head to heel.","Avoid hip drop.","Keep ribs stacked."],
    regressions:["Knees bent","Shorter holds"],
    progressions:["Top-leg abduction","Star plank"]
  },
  {
    id:"ybalance",
    name:"Star Excursion / Y-Balance Prep",
    category:"Balance & Neuromuscular",
    goal:"Neuromuscular control for landings and directional changes.",
    dosage:"2 rounds each direction, 2‚Äì4√ó/week",
    cues:["Stable stance foot tripod.","Avoid knee valgus.","Quality > distance."],
    regressions:["Fewer directions","Smaller reach"],
    progressions:["Tempo holds","Add light external load"]
  },
  {
    id:"landing",
    name:"Landing Mechanics (Snap-Down + Stick)",
    category:"Balance & Neuromuscular",
    goal:"Train safe landings under fatigue while preserving performance quality.",
    dosage:"3‚Äì5 sets of 3‚Äì5 reps, 2‚Äì3√ó/week",
    cues:["Land quietly; absorb through hips/knees/ankles.","Knee tracks over toes.","Stick the landing 2 seconds."],
    regressions:["Smaller hops","Two-leg only"],
    progressions:["Single-leg stick","Add turn / direction change"]
  },
  {
    id:"zone2",
    name:"Zone 2 Aerobic Base (Low Impact)",
    category:"Conditioning",
    goal:"Improve recovery capacity and workload tolerance.",
    dosage:"20‚Äì30 min, 2‚Äì4√ó/week",
    cues:["Conversational pace.","Prefer low impact (bike/elliptical).","Stop if symptoms flare."],
    regressions:["Shorter duration","Lower intensity"],
    progressions:["Add 5 min/week","Add 1 interval day carefully"]
  }
];

// Risk engine
function riskReport(entries){
  const list = normalizeEntries(entries);
  const last = list[list.length-1] || null;

  // Average load windows based on calendar days
  function inWindow(days){
    if(list.length===0) return [];
    const end = new Date((last? last.date : todayISO())+"T12:00:00");
    const start = new Date(end);
    start.setDate(start.getDate() - (days-1));
    return list.filter(e=>{
      const d = new Date(e.date+"T12:00:00");
      return d >= start && d <= end;
    });
  }
  const acuteW = inWindow(7);
  const chronicW = inWindow(28);

  const avg = (arr)=> arr.length ? arr.reduce((s,e)=>s+e.load,0)/arr.length : 0;
  const acute = avg(acuteW);
  const chronic = avg(chronicW);
  const acwr = chronic>0 ? acute/chronic : 0;

  const fatigueFlag = last ? last.fatigue >= 7 : false;
  const sorenessFlag = last ? last.soreness >= 7 : false;
  const sleepFlag   = last ? last.sleep < 6 : false;

  let severity="ok";
  let status="OK";
  let message="Workload appears stable. Continue progressive conditioning and monitor recovery.";
  if(acwr >= 1.5 || (fatigueFlag && sorenessFlag)){
    severity="high";
    status="High Risk";
    message="Load spike detected. Consider reducing volume/intensity for 24‚Äì48h, focus on recovery, and keep technique quality high.";
  } else if(acwr >= 1.3 || fatigueFlag || sorenessFlag || sleepFlag){
    severity="caution";
    status="Caution";
    message="Trending toward overload. Avoid sudden increases, monitor symptoms, and prioritize sleep + smart load distribution.";
  }

  // Trend chip text (simple)
  const trend = (() => {
    const recent = list.slice(-6);
    if(recent.length < 4) return "Add more check-ins for trends";
    const first = recent.slice(0,3).reduce((s,e)=>s+e.load,0)/3;
    const last3 = recent.slice(-3).reduce((s,e)=>s+e.load,0)/3;
    const diff = last3 - first;
    if(Math.abs(diff) < 20) return "Stable trend";
    return diff > 0 ? "Load rising" : "Load decreasing";
  })();

  return {acute, chronic, acwr, severity, status, message, trend, last};
}

// UI refs (dashboard)
const statusBadge = $("statusBadge");
const statusText = $("statusText");
const mACWR = $("mACWR");
const mAcute = $("mAcute");
const mChronic = $("mChronic");
const guidance = $("guidance");
const trendChip = $("trendChip");
const recentList = $("recentList");

// Check-in refs
const dateInput = $("date");
const datePretty = $("datePretty");
const minutes = $("minutes");
const rpe = $("rpe");
const sleep = $("sleep");
const soreness = $("soreness");
const fatigue = $("fatigue");
const notes = $("notes");

const vMinutes = $("vMinutes");
const vRPE = $("vRPE");
const vSleep = $("vSleep");
const vSoreness = $("vSoreness");
const vFatigue = $("vFatigue");
const sessionLoadChip = $("sessionLoadChip");
const notesCount = $("notesCount");

$("saveBtn").addEventListener("click", onSave);
$("loadTodayBtn").addEventListener("click", ()=>{
  dateInput.value = todayISO();
  syncCheckinUI(true);
  toast("Loaded today");
});
$("quickTodayBtn").addEventListener("click", ()=>{
  switchView("checkin");
  dateInput.value = todayISO();
  syncCheckinUI(true);
});
$("goExercisesBtn").addEventListener("click", ()=> switchView("exercises"));

$("exportBtn").addEventListener("click", exportCSV);
$("clearBtn").addEventListener("click", ()=>{
  if(confirm("Clear all local data on this device?")){
    localStorage.removeItem(STORAGE_KEY);
    toast("Cleared");
    renderAll();
  }
});

// Slider live values
[minutes, rpe, sleep, soreness, fatigue].forEach(el=>{
  el.addEventListener("input", syncCheckinUI);
});
notes.addEventListener("input", ()=>{
  notesCount.textContent = String(notes.value.length);
});

// Date change loads that day if exists
dateInput.addEventListener("change", ()=> syncCheckinUI(true));

// Initial date
dateInput.value = todayISO();

// Check-in syncing
function syncCheckinUI(loadExisting=false){
  const iso = dateInput.value || todayISO();
  datePretty.textContent = prettyDate(iso);

  if(loadExisting){
    const existing = getEntry(iso);
    if(existing){
      minutes.value = existing.minutes;
      rpe.value = existing.rpe;
      sleep.value = existing.sleep;
      soreness.value = existing.soreness;
      fatigue.value = existing.fatigue;
      notes.value = existing.notes || "";
    } else {
      // keep current slider values, but clear notes
      notes.value = "";
    }
  }

  vMinutes.textContent = String(minutes.value);
  vRPE.textContent = String(rpe.value);
  vSleep.textContent = Number(sleep.value).toFixed(1);
  vSoreness.textContent = String(soreness.value);
  vFatigue.textContent = String(fatigue.value);
  notesCount.textContent = String((notes.value||"").length);

  const load = Math.round(Number(minutes.value) * Number(rpe.value));
  sessionLoadChip.textContent = `Load: ${load}`;
}

// Save
function onSave(){
  const entry = {
    date: dateInput.value || todayISO(),
    minutes: Number(minutes.value),
    rpe: Number(rpe.value),
    sleep: Number(sleep.value),
    soreness: Number(soreness.value),
    fatigue: Number(fatigue.value),
    notes: String(notes.value||""),
    load: Math.max(0, Math.round(Number(minutes.value) * Number(rpe.value)))
  };
  upsertEntry(entry);
  toast("Saved ‚úì");
  renderAll();
  switchView("dashboard");
}

// Dashboard render
function renderDashboard(){
  const entries = normalizeEntries(loadEntries());
  const rep = riskReport(entries);

  // Metrics
  mACWR.textContent = rep.chronic>0 ? rep.acwr.toFixed(2) : "‚Äî";
  mAcute.textContent = rep.acute ? Math.round(rep.acute) : "‚Äî";
  mChronic.textContent = rep.chronic ? Math.round(rep.chronic) : "‚Äî";

  // Status badge
  statusBadge.classList.remove("ok","caution","high");
  statusBadge.classList.add(rep.severity);
  statusText.textContent = rep.status;

  // Guidance
  const last = rep.last;
  const recBits = [];
  if(last){
    if(last.sleep < 6) recBits.push("Sleep < 6h noted.");
    if(last.fatigue >= 7) recBits.push("High fatigue reported.");
    if(last.soreness >= 7) recBits.push("High soreness reported.");
  }
  guidance.textContent = rep.message + (recBits.length ? " " + recBits.join(" ") : "");

  trendChip.textContent = rep.trend;

  // Recent list (7 days)
  recentList.innerHTML = "";
  const recent = entries.slice(-7).reverse();
  if(recent.length===0){
    recentList.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No entries yet</div><div class="rowSub">Start with today‚Äôs check-in.</div></div></div>`;
  } else {
    recent.forEach(e=>{
      const rec = document.createElement("div");
      rec.className="row";
      rec.innerHTML = `
        <div class="rowMain">
          <div class="rowTop">
            <div class="rowTitle">${prettyDate(e.date)}</div>
            <div class="rowMeta">${e.minutes} min ‚Ä¢ RPE ${e.rpe}</div>
          </div>
          <div class="rowSub">Sleep ${Number(e.sleep).toFixed(1)}h ‚Ä¢ Soreness ${e.soreness} ‚Ä¢ Fatigue ${e.fatigue}</div>
        </div>
        <div class="rowRight">
          <div class="chip">Load ${e.load}</div>
          <button class="iconBtn" title="Edit" data-edit="${e.date}">Edit</button>
        </div>
      `;
      rec.querySelector('[data-edit]').addEventListener("click", ()=>{
        switchView("checkin");
        dateInput.value = e.date;
        syncCheckinUI(true);
      });
      recentList.appendChild(rec);
    });
  }

  renderChart(entries);
}

// Chart
function renderChart(entries){
  const canvas = $("chart");
  const ctx = canvas.getContext("2d");
  const w = canvas.width;
  const h = canvas.height;

  // Clear
  ctx.clearRect(0,0,w,h);

  // Data: last 14 sessions
  const data = normalizeEntries(entries).slice(-14);
  const pad = 28;
  const innerW = w - pad*2;
  const innerH = h - pad*2;

  // Background grid
  ctx.globalAlpha = 1;
  ctx.fillStyle = "rgba(255,255,255,0)";
  ctx.fillRect(0,0,w,h);

  // If no data
  if(data.length===0){
    ctx.fillStyle = "rgba(255,255,255,.65)";
    ctx.font = "28px system-ui";
    ctx.fillText("No data yet", pad, h/2);
    return;
  }

  const loads = data.map(d=>d.load);
  const maxV = Math.max(20, ...loads);
  const minV = Math.min(...loads, 0);

  // grid lines
  ctx.strokeStyle = "rgba(255,255,255,.08)";
  ctx.lineWidth = 1;
  for(let i=0;i<=4;i++){
    const y = pad + (innerH * (i/4));
    ctx.beginPath();
    ctx.moveTo(pad, y);
    ctx.lineTo(pad+innerW, y);
    ctx.stroke();
  }

  function x(i){
    if(data.length===1) return pad + innerW/2;
    return pad + (innerW * (i/(data.length-1)));
  }
  function y(v){
    const t = (v - minV) / (maxV - minV || 1);
    return pad + innerH - (innerH * t);
  }

  // line
  ctx.strokeStyle = "rgba(232,226,214,.85)";
  ctx.lineWidth = 3;
  ctx.lineJoin = "round";
  ctx.lineCap = "round";
  ctx.beginPath();
  data.forEach((d,i)=>{
    const px = x(i);
    const py = y(d.load);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  });
  ctx.stroke();

  // points
  ctx.fillStyle = "rgba(188,169,142,.9)";
  data.forEach((d,i)=>{
    const px = x(i), py = y(d.load);
    ctx.beginPath();
    ctx.arc(px, py, 5, 0, Math.PI*2);
    ctx.fill();
  });

  // labels (last point)
  const last = data[data.length-1];
  ctx.fillStyle = "rgba(255,255,255,.88)";
  ctx.font = "22px system-ui";
  ctx.fillText(`Latest: ${last.load}`, pad, pad-6);

  // bottom date labels (first & last)
  ctx.fillStyle = "rgba(255,255,255,.55)";
  ctx.font = "18px system-ui";
  ctx.fillText(prettyDate(data[0].date), pad, h-10);
  const rightLabel = prettyDate(last.date);
  const m = ctx.measureText(rightLabel).width;
  ctx.fillText(rightLabel, w - pad - m, h-10);
}

// Exercises
let exerciseCategory = "all";
let showFavsOnly = false;

const exerciseList = $("exerciseList");
const search = $("search");
const favChip = $("favChip");

search.addEventListener("input", renderExercises);
document.querySelectorAll('[data-cat]').forEach(btn=>{
  btn.addEventListener("click", ()=>{
    exerciseCategory = btn.dataset.cat;
    showFavsOnly = false;
    $("toggleFavsBtn").textContent = "‚òÖ Favorites";
    renderExercises();
    toast(exerciseCategory==="all" ? "All categories" : exerciseCategory);
  });
});
$("toggleFavsBtn").addEventListener("click", ()=>{
  showFavsOnly = !showFavsOnly;
  $("toggleFavsBtn").textContent = showFavsOnly ? "‚òÖ Showing favorites" : "‚òÖ Favorites";
  renderExercises();
});

function renderExercises(){
  const q = (search.value||"").trim().toLowerCase();
  const favs = new Set(loadFavs());
  favChip.textContent = `‚òÖ ${favs.size}`;

  let list = EXERCISES.slice();
  if(exerciseCategory !== "all"){
    list = list.filter(x=> x.category === exerciseCategory);
  }
  if(q){
    list = list.filter(x=> x.name.toLowerCase().includes(q) || x.category.toLowerCase().includes(q) || x.goal.toLowerCase().includes(q));
  }
  if(showFavsOnly){
    list = list.filter(x=> favs.has(x.id));
  }

  exerciseList.innerHTML = "";
  if(list.length===0){
    exerciseList.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No matches</div><div class="rowSub">Try a different search or category.</div></div></div>`;
    return;
  }

  list.forEach(ex=>{
    const isFav = favs.has(ex.id);
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="rowMain">
        <div class="rowTop">
          <div class="rowTitle">${ex.name}</div>
          <div class="rowMeta">${ex.category}</div>
        </div>
        <div class="rowSub">${ex.goal}</div>
      </div>
      <div class="rowRight">
        <button class="iconBtn ${isFav ? "good":""}" data-fav="${ex.id}">${isFav ? "‚òÖ" : "‚òÜ"}</button>
        <button class="iconBtn" data-open="${ex.id}">View</button>
      </div>
    `;
    row.querySelector('[data-open]').addEventListener("click", ()=> openExercise(ex.id));
    row.querySelector('[data-fav]').addEventListener("click", ()=>{
      const set = new Set(loadFavs());
      if(set.has(ex.id)) set.delete(ex.id); else set.add(ex.id);
      saveFavs([...set]);
      renderExercises();
      toast(isFav ? "Removed favorite" : "Saved favorite");
    });
    exerciseList.appendChild(row);
  });
}

// Modal
const modalBackdrop = $("modalBackdrop");
const modalTitle = $("modalTitle");
const modalBody = $("modalBody");
$("closeModal").addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e)=>{ if(e.target===modalBackdrop) closeModal(); });

function openExercise(id){
  const ex = EXERCISES.find(x=> x.id===id);
  if(!ex) return;

  modalTitle.textContent = ex.name;
  const favs = new Set(loadFavs());
  const isFav = favs.has(ex.id);

  modalBody.innerHTML = `
    <div class="pill">ü©∞ ${ex.category}</div>
    <div class="bullet"><strong>Goal:</strong> ${ex.goal}</div>
    <div class="bullet"><strong>Dosage:</strong> ${ex.dosage}</div>
    <div class="divider"></div>
    <div class="bullet"><strong>Cues:</strong></div>
    ${ex.cues.map(c=>`<div class="bullet">‚Ä¢ ${c}</div>`).join("")}
    <div class="divider"></div>
    <div class="bullet"><strong>Regressions:</strong></div>
    ${ex.regressions.map(r=>`<div class="bullet">‚Ä¢ ${r}</div>`).join("")}
    <div class="divider"></div>
    <div class="bullet"><strong>Progressions:</strong></div>
    ${ex.progressions.map(p=>`<div class="bullet">‚Ä¢ ${p}</div>`).join("")}
    <div class="divider"></div>
    <div class="btnRow">
      <button class="btn ${isFav ? "" : "secondary"}" id="favToggleModal"><span class="ic">${isFav ? "‚òÖ" : "‚òÜ"}</span> ${isFav ? "Favorited" : "Add to Favorites"}</button>
      <button class="btn secondary" id="copyDosage"><span class="ic">üìã</span> Copy Dosage</button>
    </div>
  `;

  modalBody.querySelector("#favToggleModal").addEventListener("click", ()=>{
    const set = new Set(loadFavs());
    if(set.has(ex.id)) set.delete(ex.id); else set.add(ex.id);
    saveFavs([...set]);
    renderExercises();
    openExercise(ex.id); // refresh modal state
  });

  modalBody.querySelector("#copyDosage").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(`${ex.name}\nDosage: ${ex.dosage}\nGoal: ${ex.goal}`);
      toast("Copied");
    }catch{
      toast("Copy not available");
    }
  });

  modalBackdrop.classList.add("show");
}
function closeModal(){ modalBackdrop.classList.remove("show"); }

// History
const historyList = $("historyList");
const countChip = $("countChip");
const sum7 = $("sum7");
const sum28 = $("sum28");
const avgRPE7 = $("avgRPE7");

function renderHistory(){
  const entries = normalizeEntries(loadEntries());
  countChip.textContent = `${entries.length} ${entries.length===1?"entry":"entries"}`;

  // windows based on last entry date
  const rep = riskReport(entries);
  const lastDate = rep.last ? rep.last.date : todayISO();
  function windowDays(days){
    const end = new Date(lastDate+"T12:00:00");
    const start = new Date(end); start.setDate(start.getDate()-(days-1));
    return entries.filter(e=>{
      const d = new Date(e.date+"T12:00:00");
      return d>=start && d<=end;
    });
  }
  const w7 = windowDays(7);
  const w28 = windowDays(28);

  sum7.textContent = w7.length ? String(w7.reduce((s,e)=>s+e.load,0)) : "‚Äî";
  sum28.textContent = w28.length ? String(w28.reduce((s,e)=>s+e.load,0)) : "‚Äî";
  avgRPE7.textContent = w7.length ? (w7.reduce((s,e)=>s+e.rpe,0)/w7.length).toFixed(1) : "‚Äî";

  historyList.innerHTML = "";
  if(entries.length===0){
    historyList.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No entries yet</div><div class="rowSub">Add a check-in to start tracking.</div></div></div>`;
    return;
  }

  [...entries].reverse().forEach(e=>{
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="rowMain">
        <div class="rowTop">
          <div class="rowTitle">${prettyDate(e.date)}</div>
          <div class="rowMeta">${e.minutes} min ‚Ä¢ RPE ${e.rpe}</div>
        </div>
        <div class="rowSub">Load ${e.load} ‚Ä¢ Sleep ${Number(e.sleep).toFixed(1)}h ‚Ä¢ Soreness ${e.soreness} ‚Ä¢ Fatigue ${e.fatigue}</div>
        ${e.notes ? `<div class="rowSub" style="margin-top:6px; color:rgba(255,255,255,.65)">Notes: ${escapeHTML(e.notes)}</div>` : ``}
      </div>
      <div class="rowRight">
        <button class="iconBtn" data-edit="${e.date}">Edit</button>
        <button class="iconBtn danger" data-del="${e.date}">Delete</button>
      </div>
    `;
    row.querySelector('[data-edit]').addEventListener("click", ()=>{
      switchView("checkin");
      dateInput.value = e.date;
      syncCheckinUI(true);
    });
    row.querySelector('[data-del]').addEventListener("click", ()=>{
      if(confirm(`Delete entry for ${prettyDate(e.date)}?`)){
        deleteEntry(e.date);
        toast("Deleted");
        renderAll();
      }
    });
    historyList.appendChild(row);
  });
}

function escapeHTML(s){
  return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// Export CSV
function exportCSV(){
  const entries = normalizeEntries(loadEntries());
  if(entries.length===0){ toast("No data to export"); return; }
  const header = ["date","minutes","rpe","sleep","soreness","fatigue","load","notes"];
  const rows = entries.map(e=> [
    e.date, e.minutes, e.rpe, e.sleep, e.soreness, e.fatigue, e.load,
    `"${String(e.notes||"").replace(/"/g,'""')}"`
  ].join(","));
  const csv = [header.join(","), ...rows].join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "on_pointe_prevention_export.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 1500);
  toast("Exported CSV");
}

// Toast
let toastTimer=null;
function toast(text){
  const t = $("toast");
  t.textContent = text;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=> t.classList.remove("show"), 1200);
}

// Render all
function renderAll(){
  syncCheckinUI(false);
  renderDashboard();
  renderExercises();
  renderHistory();
}

// PWA: manifest + service worker in ONE file
(function setupPWA(){
  // Create a simple icon (data URI SVG)
  const iconSVG = encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
      <defs>
        <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0" stop-color="#E8E2D6"/>
          <stop offset="1" stop-color="#BCA98E"/>
        </linearGradient>
      </defs>
      <rect x="0" y="0" width="512" height="512" rx="120" fill="url(#g)"/>
      <path d="M165 320c45-120 105-155 182-175 9-2 18 4 19 13 2 12-7 21-18 24-58 16-98 40-131 113-12 26-28 38-52 38-16 0-31-7-38-13-5-4-7-11-4-17 5-11 26-11 42 17z" fill="rgba(0,0,0,.22)"/>
      <text x="256" y="290" text-anchor="middle" font-family="system-ui, -apple-system" font-weight="800" font-size="64" fill="rgba(0,0,0,.28)">OPP</text>
    </svg>
  `);
  const iconData = `data:image/svg+xml,${iconSVG}`;

  // Manifest as blob URL
  const manifest = {
    name: "On Pointe Prevention",
    short_name: "On Pointe",
    start_url: ".",
    display: "standalone",
    background_color: "#0B0B0D",
    theme_color: "#0B0B0D",
    icons: [
      { src: iconData, sizes: "512x512", type: "image/svg+xml" }
    ]
  };
  const manifestBlob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
  const manifestURL = URL.createObjectURL(manifestBlob);
  const link = document.createElement("link");
  link.rel="manifest";
  link.href=manifestURL;
  document.head.appendChild(link);

  // Apple touch icon
  const appleIcon = document.createElement("link");
  appleIcon.rel="apple-touch-icon";
  appleIcon.href=iconData;
  document.head.appendChild(appleIcon);

  // Service worker from blob (offline cache)
  if("serviceWorker" in navigator){
    const swCode = `
      const CACHE = "opp-cache-v1";
      const ASSETS = [self.location.href];
      self.addEventListener("install", (e)=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()));
      });
      self.addEventListener("activate", (e)=>{
        e.waitUntil(self.clients.claim());
      });
      self.addEventListener("fetch", (e)=>{
        const req = e.request;
        // network-first for HTML, cache-first for others
        if(req.mode === "navigate"){
          e.respondWith(fetch(req).then(res=>{
            const copy = res.clone();
            caches.open(CACHE).then(c=>c.put(self.location.href, copy));
            return res;
          }).catch(()=>caches.match(self.location.href)));
          return;
        }
        e.respondWith(caches.match(req).then(cached=> cached || fetch(req)));
      });
    `;
    const swBlob = new Blob([swCode], {type:"text/javascript"});
    const swURL = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL).catch(()=>{});
  }

  // iOS install help + (Android-style) install prompt
  let deferredPrompt = null;
  window.addEventListener("beforeinstallprompt", (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    $("installBtn").style.display = "inline-flex";
  });
  $("installBtn").addEventListener("click", async ()=>{
    if(deferredPrompt){
      deferredPrompt.prompt();
      deferredPrompt = null;
    } else {
      alert("On iPhone: open in Safari ‚Üí Share ‚Üí Add to Home Screen.");
    }
  });
})();

// First render
renderAll();
switchView("dashboard");
</script>
</body>
</html>
    
  </body>
  
</html>
