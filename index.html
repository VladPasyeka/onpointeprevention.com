<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0B0B0D" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>On Pointe Prevention</title>

  <link rel="icon" href="logo.png" />
  <link rel="apple-touch-icon" href="logo.png" />

  <style>
    :root{
      --bg:#0B0B0D;
      --text:#F4F5F7;
      --muted:#9AA0A6;
      --line:rgba(255,255,255,.10);
      --shadow: 0 16px 38px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --pad:16px;
      --pad2:20px;
      --ok:#39d98a;
      --caution:#ffb020;
      --high:#ff5c5c;
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text", Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html, body { overflow-x:hidden; overflow-y:auto; }

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 65% 15%, rgba(255, 214, 222, .45), transparent 60%),
        radial-gradient(900px 700px at 25% 5%, rgba(234, 200, 210, .35), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(190, 120, 140, .20), transparent 55%),
        linear-gradient(180deg, #2a1018 0%, #12080c 60%, #0b0b0d 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ===== Top bar ===== */
    .top{
      position: sticky;
      top: 0;
      z-index: 20;
      padding: calc(env(safe-area-inset-top) + 10px) var(--pad) 12px;
      background-color: rgba(11,11,13,.88);
      background-image: linear-gradient(to bottom, rgba(11,11,13,.94), rgba(11,11,13,.70));
      border-bottom: 1px solid var(--line);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      transform: translateZ(0);
      will-change: transform;
      isolation: isolate;
    }

    .brandRow{
      display:grid;
      grid-template-columns: 44px 1fr auto;
      align-items:center;
      column-gap:12px;
    }

    .logo{
      width:36px;
      height:36px;
      border-radius:12px;
      background: url("logo.png") center/cover no-repeat;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .brand{ min-width:0; }
    .title{
      font-weight:850;
      letter-spacing:.2px;
      font-size:16px;
      line-height:1.1;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      margin:0;
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1.2;
    }

    .topActions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-self:end;
      flex-wrap:nowrap;
    }

    .pillBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .pillBtn:active{transform:scale(.98)}
    .tinyDot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(255,255,255,.75);
      opacity:.9;
    }

    /* ===== Layout ===== */
    main{ min-height: 100vh; }
    .container{
      padding: 14px var(--pad);
      padding-bottom: calc(env(safe-area-inset-bottom) + 240px);
    }
    .grid{display:grid; gap:12px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardInner{padding: var(--pad2)}
    .cardHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .h{
      margin:0;
      font-size:14px;
      font-weight:850;
      letter-spacing:.2px;
    }
    .small{
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
      line-height:1.25;
    }

    .badge{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
      background: rgba(255,255,255,.04);
      flex:0 0 auto;
    }
    .badgeDot{width:8px;height:8px;border-radius:999px}
    .badge.ok .badgeDot{background:var(--ok)}
    .badge.caution .badgeDot{background:var(--caution)}
    .badge.high .badgeDot{background:var(--high)}

    .metrics{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .metric{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px 12px;
      min-width:0;
    }
    .metric .k{font-size:11px;color:var(--muted)}
    .metric .v{margin-top:4px;font-size:16px;font-weight:850; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .metric .s{margin-top:3px;font-size:11px;color:rgba(255,255,255,.70)}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:12px 14px;
      border-radius: 14px;
      font-size:13px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; gap:10px;
    }
    .btn.primary{ background: rgba(255,255,255,.08); }
    .btn.danger{ border-color: rgba(255,92,92,.35); background: rgba(255,92,92,.08); }
    .btn:active{transform:scale(.99)}

    .list{display:grid; gap:10px; margin-top:10px}
    .row{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .rowMain{min-width:0}
    .rowTop{
      display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;
      margin-bottom:2px;
    }
    .rowTitle{font-weight:900; font-size:13px}
    .rowMeta{font-size:12px;color:rgba(255,255,255,.70)}
    .rowSub{font-size:12px;color:var(--muted); line-height:1.3}
    .rowRight{
      display:flex; flex-direction:column; align-items:flex-end; gap:8px;
      flex:0 0 auto;
    }
    .chip{
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      font-size:11px;
      color: rgba(255,255,255,.88);
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }
    .iconBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .iconBtn:active{transform:scale(.98)}
    .mutedBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.85);
      padding:10px 12px;
      border-radius: 14px;
      font-size:12px;
      font-weight:850;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }

    canvas{
      width:100%;
      height:160px;
      display:block;
      background: rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius: 16px;
    }

    /* ===== Tabs ===== */
    .tabs{
      position:fixed;
      bottom:0; left:0; right:0;
      z-index:30;
      padding: 8px 12px calc(env(safe-area-inset-bottom) + 8px);
      background-color: rgba(11,11,13,.88);
      background-image: linear-gradient(to top, rgba(11,11,13,.94), rgba(11,11,13,.70));
      border-top:1px solid var(--line);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      transform: translateZ(0);
      will-change: transform;
      isolation: isolate;
    }
    .tabRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.88);
      border-radius: 16px;
      padding:10px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size:11px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.20);
      color: var(--text);
    }
    .tab .emoji{font-size:16px; line-height:1}

    /* ===== Modal ===== */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:50;
      padding: 12px 12px calc(env(safe-area-inset-bottom) + 120px);
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:100%;
      max-width:520px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,18,24,.96), rgba(18,18,24,.90));
      border-radius: 22px;
      box-shadow: 0 25px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalTop{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalTitle{font-weight:900; font-size:14px; margin:0}
    .modalBody{
      padding: 14px 16px;
      max-height: calc(74vh - 80px);
      overflow:auto;
    }

    .form{display:grid; gap:14px}
    .field{display:grid; gap:6px}
    .labelRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:12px;
      color: rgba(255,255,255,.90);
    }
    .val{font-variant-numeric: tabular-nums; color: rgba(255,255,255,.90); font-weight:900}
    input[type="range"]{width:100%; accent-color: rgba(255,255,255,.85)}
    input[type="date"], input[type="text"], input[type="email"], input[type="password"], textarea{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{min-height:70px; resize:vertical}
    .hint{font-size:11px;color:var(--muted); line-height:1.25}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 120px;
      z-index:60;
      background: rgba(18,18,24,.92);
      border:1px solid var(--line);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      display:none;
      box-shadow: 0 15px 40px rgba(0,0,0,.55);
      white-space:nowrap;
    }
    .toast.show{display:block}

    /* ===== Auth screen ===== */
    .authWrap{
      min-height: 100vh;
      display:grid;
      place-items:center;
      padding: calc(env(safe-area-inset-top) + 24px) 16px calc(env(safe-area-inset-bottom) + 24px);
    }
    .authCard{
      width:100%;
      max-width: 420px;
      border:1px solid var(--line);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      backdrop-filter: blur(16px);
    }
    .authHero{
      padding: 18px 18px 8px;
      display:flex;
      gap:14px;
      align-items:center;
    }
    .authLogo{
      width:56px; height:56px;
      border-radius: 18px;
      background: url("logo.png") center/cover no-repeat;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .authBrand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      font-weight:900;
      line-height:1.1;
    }
    .authBrand p{
      margin:4px 0 0;
      font-size:12px;
      color: rgba(255,255,255,.70);
      line-height:1.25;
    }
    .authBody{ padding: 12px 18px 18px; }
    .authTitle{
      margin: 10px 0 8px;
      font-weight:900;
      letter-spacing:.3px;
      text-align:center;
      font-size:18px;
    }
    .authSub{
      margin: 0 0 16px;
      text-align:center;
      color: rgba(255,255,255,.70);
      font-size:12px;
    }
    .authBtn{
      width:100%;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.92);
      color: #151518;
      padding: 14px 14px;
      border-radius: 999px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
    }
    .authBtn:active{ transform: scale(.99); }
    .authLinkRow{
      margin-top: 12px;
      display:flex;
      justify-content:center;
      gap:8px;
      font-size:12px;
      color: rgba(255,255,255,.70);
    }
    .authLink{
      color: rgba(255,255,255,.92);
      text-decoration: none;
      border-bottom: 1px solid rgba(255,255,255,.25);
      padding-bottom:2px;
      cursor:pointer;
    }
    .authMsg{
      margin-top: 10px;
      text-align:center;
      font-size:12px;
      color: rgba(255,255,255,.75);
      min-height: 16px;
    }

    /* ===== exercise pick list inside check-in ===== */
    .pickWrap{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      padding: 10px;
      display:grid;
      gap:10px;
    }
    .pickRow{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.08);
    }
    .pickMain{min-width:0}
    .pickTitle{font-weight:900; font-size:13px; margin:0}
    .pickMeta{margin:4px 0 0; font-size:12px; color:rgba(255,255,255,.70); line-height:1.2}
    .pickRight{
      display:flex; flex-direction:column; align-items:flex-end; gap:8px;
      flex:0 0 auto;
    }
    .miniInput{
      width: 92px;
      text-align:center;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-size: 12px;
      outline:none;
    }
    .miniLabel{font-size:10px; color:rgba(255,255,255,.65)}
    .toggleLine{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
      user-select:none;
    }
    .toggleLine strong{font-size:12px}
    .toggleLine span{font-size:11px; color:rgba(255,255,255,.70)}
    .hr{
      height:1px; background: rgba(255,255,255,.08);
      border:0; margin: 8px 0;
    }
  </style>
</head>

<body>
  <!-- AUTH -->
  <section id="authScreen" class="authWrap" style="display:none;">
    <div class="authCard">
      <div class="authHero">
        <div class="authLogo"></div>
        <div class="authBrand">
          <h1>On Pointe Prevention‚Ñ¢</h1>
          <p>PT-guided injury prevention, recovery, and load monitoring for dancers.</p>
        </div>
      </div>
      <div class="authBody">
        <div class="authTitle" id="authModeTitle">ONPOINTE LOGIN</div>
        <div class="authSub">Your leap, safely landed.</div>

        <div class="form" style="gap:12px;">
          <div class="field">
            <div class="labelRow"><span>Email</span></div>
            <input type="email" id="authEmail" placeholder="you@example.com" autocomplete="email" />
          </div>
          <div class="field">
            <div class="labelRow"><span>Password</span></div>
            <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>

          <button class="authBtn" id="authPrimaryBtn" type="button">Log in</button>

          <div class="authLinkRow">
            <span id="authAltText">Don‚Äôt have an account?</span>
            <a class="authLink" id="authToggle" href="javascript:void(0)">Create</a>
          </div>

          <div class="authLinkRow" style="margin-top:6px;">
            <a class="authLink" id="authReset" href="javascript:void(0)" style="border-bottom-color:rgba(255,255,255,.18); color:rgba(255,255,255,.75)">Forgot password</a>
          </div>

          <div class="authMsg" id="authMsg"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <div id="appShell" style="display:none;">
    <div class="top">
      <div class="brandRow">
        <div class="logo"></div>

        <div class="brand">
          <p class="title">On Pointe Prevention‚Ñ¢</p>
          <p class="subtitle" id="subtitleText">PT-guided load monitoring + conditioning</p>
        </div>

        <div class="topActions">
          <button class="pillBtn" id="exportBtn" type="button">
            <span class="tinyDot"></span><span>Export CSV</span>
          </button>
          <button class="pillBtn" id="logoutBtn" type="button">
            <span class="tinyDot" style="opacity:.45"></span><span>Logout</span>
          </button>
        </div>
      </div>
    </div>

    <main>
      <!-- DASHBOARD -->
      <div class="container" id="screen-dashboard">
        <div class="grid">

          <div class="card">
            <div class="cardInner">
              <div class="cardHeader">
                <div>
                  <p class="h">Injury Risk Snapshot</p>
                  <div class="small">Based on acute/chronic load + recovery markers.</div>
                </div>
                <div class="badge ok" id="riskBadge">
                  <span class="badgeDot"></span>
                  <span id="riskLabel">OK</span>
                </div>
              </div>

              <div class="metrics">
                <div class="metric">
                  <div class="k">ACWR</div>
                  <div class="v" id="m_acwr">‚Äî</div>
                  <div class="s">acute / chronic</div>
                </div>
                <div class="metric">
                  <div class="k">Acute (7d avg)</div>
                  <div class="v" id="m_acute">‚Äî</div>
                  <div class="s">session load</div>
                </div>
                <div class="metric">
                  <div class="k">Chronic (28d avg)</div>
                  <div class="v" id="m_chronic">‚Äî</div>
                  <div class="s">session load</div>
                </div>
              </div>

              <div style="margin-top:12px">
                <p class="h">Guidance</p>
                <div class="small" id="guidanceText">Add check-ins to generate guidance.</div>

                <div class="btnRow">
                  <button class="btn primary" id="openCheckin" type="button">üìù Today‚Äôs Check-In</button>
                  <button class="btn" id="openExercises" type="button">ü©∞ Exercise Library</button>
                  <button class="btn danger" id="clearData" type="button">üóëÔ∏è Clear Data</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="cardInner">
              <div class="cardHeader">
                <div>
                  <p class="h">Trends</p>
                  <div class="small">Last 14 sessions (session load).</div>
                </div>
                <div class="badge" id="trendHint">Add more check-ins for trends</div>
              </div>
              <canvas id="trendCanvas" width="800" height="240"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="cardInner">
              <p class="h">Last 7 Days</p>
              <div class="small">Quick view of recent entries.</div>
              <div class="list" id="recentList"></div>
            </div>
          </div>

        </div>
      </div>

      <!-- CHECKIN -->
      <div class="container" id="screen-checkin" style="display:none">
        <div class="card">
          <div class="cardInner">
            <p class="h">Today‚Äôs Check-In</p>
            <div class="small">Track load + recovery markers. Session load = minutes √ó RPE.</div>
            <div class="btnRow">
              <button class="btn primary" id="openCheckin2" type="button">üìù Open Check-In Form</button>
            </div>
          </div>
        </div>
      </div>

      <!-- EXERCISES -->
      <div class="container" id="screen-exercises" style="display:none">
        <div class="card">
          <div class="cardInner">
            <div class="cardHeader" style="margin-bottom:6px;">
              <div>
                <p class="h">Exercise Library</p>
                <div class="small">Select exercises to build a dancer-specific plan.</div>
              </div>
              <button class="mutedBtn" id="openAddExercise" type="button">Ôºã Add Exercise</button>
            </div>
            <div class="list" id="exerciseList"></div>
          </div>
        </div>
      </div>

      <!-- HISTORY -->
      <div class="container" id="screen-history" style="display:none">
        <div class="card">
          <div class="cardInner">
            <p class="h">History</p>
            <div class="small">All check-ins for your account.</div>
            <div class="list" id="historyList"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tabRow">
        <button class="tab active" data-tab="dashboard" type="button"><div class="emoji">üìä</div>Dashboard</button>
        <button class="tab" data-tab="checkin" type="button"><div class="emoji">üìù</div>Check-In</button>
        <button class="tab" data-tab="exercises" type="button"><div class="emoji">ü©∞</div>Exercises</button>
        <button class="tab" data-tab="history" type="button"><div class="emoji">üóìÔ∏è</div>History</button>
      </div>
    </div>

    <!-- Modal: Check-in -->
    <div class="modalBackdrop" id="checkinModal">
      <div class="modal">
        <div class="modalTop">
          <p class="modalTitle">Today‚Äôs Check-In</p>
          <button class="iconBtn" id="closeCheckin" type="button">‚óè Close</button>
        </div>
        <div class="modalBody">
          <form class="form" id="checkinForm">
            <div class="field">
              <div class="labelRow"><span>Date</span></div>
              <input type="date" id="f_date" required />
            </div>

            <div class="field">
              <div class="labelRow"><span>Dance minutes</span> <span class="val" id="v_minutes">60</span></div>
              <input type="range" id="f_minutes" min="0" max="240" value="60" />
              <div class="hint">Include class + rehearsal + performance time.</div>
            </div>

            <div class="field">
              <div class="labelRow"><span>RPE (0‚Äì10)</span> <span class="val" id="v_rpe">6</span></div>
              <input type="range" id="f_rpe" min="0" max="10" step="1" value="6" />
              <div class="hint">0 = rest, 10 = maximal effort.</div>
            </div>

            <div class="field">
              <div class="labelRow"><span>Sleep (hours)</span> <span class="val" id="v_sleep">7.0</span></div>
              <input type="range" id="f_sleep" min="0" max="10" step="0.5" value="7" />
            </div>

            <div class="field">
              <div class="labelRow"><span>Soreness (0‚Äì10)</span> <span class="val" id="v_sore">3</span></div>
              <input type="range" id="f_sore" min="0" max="10" step="1" value="3" />
            </div>

            <div class="field">
              <div class="labelRow"><span>Fatigue (0‚Äì10)</span> <span class="val" id="v_fatigue">4</span></div>
              <input type="range" id="f_fatigue" min="0" max="10" step="1" value="4" />
            </div>

            <div class="field">
              <div class="labelRow"><span>Notes (optional)</span></div>
              <textarea id="f_notes" placeholder="Pain location, jumps, pointe work, travel, stress, etc."></textarea>
            </div>

            <hr class="hr" />

            <!-- NEW: exercises done -->
            <div class="field">
              <div class="labelRow">
                <span>Exercises done today</span>
                <span class="hint" style="margin:0;">Pick from library + log sets/reps</span>
              </div>

              <div class="toggleLine" id="toggleExercisePicker">
                <div>
                  <strong>Choose exercises</strong>
                  <div><span id="pickedCount">0 selected</span></div>
                </div>
                <div class="chip" style="opacity:.9;">Add</div>
              </div>

              <div id="exercisePicker" style="display:none; margin-top:10px;">
                <div class="pickWrap" id="pickWrap"></div>
                <div class="hint" style="margin-top:8px;">
                  Tip: Keep ‚Äúminutes‚Äù = class/rehearsal time; exercises here are your conditioning/prehab work.
                </div>
              </div>
            </div>

            <div class="btnRow">
              <button class="btn primary" type="submit">üíæ Save ‚úì</button>
              <button class="btn" id="cancelCheckin" type="button">Close</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal: Exercise detail -->
    <div class="modalBackdrop" id="exerciseModal">
      <div class="modal">
        <div class="modalTop">
          <p class="modalTitle" id="exTitle">Exercise</p>
          <button class="iconBtn" id="closeExercise" type="button">‚óè Close</button>
        </div>
        <div class="modalBody" id="exBody"></div>
      </div>
    </div>

    <!-- Modal: Add Exercise -->
    <div class="modalBackdrop" id="addExerciseModal">
      <div class="modal">
        <div class="modalTop">
          <p class="modalTitle">Add Exercise</p>
          <button class="iconBtn" id="closeAddExercise" type="button">‚óè Close</button>
        </div>
        <div class="modalBody">
          <form class="form" id="addExerciseForm">
            <div class="field">
              <div class="labelRow"><span>Name</span></div>
              <input type="text" id="ae_name" placeholder="e.g., Intrinsic Foot (Short Foot)" required />
            </div>

            <div class="field">
              <div class="labelRow"><span>Focus / why</span></div>
              <input type="text" id="ae_focus" placeholder="e.g., arch control ¬∑ pointe tolerance" required />
            </div>

            <div class="field">
              <div class="labelRow"><span>Default prescription</span></div>
              <input type="text" id="ae_presc" placeholder="e.g., 3√ó10, slow tempo" required />
              <div class="hint">This becomes the default sets/reps shown in check-in.</div>
            </div>

            <div class="field">
              <div class="labelRow"><span>How to do it (optional)</span></div>
              <textarea id="ae_how" placeholder="Technique cues, setup, progressions..."></textarea>
            </div>

            <div class="field">
              <div class="labelRow"><span>Coaching cues (optional)</span></div>
              <input type="text" id="ae_cues" placeholder="Comma-separated, e.g., tripod foot, ribs down, slow tempo" />
            </div>

            <div class="btnRow">
              <button class="btn primary" type="submit">Ôºã Add</button>
              <button class="btn" id="cancelAddExercise" type="button">Close</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">Saved</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, signOut
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore,
      collection, doc, getDocs, getDoc, setDoc, deleteDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmgTapl6qs29Cdr_WlNOKTq_yttO9kqW8",
      authDomain: "on-pointe-prevention.firebaseapp.com",
      projectId: "on-pointe-prevention",
      storageBucket: "on-pointe-prevention.firebasestorage.app",
      messagingSenderId: "235349964683",
      appId: "1:235349964683:web:0b1a3b3e494bd86fc0a18e"
    };

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);

    const $ = (id) => document.getElementById(id);
    const fmt1 = (n) => (Math.round(n * 10) / 10).toFixed(1);
    const todayISO = () => new Date().toISOString().slice(0,10);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1300);
    }
    function prettyDate(iso){
      try{
        const d = new Date(iso + "T00:00:00");
        return d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" });
      }catch(e){ return iso; }
    }
    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    /***********************
     * FIRESTORE PATHS
     ***********************/
    let currentUser = null;

    const userDocRef = (uid)=> doc(db, "users", uid);
    const checkinsCol  = (uid)=> collection(db, "users", uid, "checkins");
    const checkinDoc   = (uid, dateISO)=> doc(db, "users", uid, "checkins", dateISO);

    const exercisesCol = (uid)=> collection(db, "users", uid, "exercises");
    const exerciseDoc  = (uid, exId)=> doc(db, "users", uid, "exercises", exId);

    function makeId(){
      // simple unique id (good enough for Firestore doc id)
      return "ex_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    async function ensureUserProfile(uid, email){
      const ref = userDocRef(uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, { email: email || null, createdAt: serverTimestamp() }, { merge: true });
      }
    }

    /***********************
     * DATA CACHE
     ***********************/
    let cachedCheckins = [];
    let cachedExercises = []; // merged defaults + user custom (and stored in Firestore)

    /***********************
     * DEFAULT (DANCER-SPECIFIC) EXERCISES
     * Each has a defaultRx string that we can pre-fill in check-in.
     ***********************/
    const DEFAULT_EXERCISES = [
      {
        id:"default_calf_iso_ecc",
        source:"default",
        name:"Calf Capacity (Isometric + Eccentric)",
        focus:"Achilles/pointe/jumps ¬∑ ankle load tolerance",
        defaultRx:"Isometric 3√ó30‚Äì45s + Eccentric 3√ó8‚Äì12 (3‚Äì4s down)",
        how:[
          "Isometric: single-leg calf hold mid-range, pain ‚â§3/10.",
          "Eccentric: slow lower off a step, use both legs to rise if needed.",
          "Progress: add load (backpack) ‚Üí bigger range ‚Üí pogo hops."
        ],
        cues:["Tripod foot","Control the lowering","No collapsing arch"]
      },
      {
        id:"default_foot_intrinsic",
        source:"default",
        name:"Intrinsic Foot (Short Foot / Doming)",
        focus:"Arch control ¬∑ turnout/pointe alignment",
        defaultRx:"3√ó8‚Äì12 holds (5‚Äì8s) or 3√ó10 slow reps",
        how:[
          "Gently draw the ball of foot toward heel without curling toes.",
          "Start seated ‚Üí progress to standing ‚Üí single-leg ‚Üí relev√©."
        ],
        cues:["Toes long","Weight evenly through tripod","Small controlled movement"]
      },
      {
        id:"default_tib_post",
        source:"default",
        name:"Tibialis Posterior + Inversion Control",
        focus:"Medial ankle support ¬∑ pronation control",
        defaultRx:"3√ó12‚Äì15 banded inversion (slow) or 3√ó30s isometric",
        how:[
          "Band around forefoot, pull inward slowly, control return.",
          "Keep knee stacked; don‚Äôt rotate hip to cheat."
        ],
        cues:["Move at ankle","Slow eccentric","Maintain arch"]
      },
      {
        id:"default_hip_abd",
        source:"default",
        name:"Hip Abductors (Side Plank + Clamshell)",
        focus:"Pelvic control ¬∑ single-limb stability",
        defaultRx:"Side plank 3√ó20‚Äì30s + Clamshell 3√ó12‚Äì15",
        how:[
          "Side plank knees ‚Üí feet as tolerated.",
          "Clamshell: slow reps, add band when easy."
        ],
        cues:["Ribs down","Stack pelvis","Control knee alignment"]
      },
      {
        id:"default_stepdown",
        source:"default",
        name:"Step-Down (Single-Leg Control)",
        focus:"Knee/hip alignment ¬∑ landing mechanics",
        defaultRx:"3√ó6‚Äì10 each side (3s down)",
        how:[
          "Slow lower, light heel tap, return‚Äîno bounce.",
          "Progress: higher step, add load, add reach."
        ],
        cues:["Knee over 2nd toe","Quiet pelvis","No trunk sway"]
      },
      {
        id:"default_single_leg_rdl",
        source:"default",
        name:"Single-Leg RDL (Hinge Control)",
        focus:"Hamstrings/glutes ¬∑ hip hinge for jumps & decel",
        defaultRx:"3√ó6‚Äì10 each side (slow tempo)",
        how:[
          "Hinge at hip, slight knee bend, keep pelvis square.",
          "Progress: add load, reach to targets, tempo."
        ],
        cues:["Long spine","Hips square","Feel hamstrings"]
      },
      {
        id:"default_jump_landing",
        source:"default",
        name:"Landing Mechanics (Drop Landing / Stick)",
        focus:"Impact control ¬∑ plyometric readiness",
        defaultRx:"3√ó3‚Äì6 reps (stick 2‚Äì3s), 60‚Äì90s rest",
        how:[
          "Step off low box, land quietly, hold position.",
          "Progress: higher box ‚Üí repeated hops ‚Üí directional."
        ],
        cues:["Quiet landing","Knee tracks over toes","Abs engaged"]
      },
      {
        id:"default_core_pallof",
        source:"default",
        name:"Core Anti-Rotation (Dead Bug / Pallof)",
        focus:"Lumbar load management ¬∑ spotting/turns",
        defaultRx:"Dead bug 3√ó6‚Äì10 + Pallof 3√ó10‚Äì12 each side",
        how:[
          "Dead bug: keep ribs down and pelvis neutral.",
          "Pallof: press out, don‚Äôt rotate."
        ],
        cues:["Breathe","Slow + controlled","No rib flare"]
      },
      {
        id:"default_thoracic",
        source:"default",
        name:"Thoracic Mobility (Open Books / Foam Roll)",
        focus:"Upper body lines ¬∑ port de bras ¬∑ spotting",
        defaultRx:"2‚Äì3√ó6‚Äì10 per side or 3√ó45‚Äì60s",
        how:[
          "Open books: rotate through upper back, not low back.",
          "Foam roll: gentle extensions over roller."
        ],
        cues:["Move through T-spine","Neck relaxed","Control range"]
      },
      {
        id:"default_turnout_iso",
        source:"default",
        name:"Turnout Control (Hip ER Isometric)",
        focus:"Deep hip ER ¬∑ turnout without pronation",
        defaultRx:"3√ó20‚Äì30s holds each side",
        how:[
          "Seated: press knee outward against band/towel without moving pelvis.",
          "Progress to standing turnout holds in parallel ‚Üí first."
        ],
        cues:["Pelvis neutral","No arch collapse","Feel deep hip"]
      }
    ];

    /***********************
     * CHECKINS: load + metrics
     ***********************/
    function sessionLoad(entry){
      return Math.round((Number(entry.minutes)||0) * (Number(entry.rpe)||0));
    }
    function lastNDays(entries, days){
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - (days-1));
      cutoff.setHours(0,0,0,0);
      return entries.filter(e => new Date(e.date) >= cutoff);
    }
    function avgDailyLoad(entries, days){
      const total = lastNDays(entries, days).reduce((s,e)=> s + sessionLoad(e), 0);
      return total / days;
    }
    function computeMetrics(entries){
      const acute = avgDailyLoad(entries, 7);
      const chronic = avgDailyLoad(entries, 28);
      const acwr = (chronic > 0) ? (acute / chronic) : null;
      return { acute, chronic, acwr };
    }
    function riskFromACWR(acwr){
      if(acwr === null) return { cls:"ok", label:"OK" };
      if(acwr < 0.8) return { cls:"caution", label:"LOW" };
      if(acwr <= 1.3) return { cls:"ok", label:"OK" };
      if(acwr <= 1.5) return { cls:"caution", label:"CAUTION" };
      return { cls:"high", label:"HIGH" };
    }
    function guidanceText(entries, metrics){
      if(entries.length === 0) return "Add check-ins to generate guidance.";
      const { acwr } = metrics;
      if(acwr === null){
        return "Not enough history for ACWR. Keep logging daily load for the next 1‚Äì2 weeks.";
      }
      if(acwr > 1.5){
        return "High workload spike detected. Reduce volume/intensity for 24‚Äì72h, prioritize sleep, and avoid high-impact jumps/pointe volume until recovery improves.";
      }
      if(acwr > 1.3){
        return "Moderate spike. Maintain technique work, but cap additional conditioning volume and monitor soreness/fatigue closely.";
      }
      if(acwr < 0.8){
        return "Load is low relative to recent baseline. Progress gradually to avoid a sudden jump next week.";
      }
      return "Workload appears stable. Continue progressive conditioning and monitor recovery.";
    }

    /***********************
     * FIRESTORE CRUD
     ***********************/
    async function loadAllCheckins(uid){
      const snaps = await getDocs(checkinsCol(uid));
      const arr = [];
      snaps.forEach(s => arr.push(s.data()));
      return arr.filter(e=>e && e.date).sort((a,b)=> (a.date < b.date ? 1 : -1));
    }

    async function upsertCheckin(uid, entry){
      await setDoc(checkinDoc(uid, entry.date), {
        ...entry,
        updatedAt: serverTimestamp()
      }, { merge:true });
    }

    async function deleteAllCheckins(uid){
      const snaps = await getDocs(checkinsCol(uid));
      const tasks = [];
      snaps.forEach(s => tasks.push(deleteDoc(s.ref)));
      await Promise.all(tasks);
    }

    async function loadUserExercises(uid){
      const snaps = await getDocs(exercisesCol(uid));
      const arr = [];
      snaps.forEach(s => arr.push(s.data()));
      return arr.filter(x=>x && x.id).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    }

    async function addUserExercise(uid, ex){
      await setDoc(exerciseDoc(uid, ex.id), {
        ...ex,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge:true });
    }

    /***********************
     * EXERCISE LIBRARY (merge defaults + user custom)
     ***********************/
    function mergeExerciseLibrary(userExercises){
      const map = new Map();
      DEFAULT_EXERCISES.forEach(ex => map.set(ex.id, ex));
      userExercises.forEach(ex => map.set(ex.id, ex));
      return Array.from(map.values()).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    }

    function renderExerciseList(){
      const el = $("exerciseList");
      el.innerHTML = "";

      if(!cachedExercises || cachedExercises.length === 0){
        el.innerHTML = `
          <div class="row">
            <div class="rowMain">
              <div class="rowTitle">No exercises found</div>
              <div class="rowSub">If this is unexpected, check Firestore rules and refresh.</div>
            </div>
          </div>`;
        return;
      }

      cachedExercises.forEach((ex)=>{
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="rowMain">
            <div class="rowTop">
              <div class="rowTitle">${escapeHTML(ex.name)}</div>
              <div class="rowMeta">${escapeHTML(ex.focus || "")}</div>
            </div>
            <div class="rowSub">${escapeHTML(ex.defaultRx || "Tap to view details")}</div>
          </div>
          <div class="rowRight">
            <div class="chip">${ex.source === "user" ? "Custom" : "Dancer"}</div>
            <button class="iconBtn" type="button">Open</button>
            ${
              ex.source === "user"
                ? `<button class="iconBtn danger" type="button" data-delete>üóëÔ∏è</button>`
                : ``
            }
          </div>
        `;
        row.querySelector("button").addEventListener("click", ()=> openExercise(ex));
        row.addEventListener("click", (ev)=>{
          if(ev.target.tagName.toLowerCase() !== "button") openExercise(ex);
        });
        el.appendChild(row);
      });
    }

    function openExercise(ex){
      const cues = Array.isArray(ex.cues) ? ex.cues : (typeof ex.cues === "string" ? ex.cues.split(",").map(s=>s.trim()).filter(Boolean) : []);
      const how = Array.isArray(ex.how) ? ex.how : (typeof ex.how === "string" ? ex.how.split("\n").map(s=>s.trim()).filter(Boolean) : []);

      $("exTitle").textContent = ex.name || "Exercise";
      $("exBody").innerHTML = `
        <div class="chip" style="display:inline-flex; margin-bottom:10px;">${escapeHTML(ex.focus || "")}</div>
        ${ex.defaultRx ? `<div class="rowSub" style="margin-top:4px;"><strong style="color:rgba(255,255,255,.9)">Default:</strong> ${escapeHTML(ex.defaultRx)}</div>` : ""}

        ${how.length ? `
          <div style="margin:14px 0 6px; font-weight:900;">How to do it</div>
          <div style="display:grid; gap:8px;">
            ${how.map(x=>`<div class="rowSub">‚Ä¢ ${escapeHTML(x)}</div>`).join("")}
          </div>
        ` : ""}

        ${cues.length ? `
          <div style="margin:14px 0 6px; font-weight:900;">Coaching cues</div>
          <div style="display:grid; gap:8px;">
            ${cues.map(x=>`<div class="rowSub">‚Ä¢ ${escapeHTML(x)}</div>`).join("")}
          </div>
        ` : ""}

        <div style="margin-top:16px;">
          <div class="hint">Use this exercise inside your check-in to log sets/reps.</div>
        </div>
      `;
      $("exerciseModal").classList.add("show");
    }
async function deleteExercise(ex){
  if (!confirm("Delete this exercise?")) return;

  try {
    await deleteDoc(
      doc(db, "users", auth.currentUser.uid, "exercises", ex.id)
    );

    toast("Exercise deleted");
    $("exerciseModal").classList.remove("show");
    loadExercises();

  } catch (e) {
    console.error(e);
    alert("Failed to delete exercise");
  }
}
    /***********************
     * CHECK-IN EXERCISE PICKER
     * Stored in checkin.exercises = [{exerciseId, name, sets, repsOrTime, notes}]
     ***********************/
    function parseDefaultRxToSuggestion(defaultRx){
      // lightweight heuristic
      const rx = (defaultRx || "").toLowerCase();
      let sets = 3;
      let repsOrTime = "10";
      const mSets = rx.match(/(\d+)\s*√ó/);
      if(mSets) sets = Number(mSets[1]) || sets;
      const mReps = rx.match(/√ó\s*(\d+)\s*‚Äì\s*(\d+)/) || rx.match(/√ó\s*(\d+)\s*-\s*(\d+)/);
      if(mReps) repsOrTime = `${mReps[1]}-${mReps[2]}`;
      const mReps2 = rx.match(/√ó\s*(\d+)/);
      if(!mReps && mReps2) repsOrTime = `${mReps2[1]}`;
      const mSec = rx.match(/(\d+)\s*‚Äì\s*(\d+)\s*s/) || rx.match(/(\d+)\s*-\s*(\d+)\s*s/);
      if(mSec) repsOrTime = `${mSec[1]}-${mSec[2]}s`;
      const mSec2 = rx.match(/(\d+)\s*s/);
      if(!mSec && mSec2) repsOrTime = `${mSec2[1]}s`;
      return { sets, repsOrTime };
    }

    function getCheckinPicked(){
      try{
        return JSON.parse($("checkinForm").dataset.picked || "[]");
      }catch(e){
        return [];
      }
    }
    function setCheckinPicked(arr){
      $("checkinForm").dataset.picked = JSON.stringify(arr || []);
      $("pickedCount").textContent = `${(arr||[]).length} selected`;
    }

    function renderExercisePicker(){
      const wrap = $("pickWrap");
      wrap.innerHTML = "";

      const picked = getCheckinPicked();
      const pickedMap = new Map(picked.map(x=>[x.exerciseId, x]));

      cachedExercises.forEach(ex=>{
        const existing = pickedMap.get(ex.id);
        const suggestion = parseDefaultRxToSuggestion(ex.defaultRx);
        const setsVal = existing ? (existing.sets ?? suggestion.sets) : suggestion.sets;
        const repsVal = existing ? (existing.repsOrTime ?? suggestion.repsOrTime) : suggestion.repsOrTime;

        const row = document.createElement("div");
        row.className = "pickRow";
        row.innerHTML = `
          <div class="pickMain">
            <p class="pickTitle">${escapeHTML(ex.name)}</p>
            <p class="pickMeta">${escapeHTML(ex.defaultRx || ex.focus || "")}</p>
          </div>
          <div class="pickRight">
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <div style="display:grid; gap:6px;">
                <div class="miniLabel">Sets</div>
                <input class="miniInput" inputmode="numeric" pattern="[0-9]*" data-sets="${ex.id}" value="${setsVal}">
              </div>
              <div style="display:grid; gap:6px;">
                <div class="miniLabel">Reps/Time</div>
                <input class="miniInput" data-reps="${ex.id}" value="${escapeHTML(String(repsVal))}">
              </div>
            </div>
            <button class="iconBtn" type="button" data-toggle="${ex.id}">
              ${existing ? "Remove" : "Add"}
            </button>
          </div>
        `;

        row.querySelector(`[data-toggle="${ex.id}"]`).addEventListener("click", ()=>{
          const nowPicked = getCheckinPicked();
          const idx = nowPicked.findIndex(x=>x.exerciseId === ex.id);

          const sets = Number(row.querySelector(`[data-sets="${ex.id}"]`).value || suggestion.sets);
          const repsOrTime = row.querySelector(`[data-reps="${ex.id}"]`).value || suggestion.repsOrTime;

          if(idx >= 0){
            nowPicked.splice(idx, 1);
            setCheckinPicked(nowPicked);
            renderExercisePicker();
          }else{
            nowPicked.push({
              exerciseId: ex.id,
              name: ex.name,
              sets: isNaN(sets) ? suggestion.sets : sets,
              repsOrTime: repsOrTime,
              notes: ""
            });
            setCheckinPicked(nowPicked);
            renderExercisePicker();
          }
        });

        // update values if already selected and user edits inputs
        const setsInput = row.querySelector(`[data-sets="${ex.id}"]`);
        const repsInput = row.querySelector(`[data-reps="${ex.id}"]`);
        const syncIfSelected = ()=>{
          const nowPicked = getCheckinPicked();
          const idx = nowPicked.findIndex(x=>x.exerciseId === ex.id);
          if(idx >= 0){
            const s = Number(setsInput.value || suggestion.sets);
            nowPicked[idx].sets = isNaN(s) ? suggestion.sets : s;
            nowPicked[idx].repsOrTime = repsInput.value || suggestion.repsOrTime;
            setCheckinPicked(nowPicked);
          }
        };
        setsInput.addEventListener("input", syncIfSelected);
        repsInput.addEventListener("input", syncIfSelected);

        wrap.appendChild(row);
      });

      if(cachedExercises.length === 0){
        wrap.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No exercises yet</div><div class="rowSub">Go to Exercises tab and add your first one.</div></div></div>`;
      }
    }

    /***********************
     * UI RENDER (dashboard/history)
     ***********************/
    function render(){
      const entries = cachedCheckins.slice().sort((a,b)=> (a.date < b.date ? 1 : -1));
      const metrics = computeMetrics(entries);

      $("m_acute").textContent = entries.length ? Math.round(metrics.acute) : "‚Äî";
      $("m_chronic").textContent = entries.length ? Math.round(metrics.chronic) : "‚Äî";
      $("m_acwr").textContent = (metrics.acwr === null) ? "‚Äî" : fmt1(metrics.acwr);

      const risk = riskFromACWR(metrics.acwr);
      const badge = $("riskBadge");
      badge.classList.remove("ok","caution","high");
      badge.classList.add(risk.cls);
      $("riskLabel").textContent = risk.label;

      $("guidanceText").textContent = guidanceText(entries, metrics);

      renderRecent(entries);
      renderHistory(entries);
      renderChart(entries);
    }

    function renderRecent(entries){
      const el = $("recentList");
      el.innerHTML = "";
      const recent = lastNDays(entries, 7).slice(0,7);
      if(recent.length === 0){
        el.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No entries yet</div><div class="rowSub">Complete a check-in to populate your dashboard.</div></div></div>`;
        return;
      }
      recent.forEach(e=>{
        const load = sessionLoad(e);
        const exCount = Array.isArray(e.exercises) ? e.exercises.length : 0;
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="rowMain">
            <div class="rowTop">
              <div class="rowTitle">${prettyDate(e.date)}</div>
              <div class="rowMeta">${e.minutes} min ¬∑ RPE ${e.rpe}</div>
            </div>
            <div class="rowSub">Sleep ${Number(e.sleep).toFixed(1)}h ¬∑ Soreness ${e.sore} ¬∑ Fatigue ${e.fatigue}${exCount ? ` ¬∑ Exercises ${exCount}` : ""}</div>
          </div>
          <div class="rowRight">
            <div class="chip">Load ${load}</div>
          </div>
        `;
        el.appendChild(row);
      });
    }

    function renderHistory(entries){
      const el = $("historyList");
      el.innerHTML = "";
      if(entries.length === 0){
        el.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No saved check-ins</div><div class="rowSub">Use the Check-In tab to add your first entry.</div></div></div>`;
        return;
      }

      entries.forEach(e=>{
        const load = sessionLoad(e);
        const ex = Array.isArray(e.exercises) ? e.exercises : [];
        const exLine = ex.length
          ? `Exercises: ${ex.slice(0,3).map(x=>escapeHTML(x.name)).join(", ")}${ex.length>3 ? "‚Ä¶" : ""}`
          : "Exercises: ‚Äî";

        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="rowMain">
            <div class="rowTop">
              <div class="rowTitle">${prettyDate(e.date)}</div>
              <div class="rowMeta">${e.minutes} min ¬∑ RPE ${e.rpe} ¬∑ Load ${load}</div>
            </div>
            <div class="rowSub">${exLine}</div>
            <div class="rowSub" style="margin-top:4px;">${(e.notes||"").trim() ? escapeHTML(e.notes) : "‚Äî"}</div>
          </div>
          <div class="rowRight">
            <button class="iconBtn" type="button" data-edit="${e.date}">Edit</button>
          </div>
        `;
        row.querySelector('[data-edit]').addEventListener("click", ()=>{
          openCheckinModal(e);
        });
        el.appendChild(row);
      });
    }

    function renderChart(entries){
      const canvas = $("trendCanvas");
      const ctx = canvas.getContext("2d");
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      const last14 = entries.slice().reverse().slice(-14);
      const loads = last14.map(sessionLoad);

      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;
      for(let i=1;i<4;i++){
        const y = (h/4)*i;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }

      if(loads.length === 0){
        ctx.fillStyle = "rgba(255,255,255,.55)";
        ctx.font = "14px " + getComputedStyle(document.body).fontFamily;
        ctx.fillText("No data yet", 18, 38);
        return;
      }

      const max = Math.max(100, ...loads);
      const min = 0;
      const padX = 18;
      const padY = 22;
      const plotW = w - padX*2;
      const plotH = h - padY*2;
      const x = (i)=> padX + (plotW * (loads.length===1 ? 0.5 : (i/(loads.length-1))));
      const y = (v)=> padY + plotH * (1 - ((v - min) / (max - min)));

      ctx.strokeStyle = "rgba(255,255,255,.80)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      loads.forEach((v,i)=>{
        const px=x(i), py=y(v);
        if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      });
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,.90)";
      loads.forEach((v,i)=>{
        ctx.beginPath(); ctx.arc(x(i), y(v), 3, 0, Math.PI*2); ctx.fill();
      });

      const latest = loads[loads.length-1];
      ctx.fillStyle = "rgba(255,255,255,.70)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText("Latest: " + latest, 18, 18);
    }

    /***********************
     * MODALS
     ***********************/
    function openCheckinModal(existing=null){
      $("checkinModal").classList.add("show");

      const d = existing ? existing.date : todayISO();
      $("f_date").value = d;

      $("f_minutes").value = existing ? existing.minutes : 60;
      $("f_rpe").value     = existing ? existing.rpe : 6;
      $("f_sleep").value   = existing ? existing.sleep : 7;
      $("f_sore").value    = existing ? existing.sore : 3;
      $("f_fatigue").value = existing ? existing.fatigue : 4;
      $("f_notes").value   = existing ? (existing.notes||"") : "";

      // exercise picks
      setCheckinPicked(Array.isArray(existing?.exercises) ? existing.exercises : []);

      // keep picker collapsed by default
      $("exercisePicker").style.display = "none";

      syncVals();
      renderExercisePicker();
    }

    function closeCheckinModal(){ $("checkinModal").classList.remove("show"); }

    function syncVals(){
      $("v_minutes").textContent = $("f_minutes").value;
      $("v_rpe").textContent = $("f_rpe").value;
      $("v_sleep").textContent = Number($("f_sleep").value).toFixed(1);
      $("v_sore").textContent = $("f_sore").value;
      $("v_fatigue").textContent = $("f_fatigue").value;
    }

    function openAddExerciseModal(){
      $("addExerciseModal").classList.add("show");
      $("ae_name").value = "";
      $("ae_focus").value = "";
      $("ae_presc").value = "";
      $("ae_how").value = "";
      $("ae_cues").value = "";
    }
    function closeAddExerciseModal(){ $("addExerciseModal").classList.remove("show"); }

    /***********************
     * TABS
     ***********************/
    function setTab(tab){
      const screens = ["dashboard","checkin","exercises","history"];
      screens.forEach(s=> $("screen-"+s).style.display = (s===tab) ? "" : "none");
      document.querySelectorAll(".tab").forEach(b=> b.classList.toggle("active", b.dataset.tab === tab));
      // keep lists fresh
      if(tab === "exercises") renderExerciseList();
      render();
    }

    /***********************
     * CSV
     ***********************/
    function exportCSV(){
      const entries = cachedCheckins.slice().sort((a,b)=> (a.date < b.date ? 1 : -1));
      const header = ["date","minutes","rpe","session_load","sleep_hours","soreness","fatigue","notes","exercises"];
      const rows = entries.map(e=>{
        const ex = Array.isArray(e.exercises) ? e.exercises : [];
        const exText = ex.map(x=> `${x.name} (${x.sets}x${x.repsOrTime})`).join("; ");
        const row = [
          e.date,
          e.minutes,
          e.rpe,
          sessionLoad(e),
          Number(e.sleep).toFixed(1),
          e.sore,
          e.fatigue,
          (e.notes||"").replace(/\n/g," ").replace(/"/g,'""'),
          exText.replace(/"/g,'""')
        ];
        return row.map(x=> `"${x}"`).join(",");
      });
      const csv = header.join(",") + "\n" + rows.join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "on-pointe-prevention_checkins.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exported CSV");
    }

    /***********************
     * PWA (Android + iOS)
     ***********************/
    function setupPWA(){
      const manifest = {
        name: "On Pointe Prevention",
        short_name: "On Pointe",
        start_url: "./",
        display: "standalone",
        background_color: "#0B0B0D",
        theme_color: "#0B0B0D",
        icons: [
          { src: "logo.png", sizes: "192x192", type: "image/png" },
          { src: "logo.png", sizes: "512x512", type: "image/png" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement("link");
      link.rel = "manifest";
      link.href = url;
      document.head.appendChild(link);

      if("serviceWorker" in navigator){
        const sw = `
          const CACHE="opp-cache-v3";
          const ASSETS=["./","./index.html","./logo.png"];
          self.addEventListener("install", e=>{
            e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).catch(()=>{}));
            self.skipWaiting();
          });
          self.addEventListener("activate", e=>e.waitUntil(self.clients.claim()));
          self.addEventListener("fetch", e=>{
            e.respondWith(
              caches.match(e.request).then(r=> r || fetch(e.request).then(res=>{
                const copy=res.clone();
                caches.open(CACHE).then(c=>c.put(e.request, copy)).catch(()=>{});
                return res;
              }).catch(()=>r))
            );
          });
        `;
        const swURL = URL.createObjectURL(new Blob([sw], {type:"text/javascript"}));
        navigator.serviceWorker.register(swURL).catch(()=>{});
      }
    }

    /***********************
     * AUTH UI
     ***********************/
    let authMode = "login";
    function setAuthMode(mode){
      authMode = mode;
      $("authModeTitle").textContent = mode === "login" ? "ONPOINTE LOGIN" : "CREATE ACCOUNT";
      $("authPrimaryBtn").textContent = mode === "login" ? "Log in" : "Create";
      $("authAltText").textContent = mode === "login" ? "Don‚Äôt have an account?" : "Already have an account?";
      $("authToggle").textContent = mode === "login" ? "Create" : "Log in";
      $("authMsg").textContent = "";
      $("authPassword").setAttribute("autocomplete", mode === "login" ? "current-password" : "new-password");
    }
    function setAuthMessage(msg){ $("authMsg").textContent = msg || ""; }

    async function doAuthPrimary(){
      const email = ($("authEmail").value || "").trim();
      const pass = $("authPassword").value || "";
      if(!email || !pass){ setAuthMessage("Enter email + password."); return; }
      try{
        if(authMode === "login") await signInWithEmailAndPassword(auth, email, pass);
        else await createUserWithEmailAndPassword(auth, email, pass);
      }catch(err){
        const code = err?.code || "";
        let m = err?.message || "Auth error";
        if(code.includes("invalid-credential")) m = "Incorrect email or password.";
        if(code.includes("email-already-in-use")) m = "That email is already in use. Try logging in.";
        if(code.includes("weak-password")) m = "Password should be at least 6 characters.";
        if(code.includes("invalid-email")) m = "Invalid email format.";
        setAuthMessage(m);
      }
    }

    async function doResetPassword(){
      const email = ($("authEmail").value || "").trim();
      if(!email){ setAuthMessage("Enter your email first."); return; }
      try{
        await sendPasswordResetEmail(auth, email);
        setAuthMessage("Password reset email sent.");
      }catch(err){
        setAuthMessage(err?.message || "Could not send reset email.");
      }
    }

    function showAuth(){ $("authScreen").style.display=""; $("appShell").style.display="none"; setAuthMode("login"); }
    function showApp(){ $("authScreen").style.display="none"; $("appShell").style.display=""; }

    /***********************
     * BOOT PER USER
     ***********************/
    async function onUserSignedIn(user){
      currentUser = user;
      await ensureUserProfile(user.uid, user.email);

      // load user checkins
      cachedCheckins = await loadAllCheckins(user.uid);

      // load custom exercises + merge with defaults
      const userExercises = await loadUserExercises(user.uid);
      cachedExercises = mergeExerciseLibrary(userExercises);

      renderExerciseList();
      render();
      setTab("dashboard");
    }

    /***********************
     * EVENTS / WIRES
     ***********************/
    function wireUI(){
      // auth
      $("authPrimaryBtn").addEventListener("click", doAuthPrimary);
      $("authToggle").addEventListener("click", ()=> setAuthMode(authMode === "login" ? "create" : "login"));
      $("authReset").addEventListener("click", doResetPassword);

      // tabs
      document.querySelectorAll(".tab").forEach(btn=>{
        btn.addEventListener("click", ()=> setTab(btn.dataset.tab));
      });

      // buttons
      $("openCheckin").addEventListener("click", ()=> openCheckinModal());
      $("openCheckin2").addEventListener("click", ()=> openCheckinModal());
      $("openExercises").addEventListener("click", ()=> setTab("exercises"));

      $("exportBtn").addEventListener("click", exportCSV);

      $("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

      $("clearData").addEventListener("click", async ()=>{
        if(!currentUser) return;
        if(confirm("Clear all check-ins for this account?")){
          await deleteAllCheckins(currentUser.uid);
          cachedCheckins = [];
          toast("Cleared");
          render();
        }
      });

      // check-in modal close
      $("closeCheckin").addEventListener("click", closeCheckinModal);
      $("cancelCheckin").addEventListener("click", closeCheckinModal);
      $("checkinModal").addEventListener("click", (e)=>{ if(e.target === $("checkinModal")) closeCheckinModal(); });

      // exercise modal close
      $("closeExercise").addEventListener("click", ()=> $("exerciseModal").classList.remove("show"));
      $("exerciseModal").addEventListener("click", (e)=>{ if(e.target === $("exerciseModal")) $("exerciseModal").classList.remove("show"); });

      // add-exercise modal
      $("openAddExercise").addEventListener("click", openAddExerciseModal);
      $("closeAddExercise").addEventListener("click", closeAddExerciseModal);
      $("cancelAddExercise").addEventListener("click", closeAddExerciseModal);
      $("addExerciseModal").addEventListener("click", (e)=>{ if(e.target === $("addExerciseModal")) closeAddExerciseModal(); });

      // check-in picker toggle
      $("toggleExercisePicker").addEventListener("click", ()=>{
        const panel = $("exercisePicker");
        const open = panel.style.display !== "none";
        panel.style.display = open ? "none" : "";
        if(!open) renderExercisePicker();
      });

      // sliders
      ["f_minutes","f_rpe","f_sleep","f_sore","f_fatigue"].forEach(id=>{
        $(id).addEventListener("input", syncVals);
      });

      // save check-in
      $("checkinForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        if(!currentUser){ toast("Not logged in"); return; }

        const entry = {
          date: $("f_date").value,
          minutes: Number($("f_minutes").value),
          rpe: Number($("f_rpe").value),
          sleep: Number($("f_sleep").value),
          sore: Number($("f_sore").value),
          fatigue: Number($("f_fatigue").value),
          notes: $("f_notes").value || "",
          exercises: getCheckinPicked()  // <-- NEW
        };

        try{
          await upsertCheckin(currentUser.uid, entry);

          // upsert cache
          const idx = cachedCheckins.findIndex(x=> x.date === entry.date);
          if(idx >= 0) cachedCheckins[idx] = entry;
          else cachedCheckins.push(entry);

          toast("Saved ‚úì");
          closeCheckinModal();
          render();
        }catch(err){
          console.error(err);
          toast("Save failed");
        }
      });

      // add custom exercise
      $("addExerciseForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        if(!currentUser){ toast("Not logged in"); return; }

        const name = ($("ae_name").value || "").trim();
        const focus = ($("ae_focus").value || "").trim();
        const defaultRx = ($("ae_presc").value || "").trim();
        const howText = ($("ae_how").value || "").trim();
        const cuesText = ($("ae_cues").value || "").trim();

        if(!name || !focus || !defaultRx){
          toast("Fill name + focus + default");
          return;
        }

        const ex = {
          id: makeId(),
          source: "user",
          name,
          focus,
          defaultRx,
          how: howText ? howText.split("\n").map(s=>s.trim()).filter(Boolean) : [],
          cues: cuesText ? cuesText.split(",").map(s=>s.trim()).filter(Boolean) : []
        };

        try{
          await addUserExercise(currentUser.uid, ex);
          cachedExercises = mergeExerciseLibrary([ ...cachedExercises.filter(x=>x.source==="user"), ex ]);
          // note: mergeExerciseLibrary expects ONLY user exercises, but we pass only user ones
          // to keep it clean:
          const userOnly = cachedExercises.filter(x=>x.source==="user");
          cachedExercises = mergeExerciseLibrary(userOnly);

          renderExerciseList();
          toast("Exercise added");
          closeAddExerciseModal();
        }catch(err){
          console.error(err);
          toast("Add failed");
        }
      });
    }

    /***********************
     * INIT
     ***********************/
    (function init(){
      setupPWA();
      wireUI();
      setAuthMode("login");

      onAuthStateChanged(auth, async (user)=>{
        if(user){
          showApp();
          await onUserSignedIn(user);
        }else{
          currentUser = null;
          cachedCheckins = [];
          cachedExercises = [];
          showAuth();
        }
      });
    })();

    /***********************
     * FIRESTORE RULES UPDATE (IMPORTANT)
     *
     * Add exercises subcollection permissions:
     * -------------------------------------------------
     * rules_version = '2';
     * service cloud.firestore {
     *   match /databases/{database}/documents {
     *     match /users/{userId} {
     *       allow read, write: if request.auth != null && request.auth.uid == userId;
     *       match /checkins/{docId} {
     *         allow read, write: if request.auth != null && request.auth.uid == userId;
     *       }
     *       match /exercises/{exId} {
     *         allow read, write: if request.auth != null && request.auth.uid == userId;
     *       }
     *     }
     *   }
     * }
     * -------------------------------------------------
     *
     ***********************/
  </script>
</body>
</html>
