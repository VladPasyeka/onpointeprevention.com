<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0B0B0D" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>On Pointe Prevention</title>

  <link rel="icon" href="logo.png" />
  <link rel="apple-touch-icon" href="logo.png" />

  <style>
    :root{
      --bg:#0B0B0D;
      --text:#F4F5F7;
      --muted:#9AA0A6;
      --line:rgba(255,255,255,.10);
      --shadow: 0 16px 38px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --pad:16px;
      --pad2:20px;
      --ok:#39d98a;
      --caution:#ffb020;
      --high:#ff5c5c;
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text", Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html, body { overflow-x:hidden; overflow-y:auto; }

    html, body{
      background-color:#0B0B0D;
    }

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 65% 15%, rgba(255, 214, 222, .45), transparent 60%),
        radial-gradient(900px 700px at 25% 5%, rgba(234, 200, 210, .35), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(190, 120, 140, .20), transparent 55%),
        linear-gradient(180deg, #2a1018 0%, #12080c 60%, #0b0b0d 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    
    /* Use dynamic viewport height where supported (iOS/Android browser chrome) */
    @supports (min-height: 100dvh){
      body{ min-height: 100dvh; }
      main{ min-height: 100dvh; }
      .authWrap{ min-height: 100dvh; }
    }

        /* Use dynamic viewport height where supported (iOS/Android browser chrome) */
    @supports (min-height: 100dvh){
      body{ min-height: 100dvh; }
      main{ min-height: 100dvh; }
      .authWrap{ min-height: 100dvh; }
    }

    /* ===== Top bar ===== */
    .top{
      position: sticky;
      top: 0;
      z-index: 20;
      padding: calc(env(safe-area-inset-top) + 10px) var(--pad) 12px;
      background-color: rgba(11,11,13,.88);
      background-image: linear-gradient(to bottom, rgba(11,11,13,.94), rgba(11,11,13,.70));
      border-bottom: 1px solid var(--line);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      transform: translateZ(0);
      will-change: transform;
      isolation: isolate;
    }

    .brandRow{
      display:grid;
      grid-template-columns: 44px 1fr auto;
      align-items:center;
      column-gap:12px;
    }

    .logo{
      width:36px;
      height:36px;
      border-radius:12px;
      background: url("logo.png") center/cover no-repeat;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .brand{ min-width:0; }
    .title{
      font-weight:850;
      letter-spacing:.2px;
      font-size:16px;
      line-height:1.1;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      margin:0;
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1.2;
    }

    .topActions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-self:end;
      flex-wrap:nowrap;
    }

    .pillBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .pillBtn:active{transform:scale(.98)}
    .tinyDot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(255,255,255,.75);
      opacity:.9;
    }

    /* ===== Layout ===== */
    main{ min-height: 100vh; }
    .container{
      padding: 14px var(--pad);
      padding-bottom: calc(env(safe-area-inset-bottom) + 320px);
    }
    .grid{display:grid; gap:12px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardInner{padding: var(--pad2)}
    .cardHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
        .cardTitle{
      font-weight:850;
      font-size:15px;
      letter-spacing:.2px;
    }
    .cardSub{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      line-height:1.3;
    }
    .h{
      margin:0;
      font-size:14px;
      font-weight:850;
      letter-spacing:.2px;
    }
    .small{
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
      line-height:1.25;
    }

    .badge{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
      background: rgba(255,255,255,.04);
      flex:0 0 auto;
    }
    .badgeDot{width:8px;height:8px;border-radius:999px}
    .badge.ok .badgeDot{background:var(--ok)}
    .badge.caution .badgeDot{background:var(--caution)}
    .badge.high .badgeDot{background:var(--high)}

    /* small help button next to badge */
    .badgeHelpBtn{
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      line-height:1;
      min-width:34px;
      text-align:center;
    }

    .metrics{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .metric{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px 12px;
      min-width:0;
    }
    .metric .k{font-size:11px;color:var(--muted)}
    .metric .v{margin-top:4px;font-size:16px;font-weight:850; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .metric .s{margin-top:3px;font-size:11px;color:rgba(255,255,255,.70)}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:12px 14px;
      border-radius: 14px;
      font-size:13px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; gap:10px;
    }
    .btn.primary{ background: rgba(255,255,255,.08); }
    .btn.danger{ border-color: rgba(255,92,92,.35); background: rgba(255,92,92,.08); }
    .btn:active{transform:scale(.99)}

    /* Bigger ‚Äúmain action‚Äù button on Dashboard */
    .btn.bigPrimary{
      width:100%;
      justify-content:center;
      padding:16px 16px;
      border-radius: 18px;
      font-size:15px;
      font-weight:900;
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.20);
    }

    .list{display:grid; gap:10px; margin-top:10px}
    .row{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .rowMain{min-width:0}
    .rowTop{
      display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;
      margin-bottom:2px;
    }
    .rowTitle{font-weight:900; font-size:13px}
    .rowMeta{font-size:12px;color:rgba(255,255,255,.70)}
    .rowSub{font-size:12px;color:var(--muted); line-height:1.3}
    .rowRight{
      display:flex; flex-direction:column; align-items:flex-end; gap:8px;
      flex:0 0 auto;
    }
    .chip{
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      font-size:11px;
      color: rgba(255,255,255,.88);
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }
    .iconBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .iconBtn:active{transform:scale(.98)}
    .mutedBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.85);
      padding:10px 12px;
      border-radius: 14px;
      font-size:12px;
      font-weight:850;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    
    /* ===== Messaging ===== */
    .chatRoster{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .chatThread{
      margin-top:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      max-height:320px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .chatEmpty{
      color:var(--muted);
      font-size:12px;
      text-align:center;
      padding:18px 8px;
    }
    .chatMessage{
      max-width:80%;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .chatMessage.me{
      align-self:flex-end;
      text-align:right;
    }
    .chatBubble{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      white-space:pre-wrap;
    }
    .chatMessage.me .chatBubble{
      background: rgba(255,255,255,.18);
    }
    .chatMeta{
      font-size:11px;
      color:rgba(255,255,255,.65);
    }
    .chatStatus{
      color:rgba(255,255,255,.78);
      font-weight:600;
    }
    .chatComposer{
      display:flex;
      gap:10px;
      align-items:flex-end;
      margin-top:12px;
    }
    .chatInput{
      flex:1;
      min-height:44px;
      max-height:160px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-size:13px;
      resize:vertical;
      outline:none;
    }
    
/* ===== Inline Finish Setup (auth flow) ===== */
.roleInline{
  margin-top: 14px;
  padding: 14px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
}

.roleInline h2{
  font-size: 14px;
  font-weight: 800;
  margin: 0 0 4px 0;
}

.roleInline p{
  font-size: 11px;
  margin: 0 0 10px 0;
  color: var(--muted);
}

/* role buttons */
.roleInline .roleBtns{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 10px;
}

.roleInline button{
  padding: 10px 12px;
  font-size: 12px;
  border-radius: 12px;
}

/* PT code block */
.roleInline .ptCode{
  margin-top: 10px;
}

.roleInline input{
  font-size: 13px;
  padding: 10px 12px;
}

    canvas{
      width:100%;
      height:160px;
      display:block;
      background: rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius: 16px;
    }

    /* ===== Tabs ===== */
    .tabs{
      position:fixed;
      bottom:0; left:0; right:0;
      z-index:30;
      padding: 8px 12px calc(env(safe-area-inset-bottom) + 8px);
      background-color: rgba(11,11,13,.88);
      background-image: linear-gradient(to top, rgba(11,11,13,.94), rgba(11,11,13,.70));
      border-top:1px solid var(--line);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      transform: translateZ(0);
      will-change: transform;
      isolation: isolate;
    }
    .tabRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.88);
      border-radius: 16px;
      padding:10px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size:11px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.20);
      color: var(--text);
    }
    .tab .emoji{font-size:16px; line-height:1}

    /* ===== Modal ===== */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:50;
      padding: 12px 12px calc(env(safe-area-inset-bottom) + 120px);
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:100%;
      max-width:520px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,18,24,.96), rgba(18,18,24,.90));
      border-radius: 22px;
      box-shadow: 0 25px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalTop{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalTitle{font-weight:900; font-size:14px; margin:0}
    .modalBody{
      padding: 14px 16px;
      max-height: calc(74vh - 80px);
      overflow:auto;
    }

    .form{display:grid; gap:14px}
    .field{display:grid; gap:6px}
    .labelRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:12px;
      color: rgba(255,255,255,.90);
    }
    .val{font-variant-numeric: tabular-nums; color: rgba(255,255,255,.90); font-weight:900}
    input[type="range"]{
      width:100%;
      height:28px;
      appearance:none;
      background: transparent;
      cursor:pointer;
    }
    input[type="range"]:focus{outline:none}
    input[type="range"]::-webkit-slider-runnable-track{
      height:8px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255,255,255,.45), rgba(255,255,255,.18));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 1px 2px rgba(0,0,0,.35);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:22px;
      height:22px;
      border-radius:50%;
      margin-top:-7px;
      background: radial-gradient(circle at 30% 30%, #ffe3ea 0%, #f6b7c8 45%, #e792a9 100%);
      border:1px solid rgba(255,255,255,.65);
      box-shadow: 0 6px 16px rgba(0,0,0,.45), 0 0 0 4px rgba(246,183,200,.18);
    }
    input[type="range"]::-webkit-slider-thumb:active{
      box-shadow: 0 6px 18px rgba(0,0,0,.55), 0 0 0 6px rgba(246,183,200,.28);
    }
    input[type="range"]::-moz-range-track{
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 1px 2px rgba(0,0,0,.35);
    }
    input[type="range"]::-moz-range-progress{
      height:8px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255,255,255,.55), rgba(246,183,200,.55));
    }
    input[type="range"]::-moz-range-thumb{
      width:22px;
      height:22px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #ffe3ea 0%, #f6b7c8 45%, #e792a9 100%);
      border:1px solid rgba(255,255,255,.65);
      box-shadow: 0 6px 16px rgba(0,0,0,.45), 0 0 0 4px rgba(246,183,200,.18);
    }
    input[type="date"], input[type="text"], input[type="email"], input[type="password"], textarea{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{min-height:70px; resize:vertical}
    .hint{font-size:11px;color:var(--muted); line-height:1.25}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 120px;
      z-index:60;
      background: rgba(18,18,24,.92);
      border:1px solid var(--line);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      display:none;
      box-shadow: 0 15px 40px rgba(0,0,0,.55);
      white-space:nowrap;
    }
    .toast.show{display:block}

    /* ===== Auth screen ===== */
    .authWrap{
      min-height: 100vh;
      display:grid;
      place-items:center;
      padding: calc(env(safe-area-inset-top) + 24px) 16px calc(env(safe-area-inset-bottom) + 24px);
    }
    .authCard{
      width:100%;
      max-width: 420px;
      border:1px solid var(--line);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      backdrop-filter: blur(16px);
    }
    .authHero{
      padding: 18px 18px 8px;
      display:flex;
      gap:14px;
      align-items:center;
    }
    .authLogo{
      width:56px; height:56px;
      border-radius: 18px;
      background: url("logo.png") center/cover no-repeat;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .authBrand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      font-weight:900;
      line-height:1.1;
    }
    .authBrand p{
      margin:4px 0 0;
      font-size:12px;
      color: rgba(255,255,255,.70);
      line-height:1.25;
    }
    .authBody{ padding: 12px 18px 18px; }
    .authTitle{
      margin: 10px 0 8px;
      font-weight:900;
      letter-spacing:.3px;
      text-align:center;
      font-size:18px;
    }
    .authSub{
      margin: 0 0 16px;
      text-align:center;
      color: rgba(255,255,255,.70);
      font-size:12px;
    }
    .authBtn{
      margin-top: 20px; 
      width:100%;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.92);
      color: #151518;
      padding: 14px 14px;
      border-radius: 999px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
    }
    .authBtn:active{ transform: scale(.99); }
    .authLinkRow{
      margin-top: 12px;
      display:flex;
      justify-content:center;
      gap:8px;
      font-size:12px;
      color: rgba(255,255,255,.70);
    }
    .authLink{
      color: rgba(255,255,255,.92);
      text-decoration: none;
      border-bottom: 1px solid rgba(255,255,255,.25);
      padding-bottom:2px;
      cursor:pointer;
    }
    .authMsg{
      margin-top: 10px;
      text-align:center;
      font-size:12px;
      color: rgba(255,255,255,.75);
      min-height: 16px;
    }

    /* ===== exercise pick list inside check-in ===== */
    .pickWrap{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      padding: 10px;
      display:grid;
      gap:10px;
    }
    .pickRow{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.08);
    }
    .pickMain{min-width:0}
    .pickTitle{font-weight:900; font-size:13px; margin:0}
    .pickMeta{margin:4px 0 0; font-size:12px; color:rgba(255,255,255,.70); line-height:1.2}
    .pickRight{
      display:flex; flex-direction:column; align-items:flex-end; gap:8px;
      flex:0 0 auto;
    }
    .miniInput{
      width: 92px;
      text-align:center;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-size: 12px;
      outline:none;
    }
    .miniLabel{font-size:10px; color:rgba(255,255,255,.65)}
    .toggleLine{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
      user-select:none;
    }
    .toggleLine strong{font-size:12px}
    .toggleLine span{font-size:11px; color:rgba(255,255,255,.70)}
        .toggleLine input[type="checkbox"]{
      appearance:none;
      width:42px;
      height:22px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.18);
      position:relative;
      outline:none;
      cursor:pointer;
      transition: background .2s ease, border-color .2s ease;
    }
    .toggleLine input[type="checkbox"]::after{
      content:"";
      position:absolute;
      top:2px;
      left:2px;
      width:16px;
      height:16px;
      border-radius:50%;
      background: rgba(255,255,255,.85);
      box-shadow: 0 4px 10px rgba(0,0,0,.35);
      transition: transform .2s ease, background .2s ease;
    }
    .toggleLine input[type="checkbox"]:checked{
      background: rgba(57,217,138,.25);
      border-color: rgba(57,217,138,.6);
    }
    .toggleLine input[type="checkbox"]:checked::after{
      transform: translateX(20px);
      background: var(--ok);
    }
    .jumpSelect{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 12px;
      outline: none;
    }
    .hr{
      height:1px; background: rgba(255,255,255,.08);
      border:0; margin: 8px 0;
    }
    /* ---------- PT UI polish (scoped) ---------- */

/* Make header rows consistent */
#screen-dancers .cardTop,
#linkCard .cardTop{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:14px;
  margin-bottom:12px;
}

/* Title/subtitle spacing + typography */
#screen-dancers .cardTitle,
#linkCard .cardTitle{
  font-weight:900;
  font-size:18px;
  letter-spacing:.2px;
  line-height:1.15;
}

#screen-dancers .cardSub,
#linkCard .cardSub{
  margin-top:6px;
  line-height:1.35;
  color: rgba(255,255,255,.72);
}

/* Give these cards slightly better padding so they don‚Äôt feel ‚Äúflat‚Äù */
#screen-dancers .card,
#linkCard{
  padding:18px;
}

/* PT code should look like a code pill, not random bold text */
#myPtCode{
  display:inline-flex;
  align-items:center;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  letter-spacing:.14em;
  font-weight:900;
  font-size:16px;
  margin-top:8px;
}

/* Keep the ‚ÄúNew code‚Äù button aligned + not squished */
#linkCard .mutedBtn{
  white-space:nowrap;
}

/* Make empty-state text not hug the edges */
#ptDancersMsg, #ptDancerSub{
  margin-top:8px;
  color: rgba(255,255,255,.65);
}
/* ===== PT Availability Calendar ===== */
.calTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.calMonth{
  font-weight:900;
  letter-spacing:.2px;
}
.calWeekdays{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
  color:rgba(255,255,255,.65);
  font-size:12px;
  margin-bottom:8px;
  text-align:center;
}
.calGrid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}
.calCell{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  border-radius:12px;
  padding:8px;
  color: var(--text);
  text-align:left;
  cursor:pointer;
  min-height:48px;
  position:relative;
}
.calCell:hover{ background: rgba(255,255,255,.06); }
.calBlank{
  background: transparent;
  border: 1px dashed rgba(255,255,255,.08);
  cursor:default;
}
.calNum{ font-weight:900; font-size:13px; }
.calCount{
  position:absolute;
  right:6px;
  bottom:6px;
  font-size:10px;
  padding:2px 6px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.08);
  min-width:18px;
  text-align:center;
}
.calSelected{
  outline: 2px solid rgba(255,255,255,.25);
  background: rgba(255,255,255,.10);
}
@media (max-width: 420px){
  .calWeekdays{ gap:6px; font-size:11px; }
  .calGrid{ gap:6px; }
  .calCell{ min-height:44px; padding:6px; border-radius:10px; }
  .calNum{ font-size:12px; }
  .calCount{ font-size:9px; right:4px; bottom:4px; }
}   
/* ===== Universal Modal Overlay (fix off-screen & close issues) ===== */
.overlayModal{
  position: fixed !important;
  inset: 0 !important;
  z-index: 99999 !important;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  background: rgba(0,0,0,.55);
}

.overlayModal.show{ display:flex; }

.modalCard{
  width: min(640px, 100%);
  max-height: 90vh;
  overflow: auto;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(25,20,25,.92);
  box-shadow: 0 30px 80px rgba(0,0,0,.55);
  padding: 14px;
}

.modalHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  position: sticky;
  top: 0;
  background: rgba(25,20,25,.92);
  padding-bottom: 10px;
  margin-bottom: 10px;
  z-index: 2;
}
    /* Weekday row for PT calendar */
.calWeekdays{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
  margin-top:10px;
  font-size:12px;
  color:rgba(255,255,255,.65);
}

/* Keep disabled date readable (we disable it on purpose to avoid iOS native calendar overlay) */
#ptAvailDate:disabled{
  opacity:1;
  -webkit-text-fill-color: rgba(255,255,255,.92);
  color: rgba(255,255,255,.92);
  cursor:not-allowed;
}
/* =========================================================
   MOBILE / iOS / ANDROID RESPONSIVE PATCH
   Paste at very end of <style> (overrides earlier rules)
   ========================================================= */

/* Better touch behavior on mobile */
*{
  -webkit-tap-highlight-color: transparent;
}
button, .pillBtn, .iconBtn, .calDay, a{
  touch-action: manipulation;
}

/* Center content on larger screens without breaking mobile */
main .container{
  max-width: 860px;
  margin: 0 auto;
}

/* Fix overly-large bottom padding on small screens (your current +240px is huge) */
@media (max-width: 520px){
  .container{
    padding-left: 12px;
    padding-right: 12px;
    padding-bottom: calc(env(safe-area-inset-bottom) + 120px) !important;
  }
  :root{
    --pad: 12px;
    --pad2: 14px;
    --radius: 14px;
    --radius2: 18px;
  }

  /* Cards feel better on iPhone */
  .cardInner{
    padding: 14px !important;
  }

  /* Top bar spacing */
  .top{
    padding-left: 12px;
    padding-right: 12px;
  }

  /* Make text slightly tighter */
  .h{ font-size: 13px; }
  .small{ font-size: 12px; line-height: 1.35; }
}

/* iOS: prevent input auto-zoom + improve ‚Äúnative‚Äù feel */
input, select, textarea, button{
  font-size: 16px; /* prevents iOS Safari zoom */
}
input, select, textarea{
  -webkit-appearance: none;
  appearance: none;
}

/* Make all tap targets at least 44px high (Apple guideline) */
.pillBtn, .iconBtn, .badgeHelpBtn{
  min-height: 44px;
}

/* Modal improvements on mobile (scroll + safe area + no offscreen) */
.overlayModal{
  padding: max(12px, env(safe-area-inset-top)) 12px max(12px, env(safe-area-inset-bottom)) !important;
}
.modalCard{
  width: 100% !important;
  max-width: 640px;
  max-height: calc(100dvh - (env(safe-area-inset-top) + env(safe-area-inset-bottom) + 24px)) !important;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* Calendar: make it fit nicely on iPhone */
@media (max-width: 420px){
  .calTop{ gap: 8px; }
  .calMonth{ font-size: 14px; }

  .calWeekdays{
    gap: 6px;
    font-size: 11px;
  }

  .calGrid{
    gap: 6px;
  }

  .calDay{
    border-radius: 12px;
    padding: 8px 8px 10px;
    min-height: 48px; /* smaller but still tappable */
  }

  .calNum{
    font-size: 13px;
  }

  .calDot{
    right: 8px;
    bottom: 8px;
    font-size: 10px;
    padding: 2px 6px;
  }

  /* Make rows not overflow horizontally */
  .row{
    gap: 10px;
  }
  .rowTitle{
    word-break: break-word;
  }
}

/* Fix sticky header + scroll jank in iOS inside modal */
.modalHeader{
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

/* If any horizontal overflow happens, kill it on mobile */
@media (max-width: 520px){
  html, body{ overflow-x: hidden; }
}
/* =========================================================
   MOBILE SCROLL + SPACING FIX (iOS + Android)
   Ensures the page can scroll to the bottom without giant gaps.
   ========================================================= */

/* Let the document scroll normally (no locked body)  */
html, body{
  height:100%;
  overflow-x:hidden;
  overflow-y:auto;
}

#appShell{
  min-height:100dvh;
  background: inherit;
}

/* Keep tabs fixed, but make room for them in the scroll area */
    
#appShell > main{
  padding-bottom: calc(env(safe-area-inset-bottom) + 120px);
}

.container{
  padding-bottom: calc(env(safe-area-inset-bottom) + 120px) !important;
}

/* 2) Keep tabs fixed at the bottom */
.tabs{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  padding: 8px 10px calc(env(safe-area-inset-bottom) + 10px);
  z-index:40;
}

.tabRow{
  display:flex;
  gap:10px;
  overflow-x:auto;
  overflow-y:hidden;
  scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling:touch;
  padding-bottom: 2px;
}

.tabRow::-webkit-scrollbar{ display:none; }
.tabRow{ scrollbar-width:none; }

.tab{
  flex:0 0 auto;
  min-width: 92px;
  scroll-snap-align:center;
  padding: 10px 10px;
  border-radius: 16px;
}

/* 3) Top bar: reflow actions under the title on iPhone */
@media (max-width: 520px){
  .top{
    padding: calc(env(safe-area-inset-top) + 8px) 12px 10px;
  }

  .brandRow{
    grid-template-columns: 44px 1fr;
    grid-template-rows: auto auto;
    row-gap: 10px;
  }

  .brand{ grid-column: 2; grid-row: 1; }

  .topActions{
    grid-column: 1 / -1;
    grid-row: 2;
    justify-content:flex-end;
    gap:10px;
  }

  /* Make Export / Logout smaller */
  .pillBtn{
    padding: 9px 12px;
    font-size: 12px;
    min-height: 44px; /* good tap target */
  }
}

/* 4) Cards: tighter spacing on iPhone */
@media (max-width: 420px){
  :root{
    --pad: 12px;
    --pad2: 14px;
    --radius: 14px;
    --radius2: 18px;
  }

  .grid{ gap: 10px; }
  .cardInner{ padding: 14px !important; }
  .h{ font-size: 13px; }
  .small{ font-size: 12px; line-height:1.35; }
}

/* 5) Availability calendar: fit better on small screens */
@media (max-width: 420px){
  .calTop{
    display:grid;
    grid-template-columns: 42px 1fr 42px;
    gap:10px;
    align-items:center;
    margin-bottom:10px;
  }

  .calMonth{
    text-align:center;
    font-size: 14px;
  }

  .calWeekdays{
    gap:6px;
    font-size:11px;
    margin-bottom:6px;
  }

  .calGrid{ gap:6px; }

  .calDay{
    min-height: 44px;
    padding: 8px 8px 10px;
    border-radius: 12px;
  }

  .calNum{ font-size: 13px; }

  .calDot{
    right:8px;
    bottom:8px;
    font-size:10px;
    padding: 2px 6px;
  }
}

/* 6) Prevent iOS Safari input zoom + make modals scroll nicely */
input, select, textarea, button{
  font-size:16px;
}

.overlayModal{
  padding: max(12px, env(safe-area-inset-top)) 12px max(12px, env(safe-area-inset-bottom)) !important;
}

.modalCard{
  max-height: calc(100dvh - (env(safe-area-inset-top) + env(safe-area-inset-bottom) + 24px)) !important;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}
/* =========================================================
   FINAL MOBILE TUNING (iPhone + Android)
   Paste at the VERY END of <style>
   ========================================================= */

/* 1) Make bottom spacing match the real tab-bar height (kills the huge empty gap) */
:root{
  --tabsOffset: 92px;          /* space reserved for the fixed tabs (not including safe-area) */
  --tabsOffsetDesktop: 140px;
}

#appShell > main{
  padding-bottom: calc(env(safe-area-inset-bottom) + var(--tabsOffset)) !important;
}
.container{
  padding-bottom: calc(env(safe-area-inset-bottom) + var(--tabsOffset)) !important;
}

/* 2) Slimmer bottom tabs (less tall, more ‚Äúnative‚Äù) */
.tabs{
  padding: 6px 10px calc(env(safe-area-inset-bottom) + 8px) !important;
}
.tabRow{
  gap: 8px !important;
}
.tab{
  min-width: 78px !important;
  padding: 8px 10px !important;
  border-radius: 14px !important;
  font-size: 10px !important;
}
.tab .emoji{
  font-size: 14px !important;
}

/* 3) Top bar: keep it one clean row on phones (no big 2-row header) */
@media (max-width: 520px){
  .top{
    padding: calc(env(safe-area-inset-top) + 8px) 12px 10px !important;
  }

  /* override the 2-row mobile reflow */
  .brandRow{
    grid-template-columns: 40px 1fr auto !important;
    grid-template-rows: auto !important;
    row-gap: 0 !important;
  }

  .logo{
    width: 32px !important;
    height: 32px !important;
    border-radius: 10px !important;
  }

  .topActions{
    grid-column: auto !important;
    grid-row: auto !important;
    justify-content: flex-end !important;
    gap: 8px !important;
  }

  .pillBtn{
    padding: 8px 10px !important;
    border-radius: 14px !important;
    font-size: 12px !important;
    min-height: 40px !important; /* still comfy to tap */
  }

  /* slightly cleaner top glass */
  .top{
    background-color: rgba(11,11,13,.78) !important;
    background-image: linear-gradient(to bottom, rgba(11,11,13,.88), rgba(11,11,13,.60)) !important;
  }
}

/* 4) ‚ÄúEverything is too big‚Äù fix specifically for the PT My Dancers screen */
@media (max-width: 520px){
  /* the PT polish block adds big padding/font sizes ‚Äî tighten them */
  #screen-dancers .card,
  #linkCard{
    padding: 14px !important;
  }

  #screen-dancers .cardTitle,
  #linkCard .cardTitle{
    font-size: 16px !important;
    line-height: 1.15 !important;
  }

  #screen-dancers .cardSub,
  #linkCard .cardSub{
    font-size: 12px !important;
    line-height: 1.35 !important;
  }

  #ptDancersList{ gap: 8px !important; }
  #ptCheckinsList{ gap: 8px !important; }
}

/* 5) Desktop/tablet: keep a bit more breathing room */
@media (min-width: 521px){
  #appShell > main{
    padding-bottom: calc(env(safe-area-inset-bottom) + var(--tabsOffsetDesktop)) !important;
  }
  .container{
    padding-bottom: calc(env(safe-area-inset-bottom) + var(--tabsOffsetDesktop)) !important;
  }
}
/* 1) Reserve only the space we truly need for the fixed tab bar */
:root{
  --tabsSafe: env(safe-area-inset-bottom);
  --tabsReserve: 88px; /* tuned for your tab button height */
}

/* Kill the giant bottom padding and use a consistent reserve instead */
#appShell > main{
  padding-bottom: calc(var(--tabsReserve) + var(--tabsSafe)) !important;
}
.container{
  padding-bottom: calc(var(--tabsReserve) + var(--tabsSafe)) !important;
}

/* 2) Tabs: pin to bottom + reduce the ‚Äúdead‚Äù space under buttons */
.tabs{
  position: fixed !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;

  /* Important: don't do safe-area + extra big number */
  padding: 8px 10px max(10px, calc(var(--tabsSafe) - 10px)) !important;

  background-color: rgba(11,11,13,.92);
  background-image: linear-gradient(to top, rgba(11,11,13,.98), rgba(11,11,13,.70));
  border-top: 1px solid rgba(255,255,255,.10);
}

/* Make the tabs feel smaller/cleaner on phone */
.tabRow{
  display: flex !important;
  gap: 10px !important;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.tabRow::-webkit-scrollbar{ display:none; }

.tab{
  flex: 1 1 0;
  min-width: 0;
  padding: 9px 10px !important;
  border-radius: 14px !important;
  font-size: 11px !important;
}
.tab .emoji{
  font-size: 15px !important;
}

/* 3) PT ‚ÄúMy Dancers‚Äù card is oversized on mobile because of the PT polish block */
@media (max-width: 420px){
  #screen-dancers .cardTitle,
  #linkCard .cardTitle{
    font-size: 16px !important;
  }

  #screen-dancers .card,
  #linkCard{
    padding: 14px !important;
  }
}

/* 4) Top bar polish on iPhone: less cramped + no ugly truncation */
@media (max-width: 420px){
  .top{
    padding: calc(env(safe-area-inset-top) + 8px) 12px 10px !important;
  }

  .brandRow{
    grid-template-columns: 40px 1fr;
    grid-template-rows: auto auto;
    row-gap: 10px;
  }

  .logo{
    width: 34px;
    height: 34px;
    border-radius: 12px;
  }

  .title{ font-size: 15px; }
  .subtitle{ font-size: 11px; opacity: .85; }

  .topActions{
    grid-column: 1 / -1;
    justify-content: flex-end;
    gap: 8px;
  }

  .pillBtn{
    padding: 8px 10px !important;
    font-size: 12px !important;
  }

  /* Shorten labels to avoid "On Pointe P..." truncation */
  #exportBtn span:last-child{ display:none; }
  #exportBtn::after{ content:"CSV"; font-weight:900; }

  #logoutBtn span:last-child{ display:none; }
  #logoutBtn::after{ content:"Logout"; font-weight:900; }
}

/* =========================================================
   MESSAGING + ALERTS + SMART FLAGS (NEW)
   ========================================================= */
.chatWrap{
  display:grid;
  gap:12px;
  max-height: 52vh;
  overflow:auto;
  padding: 12px;
  border-radius: 18px;
  border: 1px solid var(--line);
  background:
    radial-gradient(400px 240px at 10% 0%, rgba(255,255,255,.06), transparent 65%),
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
}
.chatRow{
  display:flex;
  align-items:flex-end;
  gap:8px;
}
.chatRow.me{
  justify-content:flex-end;
}
.chatAvatar{
  width:30px;
  height:30px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
  font-weight:900;
  color: rgba(255,255,255,.95);
  background: rgba(255,255,255,.12);
  border:1px solid rgba(255,255,255,.18);
  flex:0 0 auto;
}
.chatRow.me .chatAvatar{
  order:2;
  background: rgba(255,255,255,.18);
}
.chatContent{
  display:flex;
  flex-direction:column;
  gap:4px;
  max-width:72%;
}
.chatRow.me .chatContent{
  align-items:flex-end;
  text-align:right;
}
.chatBubble{
  padding: 10px 12px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  line-height:1.35;
  word-break: break-word;
  box-shadow: 0 10px 18px rgba(0,0,0,.25);
}
.chatBubble.me{
  background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
  border-color: rgba(255,255,255,.25);
}
.chatMeta{
  font-size:11px;
  color: rgba(255,255,255,.65);
}
.chatInputRow{
  display:grid;
  grid-template-columns: 1fr auto;
  gap:8px;
  margin-top:10px;
}
.chatInputRow textarea{
  min-height: 44px;
  max-height: 120px;
}
.unreadDot{
  width:8px;height:8px;border-radius:999px;
  background: var(--high);
  display:inline-block;
}
.unreadBadge{
  min-width:22px;
  padding:3px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,92,92,.18);
}
.threadRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.threadMeta{
  font-size:12px;
  color:rgba(255,255,255,.70);
}
.flagBadge{
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  border:1px solid var(--line);
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.flagBadge.green{ background: rgba(57,217,138,.15); color:#dff7ec; }
.flagBadge.yellow{ background: rgba(255,176,32,.15); color:#ffe7b2; }
.flagBadge.orange{ background: rgba(255,130,60,.18); color:#ffd7c0; }
.flagBadge.red{ background: rgba(255,92,92,.18); color:#ffd0d0; }
.alertDot{
  width:10px;height:10px;border-radius:999px;
}
.alertDot.yellow{ background:#ffb020; }
.alertDot.orange{ background:#ff7a3d; }
.alertDot.red{ background:#ff5c5c; }
.alertList{ display:grid; gap:10px; margin-top:10px; }
.alertRow{
  display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  border:1px solid var(--line);
  border-radius: 16px;
  padding: 12px;
  background: rgba(255,255,255,.04);
}
.alertRow .rowMain{ min-width:0; }
.alertActions{ display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
.tabBadge{
  margin-left:6px;
  min-width:18px;
  height:18px;
  border-radius:999px;
  background: rgba(255,92,92,.18);
  border:1px solid rgba(255,92,92,.45);
  font-size:10px;
  font-weight:900;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:0 6px;
}
.messageHeaderRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.messageThreadList{
  display:grid;
  gap:10px;
  margin-top:10px;
}
.messageEmpty{
  font-size:12px;
  color:rgba(255,255,255,.70);
  margin-top:10px;
}    
  </style>
</head>

<body>
  <!-- AUTH -->
  <section id="authScreen" class="authWrap" style="display:none;">
    <div class="authCard">
      <div class="authHero">
        <div class="authLogo"></div>
        <div class="authBrand">
          <h1>On Pointe Prevention‚Ñ¢</h1>
          <p>PT-guided injury prevention, recovery, and load monitoring for dancers.</p>
        </div>
      </div>
      <div class="authBody">
        <div class="authTitle" id="authModeTitle">ONPOINTE LOGIN</div>
        <div class="authSub">Your leap, safely landed.</div>

<div class="form" style="gap:12px;">

  <!-- Name (Create mode only) -->
  <div class="field" id="authNameWrap" style="display:none;">
    <div class="labelRow"><span>Name</span></div>
    <input type="text" id="authName" placeholder="Your name" autocomplete="name" />
  </div>

  <div class="field">
    <div class="labelRow"><span>Email</span></div>
    <input type="email" id="authEmail" placeholder="you@example.com" autocomplete="email" />
  </div>

  <div class="field">
    <div class="labelRow"><span>Password</span></div>
    <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
  </div>

  <!-- Confirm Password (Create mode only) -->
  <div class="field" id="authPassword2Wrap" style="display:none;">
    <div class="labelRow"><span>Re-enter password</span></div>
    <input type="password" id="authPassword2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
  </div>
<section id="roleGate" class="roleInline" style="display:none;">
  <h2>Finish setup</h2>
  <p>Choose who you are to continue.</p>

  <div class="roleBtns">
    <button id="chooseDancerBtn" type="button">I‚Äôm a Dancer</button>
    <button id="choosePtBtn" type="button">I‚Äôm a PT</button>
  </div>

  <div id="ptCodeWrap" class="ptCode" style="display:none;">
    <div style="font-size:11px; color:var(--muted); margin-bottom:6px;">
      Enter PT secret code
    </div>

    <input id="ptSecretCode" type="password" placeholder="Code" />

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px;">
      <button id="savePtRoleBtn" type="button">Continue as PT</button>
      <button id="cancelPtRoleBtn" type="button">Back</button>
    </div>

    <div id="ptCodeError" style="display:none; margin-top:8px; font-size:11px; color:#ffb4b4;">
      Wrong code. Try again.
    </div>
  </div>
</section>
</div>
        <button class="authBtn" id="authPrimaryBtn" type="button">Log in</button>

          <div class="authLinkRow">
            <span id="authAltText">Don‚Äôt have an account?</span>
            <a class="authLink" id="authToggle" href="javascript:void(0)">Create</a>
          </div>

          <div class="authLinkRow" style="margin-top:6px;">
            <a class="authLink" id="authReset" href="javascript:void(0)" style="border-bottom-color:rgba(255,255,255,.18); color:rgba(255,255,255,.75)">Forgot password</a>
          </div>
          <div class="authMsg" id="authMsg"></div>
        </div>
      </section>
    
  <!-- APP -->
  <div id="appShell" style="display:none;">
    <div class="top">
      <div class="brandRow">
        <div class="logo"></div>

        <div class="brand">
          <p class="title">On Pointe Prevention‚Ñ¢</p>
          <p class="subtitle" id="subtitleText">PT-guided load monitoring + conditioning</p>
        </div>

        <div class="topActions">
          <button class="pillBtn" id="exportBtn" type="button">
            <span class="tinyDot"></span><span>Export CSV</span>
          </button>
          <button class="pillBtn" id="logoutBtn" type="button">
            <span class="tinyDot" style="opacity:.45"></span><span>Logout</span>
          </button>
        </div>
      </div>
    </div>

    <main>
      <!-- DASHBOARD -->
      <div class="container" id="screen-dashboard">
        <div class="grid">
<!-- PT ‚Üî Dancer Linking -->
<div class="card" id="linkCard" style="margin-bottom:14px; display:none;">
  <div class="cardInner">
    <div class="cardTitle">PT connection</div>
    <div class="cardSub" id="linkSub" style="margin-top:6px; color:rgba(255,255,255,.72)"></div>

    <!-- Dancer view -->
    <div id="dancerLinkUI" style="display:none; margin-top:12px;">
      <div class="labelRow"><span>Enter PT code</span></div>
      <input id="ptLinkCode" placeholder="e.g. AB12CD" style="
        width:100%;
        padding:12px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.03);
        color: var(--text);
        outline:none;
        margin-top:6px;
      "/>
      <button class="pillBtn" id="linkToPtBtn" type="button" style="margin-top:10px; width:100%; justify-content:center;">
        Link to PT
      </button>
      <button id="unlinkBtn" class="mutedBtn danger" type="button" style="display:none; width:100%;">
        Unlink from PT
      </button>
      <div id="linkMsg" style="margin-top:10px; color:rgba(255,255,255,.75); font-size:12px;"></div>
    </div>

    <!-- PT view -->
    <div id="ptLinkUI" style="display:none; margin-top:12px;">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <div>
          <div class="labelRow"><span>Your PT code</span></div>
          <div id="myPtCode" style="font-size:18px; font-weight:900; letter-spacing:.08em; margin-top:6px;">
            ‚Äî
          </div>
          <div style="font-size:12px; color:rgba(255,255,255,.65); margin-top:6px;">
            Share this with your dancer to connect.
          </div>
        </div>
        <button class="pillBtn" id="regenPtCodeBtn" type="button" style="height:40px;">
          New code
        </button>
      </div>
      <div id="ptCodeMsg" style="margin-top:10px; color:rgba(255,255,255,.75); font-size:12px;"></div>
    </div>
  </div>
</div>

<!-- MESSAGING -->
<div class="card" id="ptMessagesRosterCard" style="margin-bottom:14px; display:none;">
  <div class="cardInner">
    <div class="cardTitle">Messages</div>
    <div class="cardSub" id="ptMessagesSub">Chat with your linked dancers.</div>
    <div id="ptMessagesMsg" class="hint" style="margin-top:10px;"></div>
    <div id="ptMessagesList" class="chatRoster"></div>
  </div>
</div>

<!-- PT DASHBOARD -->
<div class="card" id="ptAvailabilityCard" style="display:none;">
  <div class="cardInner">
    <div class="cardTitle">Availability</div>
    <div class="cardSub" style="margin-top:6px;">
      Set when dancers can request sessions.
    </div>


<!-- Calendar UI (PT Availability) -->
<div id="ptAvailCalendar" style="margin-top:12px;">
  <div class="calTop">
    <button class="iconBtn" id="ptCalPrev" type="button" aria-label="Previous month">‚Äπ</button>
    <div class="calMonth" id="ptCalMonthLabel">‚Äî</div>
    <button class="iconBtn" id="ptCalNext" type="button" aria-label="Next month">‚Ä∫</button>
  </div>

  <div class="calWeekdays" id="ptCalWeekdays">
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  </div>

  <div class="calGrid" id="ptCalGrid"></div>

  <div style="margin-top:12px;">
    <div class="labelRow">
      <span id="ptCalSelectedLabel">Select a day</span>
    </div>
    <div id="ptCalDaySlots" style="margin-top:8px;"></div>
  </div>
</div>

<!-- Keep legacy container (hidden) so older code won't crash if referenced -->
<div id="ptAvailList" style="margin-top:12px; display:none;"></div>
  </div>
</div>

<div class="card" id="ptRecentCard" style="display:none;">
  <div class="cardInner">
    <div class="cardTitle">Recent dancer check-ins</div>
    <div class="cardSub" style="margin-top:6px;">
      Latest activity from dancers linked to you.
    </div>

    <div id="ptRecentCheckins" style="margin-top:12px;"></div>
  </div>
</div>
<!-- PT Alerts -->
<div class="card" id="ptAlertsCard" style="display:none;">
  <div class="cardInner">
    <div class="cardHeader">
      <div>
        <p class="h">Red Flag Alerts</p>
        <div class="small">High-risk check-ins from your linked dancers.</div>
      </div>
      <div class="badge" id="ptAlertsCount">
        <span class="badgeDot"></span>
        <span id="ptAlertsCountLabel">0</span>
      </div>
    </div>
    <div id="ptAlertsList" class="alertList"></div>
  </div>
</div>

<!-- Dancer Smart Feedback -->
<div class="card" id="smartFlagCard" style="display:none;">
  <div class="cardInner">
    <div class="cardHeader">
      <div>
        <p class="h">Smart Check-In Feedback</p>
        <div class="small">Real-time guidance based on your latest check-in.</div>
      </div>
      <div class="flagBadge green" id="smartFlagBadge">
        <span>GREEN</span>
      </div>
    </div>
    <div id="smartFlagEmpty" class="small">Submit a check-in to see feedback.</div>
    <div id="smartFlagBody" style="display:none;">
      <div class="rowSub" id="smartFlagReasons"></div>
      <div class="rowSub" id="smartFlagAdvice" style="margin-top:8px;"></div>
      <div class="btnRow" style="margin-top:12px;">
        <button class="btn primary" id="smartFlagMessageBtn" type="button" style="display:none;">üí¨ Message PT</button>
      </div>
    </div>
  </div>
</div>

                   <div class="card">
            <div class="cardInner">
              <div class="cardHeader">
                <div>
                  <p class="h">Injury Risk Snapshot</p>
                  <div class="small">Based on acute/chronic load (ACWR) + recovery markers.</div>
                </div>

                <div style="display:flex; gap:10px; align-items:center;">
                  <div class="badge ok" id="riskBadge">
                    <span class="badgeDot"></span>
                    <span id="riskLabel">OK</span>
                  </div>
                  <button class="iconBtn" id="riskInfoBtn" type="button" aria-label="Explain injury risk">?</button>
                </div>
              </div>

              <div class="metrics">
                <div class="metric">
                  <div class="k">ACWR</div>
                  <div class="v" id="m_acwr">‚Äî</div>
                  <div class="s">acute / chronic</div>
                </div>
                <div class="metric">
                  <div class="k">Acute (7d avg)</div>
                  <div class="v" id="m_acute">‚Äî</div>
                  <div class="s">session load</div>
                </div>
                <div class="metric">
                  <div class="k">Chronic (28d avg)</div>
                  <div class="v" id="m_chronic">‚Äî</div>
                  <div class="s">session load</div>
                </div>
              </div>

              <div style="margin-top:12px">
                <p class="h">Guidance</p>
                <div class="small" id="guidanceText">Add check-ins to generate guidance.</div>

                 <div class="btnRow" style="gap:12px;">
                  <button
                    class="btn primary"
                    id="openCheckin"
                    type="button"
                    style="padding:16px 18px; font-size:14px; border-radius:18px; flex:1 1 220px;"
                  >üìù Today‚Äôs Check-In</button>

                  <button class="btn" id="restDayBtn" type="button">üõå Rest Day</button>
                  <button class="btn" id="openExercises" type="button">ü©∞ Exercise Library</button>
                  <button class="btn danger" id="clearData" type="button">üóëÔ∏è Clear Data</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="cardInner">
              <div class="cardHeader">
                <div>
                  <p class="h">Trends</p>
                  <div class="small">Last 14 sessions (session load).</div>
                </div>
                <div class="badge" id="trendHint">Add more check-ins for trends</div>
              </div>
              <canvas id="trendCanvas" width="800" height="240"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="cardInner">
              <p class="h">Last 7 Days</p>
              <div class="small">Quick view of recent entries.</div>
              <div class="list" id="recentList"></div>
            </div>
          </div>

        </div>
      </div>

      <!-- CHECKIN -->
      <div class="container" id="screen-checkin" style="display:none">
        <div class="card">
          <div class="cardInner">
            <p class="h">Today‚Äôs Check-In</p>
            <div class="small">Track load + recovery markers. Session load = minutes √ó RPE.</div>
            <div class="btnRow">
              <button class="btn primary" id="openCheckin2" type="button">üìù Open Check-In Form</button>
            </div>
          </div>
        </div>
      </div>

<!-- PT: My Dancers -->
<section id="screen-dancers" style="display:none;">
  <div class="container">
    <div class="card">
      <div class="cardTop">
        <div>
          <div class="cardTitle">My Dancers</div>
          <div class="cardSub">Read check-ins from dancers linked to your PT account.</div>
        </div>
        <button class="mutedBtn" id="refreshDancersBtn" type="button">Refresh</button>
      </div>

      <div id="ptDancersMsg" class="hint" style="margin-top:10px;"></div>
      <div id="ptDancersList" style="display:grid; gap:10px; margin-top:12px;"></div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="cardTitle" id="ptDancerTitle">Select a dancer</div>
      <div class="cardSub" id="ptDancerSub">Their recent check-ins will appear here.</div>
      <div id="ptCheckinsList" style="display:grid; gap:10px; margin-top:12px;"></div>
    </div>
  </div>
</section>

      <!-- MESSAGES -->
<section id="screen-messages" style="display:none;">
  <div class="container">
    <div class="card">
      <div class="cardInner">
        <div class="messageHeaderRow">
          <div>
            <div class="cardTitle">Messages</div>
            <div class="cardSub">Chat with your linked PT or dancers.</div>
          </div>
          <button class="mutedBtn" id="refreshMessagesBtn" type="button">Refresh</button>
        </div>
        <div id="messagesThreadList" class="messageThreadList"></div>
        <div id="messagesEmpty" class="messageEmpty"></div>
      </div>
    </div>

    <div class="card" id="chatCard" style="margin-top:14px; display:none;">
      <div class="cardInner">
        <div class="messageHeaderRow">
          <div>
            <div class="cardTitle" id="chatTitle">Chat</div>
            <div class="cardSub" id="chatSub">‚Äî</div>
          </div>
          <button class="mutedBtn" id="chatBackBtn" type="button">Back</button>
        </div>

        <div id="chatMessages" class="chatWrap"></div>

        <form id="chatForm" class="chatInputRow">
          <textarea id="chatInput" placeholder="Type a message‚Ä¶" required></textarea>
          <button class="btn primary" id="chatSendBtn" type="submit">Send</button>
        </form>
        <div class="small" style="margin-top:8px;">Messages show ‚ÄúDelivered‚Äù after send.</div>
      </div>
    </div>
  </div>
</section>
      
<!-- EXERCISES -->
<div class="container" id="screen-exercises" style="display:none">
  <div class="grid">

    <!-- Routines -->
    <div class="card">
      <div class="cardInner">
        <div class="cardHeader" style="margin-bottom:10px;">
          <div>
            <p class="h">Routines</p>
            <div class="small">Save warm-ups, prehab, recovery, strength blocks. Apply them to Today‚Äôs Check-In in one tap.</div>
          </div>
          <button class="mutedBtn" id="newRoutineBtn" type="button">Ôºã New Routine</button>
        </div>

        <div class="list" id="routineList"></div>
      </div>
    </div>

    <!-- Exercise Library -->
    <div class="card">
      <div class="cardInner">
        <div class="cardHeader" style="margin-bottom:10px;">
          <div>
            <p class="h">Exercise Library</p>
            <div class="small">Search, filter by category, favorite, and build a dancer-specific plan.</div>
          </div>
          <button class="mutedBtn" id="openAddExercise" type="button">Ôºã Add Exercise</button>
        </div>

        <!-- Controls -->
        <div style="display:grid; gap:10px; margin-bottom:10px;">
          <input
            type="text"
            id="exSearch"
            placeholder="Search exercises (name, focus, prescription...)"
            style="width:100%;"
            autocomplete="off"
          />

          <!-- Category chips -->
          <div id="categoryChips" style="display:flex; gap:8px; flex-wrap:wrap;"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="mutedBtn" id="toggleFavorites" type="button">‚≠ê Favorites: Off</button>
            <button class="mutedBtn" id="clearSearch" type="button">Clear Search</button>
          </div>
        </div>

        <div class="list" id="exerciseList"></div>
      </div>
    </div>

  </div>
</div>

      <!-- HISTORY -->
      <div class="container" id="screen-history" style="display:none">
        <div class="card">
          <div class="cardInner">
            <p class="h">History</p>
            <div class="small">All check-ins for your account.</div>
            <div class="list" id="historyList"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tabRow">
        <button class="tab active" data-tab="dashboard" type="button"><div class="emoji">üìä</div>Dashboard</button>
        <button class="tab" data-tab="checkin" type="button"><div class="emoji">üìù</div>Check-In</button>         <button class="tab" data-tab="dancers" type="button"><div class="emoji">üíÉ</div>My Dancers</button>
        <button class="tab" data-tab="messages" type="button"><div class="emoji">üí¨</div>Messages <span class="tabBadge" id="messagesTabBadge" style="display:none;">0</span></button>
        <button class="tab" data-tab="exercises" type="button"><div class="emoji">ü©∞</div>Exercises</button>

        <button class="tab" data-tab="history" type="button"><div class="emoji">üóìÔ∏è</div>History</button>
      </div>
    </div>
<!-- Modal: Rest Day -->
<div class="modalBackdrop" id="restModal">
  <div class="modal">
    <div class="modalTop">
      <p class="modalTitle">Rest Day</p>
      <button class="iconBtn" id="closeRest" type="button">‚óè Close</button>
    </div>

    <div class="modalBody">
      <div class="small" style="margin-bottom:12px;">
        Marks <strong>today</strong> as a rest day (minutes 0, RPE 0). Still log recovery + pain so your trends stay clinically useful.
      </div>

      <form class="form" id="restForm">
        <div class="field">
          <div class="labelRow"><span>Reason</span></div>
          <select id="restReason" style="width:100%; background: rgba(255,255,255,.04); border:1px solid var(--line); color: var(--text); border-radius: 14px; padding: 12px 12px; font-size: 14px; outline: none;">
            <option value="Deload / planned recovery">Deload / planned recovery</option>
            <option value="Performance day">Performance day</option>
            <option value="Travel / schedule chaos">Travel / schedule chaos</option>
            <option value="High soreness / pain flare">High soreness / pain flare</option>
            <option value="Illness / low energy">Illness / low energy</option>
            <option value="Mental recovery / stress">Mental recovery / stress</option>
            <option value="Cross-training day">Cross-training day</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- NEW: pain tracking -->
        <div class="field">
          <div class="labelRow"><span>Pain intensity (0‚Äì10)</span> <span class="val" id="rv_pain">0</span></div>
          <input type="range" id="r_pain" min="0" max="10" step="1" value="0" />
          <div class="hint">0 = none. Optional but very useful for flare-ups.</div>
        </div>

        <div class="field">
          <div class="labelRow"><span>Pain location (optional)</span></div>
          <input type="text" id="restPainLocation" placeholder="e.g., left Achilles, anterior hip, low back, 2nd met head..." autocomplete="off" />
          <div class="hint">Keep it short. This is not medical advice‚Äîjust tracking.</div>
        </div>

        <div class="field">
          <div class="labelRow"><span>Sleep (hours)</span> <span class="val" id="rv_sleep">7.0</span></div>
          <input type="range" id="r_sleep" min="0" max="10" step="0.5" value="7" />
        </div>

        <div class="field">
          <div class="labelRow"><span>Soreness (0‚Äì10)</span> <span class="val" id="rv_sore">3</span></div>
          <input type="range" id="r_sore" min="0" max="10" step="1" value="3" />
        </div>

        <div class="field">
          <div class="labelRow"><span>Fatigue (0‚Äì10)</span> <span class="val" id="rv_fatigue">4</span></div>
          <input type="range" id="r_fatigue" min="0" max="10" step="1" value="4" />
        </div>

        <div class="field">
          <div class="labelRow"><span>Notes (optional)</span></div>
          <textarea id="restNotes" placeholder="Type details here (e.g., calf tightness after rehearsal, flight day, deload week, PT advice...)"></textarea>
          <div class="hint">Saved into today‚Äôs notes and exported in CSV.</div>
        </div>

        <div class="btnRow">
          <button class="btn primary" type="submit">üíæ Save Rest Day ‚úì</button>
          <button class="btn" id="cancelRest" type="button">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>
    <!-- Modal: Check-in -->
    <div class="modalBackdrop" id="checkinModal">
      <div class="modal">
        <div class="modalTop">
          <p class="modalTitle">Today‚Äôs Check-In</p>
          <button class="iconBtn" id="closeCheckin" type="button">‚óè Close</button>
        </div>
        <div class="modalBody">
          <form class="form" id="checkinForm">
            <div class="field">
              <div class="labelRow"><span>Date</span></div>
              <input type="date" id="f_date" required />
            </div>

            <div class="field">
              <div class="labelRow"><span>Dance minutes</span> <span class="val" id="v_minutes">60</span></div>
              <input type="range" id="f_minutes" min="0" max="240" value="60" />
              <div class="hint">Include class + rehearsal + performance time.</div>
            </div>

            <div class="field">
              <div class="labelRow"><span>RPE (0‚Äì10)</span> <span class="val" id="v_rpe">6</span></div>
              <input type="range" id="f_rpe" min="0" max="10" step="1" value="6" />
              <div class="hint">0 = rest, 10 = maximal effort.</div>
            </div>

            <div class="field">
              <div class="labelRow"><span>Sleep (hours)</span> <span class="val" id="v_sleep">7.0</span></div>
              <input type="range" id="f_sleep" min="0" max="10" step="0.5" value="7" />
            </div>

            <div class="field">
              <div class="labelRow"><span>Soreness (0‚Äì10)</span> <span class="val" id="v_sore">3</span></div>
              <input type="range" id="f_sore" min="0" max="10" step="1" value="3" />
            </div>

            <div class="field">
              <div class="labelRow"><span>Fatigue (0‚Äì10)</span> <span class="val" id="v_fatigue">4</span></div>
              <input type="range" id="f_fatigue" min="0" max="10" step="1" value="4" />
            </div>

            <!-- Dancer-specific toggles -->
            <div class="field">
              <div class="labelRow"><span>Dancer markers</span><span class="hint" style="margin:0;">Optional, but makes guidance smarter</span></div>

              <div style="display:grid; gap:10px;">
                <label class="toggleLine" for="f_pointe" style="cursor:pointer;">
                  <strong>ü©∞ Pointe work</strong>
                  <span>
                    <input id="f_pointe" type="checkbox" />
                  </span>
                </label>

                <label class="toggleLine" for="f_partner" style="cursor:pointer;">
                  <strong>ü§ù Partnering</strong>
                  <span>
                    <input id="f_partner" type="checkbox" />
                  </span>
                </label>

                <div class="toggleLine" style="cursor:default;">
                  <strong>‚¨ÜÔ∏è Jump volume</strong>
                  <span>
                    <select
                      id="f_jumps"
                      class="jumpSelect"
                            >
                      <option value="0">None</option>
                      <option value="1">Low</option>
                      <option value="2">Moderate</option>
                      <option value="3">High</option>
                    </select>
                  </span>
                </div>
              </div>

              <div class="hint">These do not change load math ‚Äî they help you interpret spikes (tech week, heavy jumps, pointe, etc.).</div>
            </div>

            <div class="field">
              <div class="labelRow"><span>Notes (optional)</span></div>
              <textarea id="f_notes" placeholder="Pain location, jumps, pointe work, travel, stress, etc."></textarea>
            </div>

            <hr class="hr" />

            <!-- NEW: exercises done -->
            <div class="field">
              <div class="labelRow">
                <span>Exercises done today</span>
                <span class="hint" style="margin:0;">Pick from library + log sets/reps</span>
              </div>

               <div style="display:flex; gap:10px; align-items:stretch; flex-wrap:wrap;">
                <div class="toggleLine" id="toggleExercisePicker" style="flex:1 1 220px;">
                  <div>
                    <strong>Choose exercises</strong>
                    <div><span id="pickedCount">0 selected</span></div>
                  </div>
                  <div class="chip" style="opacity:.9;">Add</div>
                </div>

                <button class="mutedBtn" id="openRoutinePicker" type="button" style="flex:0 0 auto;">
                  ‚ûï Add Routine
                </button>
              </div>

              <div id="exercisePicker" style="display:none; margin-top:10px;">
                <div class="pickWrap" id="pickWrap"></div>
                <div class="hint" style="margin-top:8px;">
                  Tip: Keep ‚Äúminutes‚Äù = class/rehearsal time; exercises here are your conditioning/prehab work.
                </div>
              </div>
            </div>

            <div class="btnRow">
              <button class="btn primary" type="submit">üíæ Save ‚úì</button>
              <button class="btn" id="cancelCheckin" type="button">Close</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal: Exercise detail -->
    <div class="modalBackdrop" id="exerciseModal">
      <div class="modal">
        <div class="modalTop">
          <p class="modalTitle" id="exTitle">Exercise</p>
          <button class="iconBtn" id="closeExercise" type="button">‚óè Close</button>
        </div>
        <div class="modalBody" id="exBody"></div>
      </div>
    </div>

<!-- Modal: Add Exercise -->
<div class="modalBackdrop" id="addExerciseModal">
  <div class="modal">
    <div class="modalTop">
      <p class="modalTitle">Add Exercise</p>
      <button class="iconBtn" id="closeAddExercise" type="button">‚óè Close</button>
    </div>
    <div class="modalBody">
      <form class="form" id="addExerciseForm">
        <div class="field">
          <div class="labelRow"><span>Name</span></div>
          <input type="text" id="ae_name" placeholder="e.g., Intrinsic Foot (Short Foot)" required />
        </div>

        <div class="field">
          <div class="labelRow"><span>Category</span></div>
          <select id="ae_category" style="width:100%; background: rgba(255,255,255,.04); border:1px solid var(--line); color: var(--text); border-radius: 14px; padding: 12px 12px; font-size: 14px; outline: none;">
            <option value="Foot/Ankle">Foot/Ankle</option>
            <option value="Hip/Core">Hip/Core</option>
            <option value="Strength">Strength</option>
            <option value="Plyometrics">Plyometrics</option>
            <option value="Mobility">Mobility</option>
            <option value="Turnout/Technique">Turnout/Technique</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="field">
          <div class="labelRow"><span>Focus / why</span></div>
          <input type="text" id="ae_focus" placeholder="e.g., arch control ¬∑ pointe tolerance" required />
        </div>

        <div class="field">
          <div class="labelRow"><span>Default prescription</span></div>
          <input type="text" id="ae_presc" placeholder="e.g., 3√ó10, slow tempo" required />
          <div class="hint">This becomes the default sets/reps shown in check-in.</div>
        </div>

        <div class="field">
          <div class="labelRow"><span>How to do it (optional)</span></div>
          <textarea id="ae_how" placeholder="Technique cues, setup, progressions..."></textarea>
        </div>

        <div class="field">
          <div class="labelRow"><span>Coaching cues (optional)</span></div>
          <input type="text" id="ae_cues" placeholder="Comma-separated, e.g., tripod foot, ribs down, slow tempo" />
        </div>

        <div class="btnRow">
          <button class="btn primary" type="submit">Ôºã Add</button>
          <button class="btn" id="cancelAddExercise" type="button">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

    <!-- Modal: Risk Info -->
    <div class="modalBackdrop" id="riskInfoModal" style="align-items:center; padding: 12px 12px calc(env(safe-area-inset-bottom) + 12px);">
  <div class="modal">
    <div class="modalTop">
      <p class="modalTitle">Injury Risk: How to read this</p>
      <button class="iconBtn" id="closeRiskInfo" type="button">‚óè Close</button>
    </div>
    <div class="modalBody">
      <div id="riskInfoBody" class="rowSub" style="line-height:1.35;">
        Loading‚Ä¶
      </div>
    </div>
  </div>
</div>

    <!-- Modal: Routine Picker (apply to today) -->
    <div class="modalBackdrop" id="routinePickerModal">
      <div class="modal">
        <div class="modalTop">
          <p class="modalTitle">Add Routine to Today</p>
          <button class="iconBtn" id="closeRoutinePicker" type="button">‚óè Close</button>
        </div>
        <div class="modalBody">
          <div class="small" style="margin-bottom:10px;">This adds all exercises from a routine into today‚Äôs selected list (won‚Äôt remove what you already picked).</div>
          <div class="list" id="routinePickerList"></div>
        </div>
      </div>
    </div>

    <!-- Modal: Routine Editor -->
    <div class="modalBackdrop" id="routineEditorModal">
      <div class="modal">
        <div class="modalTop">
          <p class="modalTitle" id="routineEditorTitle">Routine</p>
          <button class="iconBtn" id="closeRoutineEditor" type="button">‚óè Close</button>
        </div>
        <div class="modalBody">
          <div class="form">
            <div class="field">
              <div class="labelRow"><span>Name</span></div>
              <input type="text" id="r_name" placeholder="e.g., Pointe Prehab Warm-Up" autocomplete="off" />
              <div class="hint">Keep it short so it‚Äôs easy to pick on iPhone.</div>
            </div>

            <div class="field">
              <div class="labelRow"><span>Pick exercises</span><span class="hint" style="margin:0;">Tap Add/Remove</span></div>
              <div class="pickWrap" id="routineExercisePicker"></div>
            </div>

            <div class="btnRow">
              <button class="btn primary" id="saveRoutineBtn" type="button">üíæ Save Routine</button>
              <button class="btn danger" id="deleteRoutineBtn" type="button" style="display:none;">üóëÔ∏è Delete</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">Saved</div>
  </div>
<!-- PT Check-in Modal (single source of truth) -->
<div id="ptCheckinModal" class="overlayModal">
  <div class="modalCard">
    <div class="modalHeader">
      <div>
        <div id="ptCheckinTitle" style="font-weight:900;">Check-in</div>
        <div id="ptCheckinSub" class="sub"></div>
      </div>
      <button id="ptCheckinCloseBtn" class="iconBtn" type="button">Close</button>
    </div>

    <div id="ptCheckinBody" style="color:rgba(255,255,255,.88); font-size:14px; line-height:1.35; margin-top:10px;">
      <!-- filled by JS -->
    </div>
  </div>
</div>

 <!-- PT Availability Modal -->
<div id="ptAvailModal" class="overlayModal" style="display:none;">
  <div class="modalCard">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-weight:900;">Add availability</div>
      <button class="iconBtn" id="ptAvailCloseBtn" type="button">‚úï</button>
    </div>

    <div style="margin-top:12px;">
      <div class="labelRow"><span>Date</span></div>
<input id="ptAvailDate" type="date" style="width:100%;" disabled />
<div style="margin-top:6px; font-size:12px; color:rgba(255,255,255,.65);">
  Date is selected from the calendar above.
</div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
      <div>
        <div class="labelRow"><span>Start</span></div>
        <input id="ptAvailStart" type="time" style="width:100%;" />
      </div>
      <div>
        <div class="labelRow"><span>End</span></div>
        <input id="ptAvailEnd" type="time" style="width:100%;" />
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="labelRow"><span>Note (optional)</span></div>
      <input id="ptAvailNote" placeholder="e.g. Zoom only" style="width:100%;" />
    </div>

    <button class="pillBtn" id="ptAvailSaveBtn" type="button" style="width:100%; justify-content:center; margin-top:12px;">
      Save
    </button>

    <div id="ptAvailMsg" style="margin-top:10px; color:rgba(255,255,255,.75); font-size:12px;"></div>
  </div>
</div>
<!-- PT Availability Calendar Modal -->
<div id="ptCalModal" class="overlayModal" style="display:none;">
  <div class="modalCard">
    <div class="modalHeader">
      <div style="font-weight:900;">Availability Calendar</div>
      <button class="iconBtn" id="ptCalCloseBtn" type="button">‚úï</button>
    </div>

    <div class="calTop">
      <button class="pillBtn" id="ptCalPrev" type="button">‚Äπ</button>
      <div class="calMonth" id="ptCalMonthLabel">‚Äî</div>
      <button class="pillBtn" id="ptCalNext" type="button">‚Ä∫</button>
    </div>

    <div class="calWeekdays">
      <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
    </div>

    <div class="calGrid" id="ptCalGrid"></div>

    <div style="margin-top:14px; display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div>
        <div id="ptCalSelectedLabel" style="font-weight:850;">Slots</div>
        <div class="small" style="margin-top:4px;">Pick a day, then add time slots.</div>
      </div>
      <button class="pillBtn" id="ptCalAddSlotBtn" type="button">+ Add slot</button>
    </div>

    <div id="ptCalDaySlots" style="margin-top:10px;"></div>
  </div>
</div>  

    <!-- PT Alert Modal -->
<div id="ptAlertModal" class="overlayModal">
  <div class="modalCard">
    <div class="modalHeader">
      <div>
        <div id="ptAlertTitle" style="font-weight:900;">Alert</div>
        <div id="ptAlertSub" class="sub"></div>
      </div>
      <button id="ptAlertCloseBtn" class="iconBtn" type="button">Close</button>
    </div>
    <div id="ptAlertBody" style="color:rgba(255,255,255,.88); font-size:14px; line-height:1.35; margin-top:10px;"></div>
    <div class="btnRow" style="margin-top:12px;">
      <button class="btn primary" id="ptAlertResolveBtn" type="button">Mark Reviewed</button>
    </div>
  </div>
</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, signOut
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore,
      collection, doc, getDocs, getDoc, setDoc, addDoc, deleteDoc, updateDoc,
      query, orderBy, onSnapshot, limit,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmgTapl6qs29Cdr_WlNOKTq_yttO9kqW8",
      authDomain: "on-pointe-prevention.firebaseapp.com",
      projectId: "on-pointe-prevention",
      storageBucket: "on-pointe-prevention.firebasestorage.app",
      messagingSenderId: "235349964683",
      appId: "1:235349964683:web:0b1a3b3e494bd86fc0a18e"
    };

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);

    const $ = (id) => document.getElementById(id);
    // ---------- SAFE UI HELPERS (prevents "everything disappeared") ----------
function setText(id, text){
  const el = $(id);
  if(!el){
    console.warn(`[ui] Missing #${id} (skipping setText)`);
    return false;
  }
  el.textContent = text ?? "";
  return true;
}
function setHTML(id, html){
  const el = $(id);
  if(!el){
    console.warn(`[ui] Missing #${id} (skipping setHTML)`);
    return false;
  }
  el.innerHTML = html ?? "";
  return true;
}
function show(id){
  const el = $(id);
  if(!el){
    console.warn(`[ui] Missing #${id} (skipping show)`);
    return false;
  }
  el.style.display = "";
  return true;
}
function hide(id){
  const el = $(id);
  if(!el){
    console.warn(`[ui] Missing #${id} (skipping hide)`);
    return false;
  }
  el.style.display = "none";
  return true;
}

    const fmt1 = (n) => (Math.round(n * 10) / 10).toFixed(1);
    const todayISO = () => new Date().toISOString().slice(0,10);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1300);
    }
    function prettyDate(iso){
      try{
        const d = new Date(iso + "T00:00:00");
        return d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" });
      }catch(e){ return iso; }
    }
    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function applyRoleTabs(role){
  const tabCheckin  = document.querySelector('.tab[data-tab="checkin"]');
  const tabDancers  = document.querySelector('.tab[data-tab="dancers"]');
  const tabHistory  = document.querySelector('.tab[data-tab="history"]');

  if(role === "pt"){
    if(tabCheckin) tabCheckin.style.display = "none";
    if(tabHistory) tabHistory.style.display = "none"; // optional
    if(tabDancers) tabDancers.style.display = "";
  } else {
    if(tabCheckin) tabCheckin.style.display = "";
    if(tabHistory) tabHistory.style.display = "";
    if(tabDancers) tabDancers.style.display = "none";
  }
}
// ---------- Cloud Functions caller ----------
const REGION = "us-central1";
const PROJECT = "on-pointe-prevention";
const FN_BASE = `https://${REGION}-${PROJECT}.cloudfunctions.net`;

async function callFn(path, method = "GET", body = null, query = null){
  if(!auth.currentUser) throw new Error("Not logged in");

  const token = await auth.currentUser.getIdToken();

  // Build base URL
  let url = `${FN_BASE}/${path}`;

  // Append query params safely (works even if path already contains ?)
  if(query && typeof query === "object"){
    const qs = new URLSearchParams();
    for(const [k,v] of Object.entries(query)){
      if(v !== undefined && v !== null) qs.set(k, String(v));
    }
    const s = qs.toString();
    if(s){
      url += (url.includes("?") ? "&" : "?") + s;
    }
  }

  const opts = {
    method,
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    }
  };
  if(body) opts.body = JSON.stringify(body);

  console.log("FN CALL:", method, url, body || null);

  let res;
  try{
    res = await fetch(url, opts);
  }catch(err){
    console.error("FETCH FAILED:", err);
    throw new Error("Network/CORS blocked the request. Fix Functions CORS (see section B).");
  }

  let data = {};
  try{
    data = await res.json();
  }catch(e){
    // If function returns non-JSON (or empty), keep data {}
  }

  if(!res.ok){
    const msg = data?.error || `Request failed (${res.status})`;
    throw new Error(msg);
  }

  return data;
}
    
async function refreshMyDancersUI(){
  if(!currentUser) return;

  const msgEl = document.getElementById("ptDancersMsg");
  const listEl = document.getElementById("ptDancersList");
   const titleEl = document.getElementById("ptDancerTitle");
  const subEl = document.getElementById("ptDancerSub");
  const checkinsEl = document.getElementById("ptCheckinsList");

  if(msgEl) msgEl.textContent = "Loading dancers‚Ä¶";
  if(listEl) listEl.innerHTML = "";
  if(titleEl) titleEl.textContent = "Select a dancer";
  if(subEl) subEl.textContent = "Their recent check-ins will appear here.";
  if(checkinsEl) checkinsEl.innerHTML = "";

  window.ptDancerNameMap = window.ptDancerNameMap || {};

  try{
    const r = await callFn("getMyDancers", "GET");
    const dancers = r?.data?.dancers || [];

    if(!Array.isArray(dancers) || dancers.length === 0){
      if(msgEl) msgEl.textContent = "No dancers linked yet.";
      if(checkinsEl) checkinsEl.innerHTML = "";
      return;
    }

    dancers.forEach(d=>{
      if(d?.dancerId) window.ptDancerNameMap[d.dancerId] = d.name || d.email || d.dancerId;
    });

    if(msgEl) msgEl.textContent = `Connected: ${dancers.length}`;

    let html = "";
    for(const d of dancers){
      const dancerId = d.dancerId || "";
      const name = d.name || d.email || dancerId;

      html += `
        <div class="row">
          <div class="rowMain">
            <div class="rowTitle">${escapeHTML(name)}</div>
            <div class="rowSub">${escapeHTML(dancerId)}</div>
          </div>
          <div class="rowRight">
            <button class="iconBtn" type="button" data-open-dancer="${escapeHTML(dancerId)}">Open</button>
          </div>
        </div>
      `;
    }
    if(listEl) listEl.innerHTML = html;

    // ‚úÖ event delegation: one listener, always works
    if(listEl && !listEl.dataset.bound){
      listEl.dataset.bound = "1";
      listEl.addEventListener("click", async (e)=>{
        const btn = e.target.closest("[data-open-dancer]");
        if(!btn) return;
        e.preventDefault();

        const dancerId = btn.getAttribute("data-open-dancer");
        if(!dancerId) return;

        const dancerName = window.ptDancerNameMap?.[dancerId] || dancerId;
        if(titleEl) titleEl.textContent = dancerName || "Dancer";
        if(subEl) subEl.textContent = "Loading recent check-ins‚Ä¶";
        if(checkinsEl) checkinsEl.innerHTML = `<div class="rowSub">Loading‚Ä¶</div>`;
        
        try{
          const rr = await callFn("getDancerRecentCheckins", "GET", null, { dancerId, limit: 12 });
          const items = Array.isArray(rr?.items) ? rr.items : [];

          if(!checkinsEl) return;

          if(items.length === 0){
            checkinsEl.innerHTML = `<div class="rowSub">No check-ins yet for this dancer.</div>`;
            if(subEl) subEl.textContent = "No recent check-ins.";
            return;
          }

          let out = "";
          items.forEach(it=>{
            const load = computeSessionLoad(it);
            out += `
              <div class="row" data-pt-open="${escapeHTML(dancerId)}|${escapeHTML(it.date || "")}">
                <div class="rowMain">
                  <div class="rowTitle">${escapeHTML(shortDate(it.date || ""))} ¬∑ ${it.minutes || 0} min ¬∑ RPE ${it.rpe || 0} ¬∑ Load ${load}</div>
                  <div class="rowSub">${escapeHTML((it.notes || "").slice(0,120))}</div>
                </div>
                <div class="rowRight"><button class="iconBtn" type="button">Open</button></div>
              </div>
            `;
          });
          if(subEl) subEl.textContent = "Recent check-ins.";
          checkinsEl.innerHTML = out;
          
          checkinsEl.querySelectorAll("[data-pt-open]").forEach(row=>{
            row.addEventListener("click", ()=>{
              const key = row.getAttribute("data-pt-open") || "";
              const [did, date] = key.split("|");
              const entry = items.find(x => String(x.date||"") === String(date||""));
              if(entry) openPtCheckinModal({ ...entry, dancerId: did });
            });
          });

        }catch(err){
          console.error(err);
          if(checkinsEl) checkinsEl.innerHTML = `<div class="rowSub">Failed to load dancer check-ins.</div>`;
          if(subEl) subEl.textContent = "Failed to load check-ins.";
        }
      });
    }

  }catch(e){
    console.error(e);
    if(msgEl) msgEl.textContent = `Error: ${e.message || "Failed"}`;
  }
}

// ---------- Linking UI ----------
async function initLinkingUI(){
    console.log("[linking] initLinkingUI() start", {
    currentUser: !!currentUser,
    uid: currentUser?.uid
  });
  if(!currentUser) return;

  console.log("[linking] DOM check", {
    linkCard: !!document.getElementById("linkCard"),
    dancerLinkUI: !!document.getElementById("dancerLinkUI"),
    ptLinkUI: !!document.getElementById("ptLinkUI"),
    linkSub: !!document.getElementById("linkSub")
  });
  if(!currentUser) return;

  // --- Get role first ---
  let role = "dancer";
  let uSnap = null;
  try{
    uSnap = await getDoc(doc(db, "users", currentUser.uid));
    role = uSnap.exists() ? (uSnap.data().role || "dancer") : "dancer";
  }catch(e){
    console.error("[linking] Failed to read user role:", e);
  }

  // --- Role-based tabs (PT hides checkin/history, shows dancers) ---
  const tabCheckin = document.querySelector('.tab[data-tab="checkin"]');
  const tabDancers = document.querySelector('.tab[data-tab="dancers"]');
  const tabHistory = document.querySelector('.tab[data-tab="history"]');

  if(role === "pt"){
    if(tabCheckin) tabCheckin.style.display = "none";
    if(tabHistory) tabHistory.style.display = "none";
    if(tabDancers) tabDancers.style.display = "";
  }else{
    if(tabCheckin) tabCheckin.style.display = "";
    if(tabHistory) tabHistory.style.display = "";
    if(tabDancers) tabDancers.style.display = "none";
  }

  // --- Link card + UIs ---
  const card = $("linkCard");
  if(!card) return;

  const dancerUI = $("dancerLinkUI");
  const ptUI = $("ptLinkUI");
  const linkSub = $("linkSub");

  // Don‚Äôt hard-fail if the other role‚Äôs DOM is missing
  card.style.display = "";
  if(dancerUI) dancerUI.style.display = (role === "dancer") ? "" : "none";
  if(ptUI) ptUI.style.display = (role === "pt") ? "" : "none";

  // Must exist for both roles to show the subtitle
  if(!linkSub){
    console.warn("[linking] Missing #linkSub");
  }

  // ---------- DANCER ----------
  if(role === "dancer"){
    const linkMsg   = $("linkMsg");
    const codeInput = $("ptLinkCode");
    const linkBtn   = $("linkToPtBtn");
    const unlinkBtn = $("unlinkBtn");

    if(!dancerUI || !linkMsg || !codeInput || !linkBtn){
      console.warn("[linking] Missing dancer linking DOM elements", {
        dancerUI: !!dancerUI, linkMsg: !!linkMsg, codeInput: !!codeInput, linkBtn: !!linkBtn
      });
      return;
    }

    linkSub.textContent = "Connect to your PT to share progress and receive guidance.";

    // Default UI state
    linkMsg.textContent = "Checking link‚Ä¶";
    codeInput.value = "";
    codeInput.disabled = false;
    linkBtn.disabled = false;
    if(unlinkBtn) unlinkBtn.style.display = "none";

    // Check existing link
    let ptId = null;
    try{
      const r = await callFn("getMyPt", "GET");
      ptId = r.data?.ptId || r.ptId || null;
    }catch(e){
      ptId = null;
    }

    const setUnlinkedUI = ()=>{
      linkMsg.textContent = "Not linked yet.";
      codeInput.disabled = false;
      linkBtn.disabled = false;
      if(unlinkBtn) unlinkBtn.style.display = "none";
    };

    const setLinkedUI = async (id)=>{
      try{
        const ptSnap = await getDoc(doc(db, "users", id));
        const ptData = ptSnap.exists() ? ptSnap.data() : null;
        const ptLabel = (ptData?.name || ptData?.email || id);
        linkMsg.textContent = `Linked ‚úì PT: ${ptLabel}`;
      }catch(e){
        linkMsg.textContent = `Linked ‚úì PT: ${id}`;
      }
      codeInput.disabled = true;
      linkBtn.disabled = true;
      if(unlinkBtn) unlinkBtn.style.display = "";
    };

    if(!ptId) setUnlinkedUI();
    else await setLinkedUI(ptId);

    // Link action
    linkBtn.onclick = async ()=>{
      const code = (codeInput.value || "").trim();
      if(!code){ linkMsg.textContent = "Enter a code first."; return; }

      linkMsg.textContent = "Linking‚Ä¶";
      linkBtn.disabled = true;

      try{
        const r = await callFn("linkWithPtCode", "POST", { code });
        const newPtId = r.data?.ptId || r.ptId || null;
        if(!newPtId) throw new Error("No PT id returned.");

        await setLinkedUI(newPtId);
        await loadDancerChat();
      }catch(e){
        linkMsg.textContent = `Error: ${e.message}`;
        linkBtn.disabled = false;
      }
    };

    // Unlink action
    if(unlinkBtn){
      unlinkBtn.onclick = async ()=>{
        if(!confirm("Unlink from your PT?")) return;

        unlinkBtn.disabled = true;
        unlinkBtn.textContent = "Unlinking‚Ä¶";

        try{
          await callFn("unlinkFromPt", "POST");
          toast("Unlinked ‚úì");
          unlinkBtn.disabled = false;
          unlinkBtn.textContent = "Unlink from PT";
          setUnlinkedUI();
          await loadDancerChat();
        }catch(e){
          unlinkBtn.disabled = false;
          unlinkBtn.textContent = "Unlink from PT";
          linkMsg.textContent = `Error: ${e.message}`;
        }
      };
    }

    return; // done
  }

  // ---------- PT ----------
  if(role === "pt"){
    const myPtCodeEl = $("myPtCode");
    const ptCodeMsg  = $("ptCodeMsg");
    const regenBtn   = $("regenPtCodeBtn");

    if(!ptUI || !myPtCodeEl || !ptCodeMsg || !regenBtn){
      console.warn("[linking] Missing PT linking DOM elements", {
        ptUI: !!ptUI, myPtCode: !!myPtCodeEl, ptCodeMsg: !!ptCodeMsg, regenBtn: !!regenBtn
      });
      return;
    }

    linkSub.textContent = "Share your code with your dancers to connect them to your care.";

    const existing = (uSnap && uSnap.exists()) ? (uSnap.data().ptCode || "") : "";
    if(existing){
      myPtCodeEl.textContent = existing;
      ptCodeMsg.textContent = "";
    }else{
      ptCodeMsg.textContent = "Generating code‚Ä¶";
      try{
        const r = await callFn("generatePtCode", "POST");
        myPtCodeEl.textContent = r.code;
        ptCodeMsg.textContent = "";
      }catch(e){
        ptCodeMsg.textContent = `Error: ${e.message}`;
      }
    }

    regenBtn.onclick = async ()=>{
      ptCodeMsg.textContent = "Generating‚Ä¶";
      try{
        const r = await callFn("generatePtCode", "POST");
        myPtCodeEl.textContent = r.code;
        ptCodeMsg.textContent = "New code generated ‚úì";
      }catch(e){
        ptCodeMsg.textContent = `Error: ${e.message}`;
      }
    };

    // Optional: ensure PT lands on dancers tab once UI is ready
    if(typeof setTab === "function") setTab("dancers");
  }
}
    
    /***********************
     * FIRESTORE PATHS
     ***********************/
    let currentUser = null;
    let currentRole = "dancer"; // "dancer" or "pt"

    const userDocRef = (uid)=> doc(db, "users", uid);
    const checkinsCol  = (uid)=> collection(db, "users", uid, "checkins");
    const checkinDoc   = (uid, dateISO)=> doc(db, "users", uid, "checkins", dateISO);

    const exercisesCol = (uid)=> collection(db, "users", uid, "exercises");
    const exerciseDoc  = (uid, exId)=> doc(db, "users", uid, "exercises", exId);

    const threadDoc = (threadId)=> doc(db, "messageThreads", threadId);
    const threadMessagesCol = (threadId)=> collection(db, "messageThreads", threadId, "messages");

    let activeChatPartnerId = null;
    let activeChatPartnerName = "";
    let activeThreadId = null;
    let chatUnsub = null;

    function makeId(){
      // simple unique id (good enough for Firestore doc id)
      return "ex_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
async function loadCurrentRole(){
  if(!currentUser){
    currentRole = "dancer";
    return currentRole;
  }

  try{
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    currentRole = snap.exists()
      ? (snap.data().role || "dancer")
      : "dancer";
  }catch(e){
    console.error("[role] failed to load role", e);
    currentRole = "dancer";
  }

  return currentRole;
}

async function ensureUserProfile(uid, email, role=null, name=null){
  const ref = doc(db, "users", uid);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref, {
      email: email || "",
      role: role || null,      // role will be set in Finish Setup
      name: name || "",        // <-- REQUIRED: /users/{uid}.name
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    });
    return;
  }

  const data = snap.data() || {};
  const patch = {};

  if(!data.email && email) patch.email = email;

  // Only set role if explicitly provided (don‚Äôt overwrite an existing role)
  if(!data.role && role) patch.role = role;

  // Only set name if explicitly provided AND not already present
  if((!data.name || !String(data.name).trim()) && name) patch.name = name;

  if(Object.keys(patch).length){
    patch.updatedAt = serverTimestamp();
    await updateDoc(ref, patch);
  }
}

/***********************
 * DATA CACHE
 ***********************/
let cachedCheckins = [];
let cachedExercises = []; // merged defaults + user custom (and stored in Firestore)

// exercise UI state
let selectedCategory = "All";
let exSearchQuery = "";
let showFavoritesOnly = false;

// favorites (per user)
let favoriteExerciseIds = new Set();
function favKey(uid){ return "opp_favs_" + uid; }
function loadFavorites(uid){
  try{
    const raw = localStorage.getItem(favKey(uid)) || "[]";
    const arr = JSON.parse(raw);
    favoriteExerciseIds = new Set(Array.isArray(arr) ? arr : []);
  }catch(e){
    favoriteExerciseIds = new Set();
  }
}
function saveFavorites(uid){
  try{
    localStorage.setItem(favKey(uid), JSON.stringify(Array.from(favoriteExerciseIds)));
  }catch(e){}
}
function isFav(exId){ return favoriteExerciseIds.has(exId); }
function toggleFav(exId){
  if(isFav(exId)) favoriteExerciseIds.delete(exId);
  else favoriteExerciseIds.add(exId);
  if(currentUser) saveFavorites(currentUser.uid);
}

/***********************
 * ROUTINES (per user, localStorage)
 ***********************/
let cachedRoutines = []; // [{id, name, exerciseIds:[]}]
let routineEditingId = null;
let routineSelectedIds = new Set();

function routinesKey(uid){ return "opp_routines_" + uid; }
function loadRoutines(uid){
  try{
    const raw = localStorage.getItem(routinesKey(uid)) || "[]";
    const arr = JSON.parse(raw);
    cachedRoutines = Array.isArray(arr) ? arr : [];
  }catch(e){
    cachedRoutines = [];
  }
}
function saveRoutines(uid){
  try{
    localStorage.setItem(routinesKey(uid), JSON.stringify(cachedRoutines || []));
  }catch(e){}
}
function makeRoutineId(){
  return "rt_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function getRoutineById(id){
  return (cachedRoutines || []).find(r=> r && r.id === id) || null;
}
function upsertRoutine(uid, routine){
  const r = routine || {};
  if(!r.id) r.id = makeRoutineId();
  if(!r.name) r.name = "Routine";
  if(!Array.isArray(r.exerciseIds)) r.exerciseIds = [];

  const idx = (cachedRoutines || []).findIndex(x=> x.id === r.id);
  if(idx >= 0) cachedRoutines[idx] = r;
  else cachedRoutines.push(r);

  cachedRoutines.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  saveRoutines(uid);
}
function deleteRoutineById(uid, id){
  cachedRoutines = (cachedRoutines || []).filter(r=> r.id !== id);
  saveRoutines(uid);
}

    /***********************
     * DEFAULT (DANCER-SPECIFIC) EXERCISES
     * Each has a defaultRx string that we can pre-fill in check-in.
     ***********************/
const DEFAULT_EXERCISES = [
  // ===== Your current defaults (kept) =====
  {
    id:"default_calf_iso_ecc",
    source:"default",
    category:"Foot/Ankle",
    name:"Calf Capacity (Isometric + Eccentric)",
    focus:"Achilles/pointe/jumps ¬∑ ankle load tolerance",
    defaultRx:"Isometric 3√ó30‚Äì45s + Eccentric 3√ó8‚Äì12 (3‚Äì4s down)",
    how:[
      "Isometric: single-leg calf hold mid-range, pain ‚â§3/10.",
      "Eccentric: slow lower off a step, use both legs to rise if needed.",
      "Progress: add load (backpack) ‚Üí bigger range ‚Üí pogo hops."
    ],
    cues:["Tripod foot","Control the lowering","No collapsing arch"]
  },
  {
    id:"default_foot_intrinsic",
    source:"default",
    category:"Foot/Ankle",
    name:"Intrinsic Foot (Short Foot / Doming)",
    focus:"Arch control ¬∑ turnout/pointe alignment",
    defaultRx:"3√ó8‚Äì12 holds (5‚Äì8s) or 3√ó10 slow reps",
    how:[
      "Gently draw the ball of foot toward heel without curling toes.",
      "Start seated ‚Üí progress to standing ‚Üí single-leg ‚Üí relev√©."
    ],
    cues:["Toes long","Weight evenly through tripod","Small controlled movement"]
  },
  {
    id:"default_tib_post",
    source:"default",
    category:"Foot/Ankle",
    name:"Tibialis Posterior + Inversion Control",
    focus:"Medial ankle support ¬∑ pronation control",
    defaultRx:"3√ó12‚Äì15 banded inversion (slow) or 3√ó30s isometric",
    how:[
      "Band around forefoot, pull inward slowly, control return.",
      "Keep knee stacked; don‚Äôt rotate hip to cheat."
    ],
    cues:["Move at ankle","Slow eccentric","Maintain arch"]
  },
  {
    id:"default_hip_abd",
    source:"default",
    category:"Hip/Core",
    name:"Hip Abductors (Side Plank + Clamshell)",
    focus:"Pelvic control ¬∑ single-limb stability",
    defaultRx:"Side plank 3√ó20‚Äì30s + Clamshell 3√ó12‚Äì15",
    how:[
      "Side plank knees ‚Üí feet as tolerated.",
      "Clamshell: slow reps, add band when easy."
    ],
    cues:["Ribs down","Stack pelvis","Control knee alignment"]
  },
  {
    id:"default_stepdown",
    source:"default",
    category:"Strength",
    name:"Step-Down (Single-Leg Control)",
    focus:"Knee/hip alignment ¬∑ landing mechanics",
    defaultRx:"3√ó6‚Äì10 each side (3s down)",
    how:[
      "Slow lower, light heel tap, return‚Äîno bounce.",
      "Progress: higher step, add load, add reach."
    ],
    cues:["Knee over 2nd toe","Quiet pelvis","No trunk sway"]
  },
  {
    id:"default_single_leg_rdl",
    source:"default",
    category:"Strength",
    name:"Single-Leg RDL (Hinge Control)",
    focus:"Hamstrings/glutes ¬∑ hip hinge for jumps & decel",
    defaultRx:"3√ó6‚Äì10 each side (slow tempo)",
    how:[
      "Hinge at hip, slight knee bend, keep pelvis square.",
      "Progress: add load, reach to targets, tempo."
    ],
    cues:["Long spine","Hips square","Feel hamstrings"]
  },
  {
    id:"default_jump_landing",
    source:"default",
    category:"Plyometrics",
    name:"Landing Mechanics (Drop Landing / Stick)",
    focus:"Impact control ¬∑ plyometric readiness",
    defaultRx:"3√ó3‚Äì6 reps (stick 2‚Äì3s), 60‚Äì90s rest",
    how:[
      "Step off low box, land quietly, hold position.",
      "Progress: higher box ‚Üí repeated hops ‚Üí directional."
    ],
    cues:["Quiet landing","Knee tracks over toes","Abs engaged"]
  },
  {
    id:"default_core_pallof",
    source:"default",
    category:"Hip/Core",
    name:"Core Anti-Rotation (Dead Bug / Pallof)",
    focus:"Lumbar load management ¬∑ spotting/turns",
    defaultRx:"Dead bug 3√ó6‚Äì10 + Pallof 3√ó10‚Äì12 each side",
    how:[
      "Dead bug: keep ribs down and pelvis neutral.",
      "Pallof: press out, don‚Äôt rotate."
    ],
    cues:["Breathe","Slow + controlled","No rib flare"]
  },
  {
    id:"default_thoracic",
    source:"default",
    category:"Mobility",
    name:"Thoracic Mobility (Open Books / Foam Roll)",
    focus:"Upper body lines ¬∑ port de bras ¬∑ spotting",
    defaultRx:"2‚Äì3√ó6‚Äì10 per side or 3√ó45‚Äì60s",
    how:[
      "Open books: rotate through upper back, not low back.",
      "Foam roll: gentle extensions over roller."
    ],
    cues:["Move through T-spine","Neck relaxed","Control range"]
  },
  {
    id:"default_turnout_iso",
    source:"default",
    category:"Turnout/Technique",
    name:"Turnout Control (Hip ER Isometric)",
    focus:"Deep hip ER ¬∑ turnout without pronation",
    defaultRx:"3√ó20‚Äì30s holds each side",
    how:[
      "Seated: press knee outward against band/towel without moving pelvis.",
      "Progress to standing turnout holds in parallel ‚Üí first."
    ],
    cues:["Pelvis neutral","No arch collapse","Feel deep hip"]
  },

  // ===== NEW DEFAULTS (PT-guided dancer set) =====

  // --- Foot/Ankle ---
  {
    id:"default_tib_ant",
    source:"default",
    category:"Foot/Ankle",
    name:"Tibialis Anterior Raises (Wall / Band)",
    focus:"Shin control ¬∑ landing decel ¬∑ ankle stiffness",
    defaultRx:"3√ó12‚Äì20 slow reps",
    how:[
      "Stand with back on wall, heels down, lift toes toward shins.",
      "Control down slowly; don‚Äôt rock through hips."
    ],
    cues:["Heels heavy","Toes up evenly","Slow return"]
  },
  {
    id:"default_peroneals",
    source:"default",
    category:"Foot/Ankle",
    name:"Peroneals / Eversion Control (Band)",
    focus:"Lateral ankle stability ¬∑ cutting/side travel",
    defaultRx:"3√ó12‚Äì15 slow reps or 3√ó20s holds",
    how:[
      "Band around forefoot, move foot outward (eversion), control back.",
      "Keep knee still; move at ankle."
    ],
    cues:["Move at ankle","Control eccentric","No knee sway"]
  },
  {
    id:"default_balance_star",
    source:"default",
    category:"Foot/Ankle",
    name:"Single-Leg Balance + Star Reach",
    focus:"Proprioception ¬∑ ankle/hip control for landings",
    defaultRx:"2‚Äì3√ó5 reaches each direction per side",
    how:[
      "Stand tall on one leg and reach the other foot forward/side/back.",
      "Keep pelvis level; reach lightly and return."
    ],
    cues:["Tripod foot","Pelvis level","Soft knee"]
  },

  // --- Knee / Landing ---
  {
    id:"default_spanish_squat",
    source:"default",
    category:"Strength",
    name:"Spanish Squat (Quad Tendon-Friendly)",
    focus:"Patellar tendon/knee pain ¬∑ quad strength",
    defaultRx:"4√ó30‚Äì45s holds (or 3√ó8‚Äì12 slow reps)",
    how:[
      "Anchor a strap/band behind knees, sit back into squat.",
      "Keep torso tall; pain should stay ‚â§3/10."
    ],
    cues:["Shins near vertical","Sit back","Even pressure"]
  },
  {
    id:"default_split_squat_iso",
    source:"default",
    category:"Strength",
    name:"Split Squat Isometric (Mid-Range)",
    focus:"Knee/hip control ¬∑ decel capacity",
    defaultRx:"3√ó20‚Äì40s each side",
    how:[
      "Find a stable split stance, drop to mid-range, hold steady.",
      "Progress by adding load or longer holds."
    ],
    cues:["Front knee tracks","Ribs stacked","Even weight"]
  },
  {
    id:"default_lateral_stepdown",
    source:"default",
    category:"Strength",
    name:"Lateral Step-Down (Hip Control)",
    focus:"Glute med control ¬∑ valgus prevention",
    defaultRx:"3√ó6‚Äì10 each side (slow down, light tap)",
    how:[
      "Stand on a step, lower opposite heel to tap lightly.",
      "Keep pelvis level; return without bouncing."
    ],
    cues:["Pelvis level","Knee over toes","Slow lower"]
  },

  // --- Hip/Core / Turnout ---
  {
    id:"default_bridge_march",
    source:"default",
    category:"Hip/Core",
    name:"Bridge March (Pelvic Stability)",
    focus:"Posterior chain ¬∑ pelvic control for single-leg",
    defaultRx:"3√ó8‚Äì12 marches per side",
    how:[
      "Bridge up, keep pelvis still, lift one knee toward chest and lower.",
      "Avoid rib flare or hip drop."
    ],
    cues:["Ribs down","Pelvis quiet","Squeeze glutes"]
  },
  {
    id:"default_side_plank_abd",
    source:"default",
    category:"Hip/Core",
    name:"Side Plank + Top Leg Abduction",
    focus:"Glute med endurance ¬∑ lateral line strength",
    defaultRx:"3√ó6‚Äì10 lifts each side (or 20‚Äì30s hold)",
    how:[
      "Hold side plank, lift top leg slightly with control.",
      "Modify: knees down if needed."
    ],
    cues:["Stack shoulders/hips","Don‚Äôt rotate","Slow lift"]
  },
  {
    id:"default_turnout_control_releve",
    source:"default",
    category:"Turnout/Technique",
    name:"Turnout Control in Relev√© (Small Range)",
    focus:"Turnout maintenance without foot collapse",
    defaultRx:"2‚Äì3√ó6‚Äì10 slow reps or 3√ó20s holds",
    how:[
      "In parallel or 1st, rise to relev√© and hold alignment.",
      "Keep arches lifted; turnout from hip, not pronation."
    ],
    cues:["Tripod foot","Turnout from hip","No sickling"]
  },

  // --- Posterior Chain / Back ---
  {
    id:"default_copenhagen_mod",
    source:"default",
    category:"Strength",
    name:"Adductor Side Plank (Modified Copenhagen)",
    focus:"Adductors/groin ¬∑ turnout support ¬∑ knee control",
    defaultRx:"3√ó15‚Äì25s each side",
    how:[
      "Side plank with top leg supported (knee on bench/chair).",
      "Hold steady; build time before making it harder."
    ],
    cues:["Hips tall","No rotation","Breathe steadily"]
  },
  {
    id:"default_back_ext_iso",
    source:"default",
    category:"Strength",
    name:"Back Extension Isometric (Hip Hinge Hold)",
    focus:"Posterior chain endurance ¬∑ spinal load management",
    defaultRx:"3√ó20‚Äì40s holds",
    how:[
      "Hinge to a comfortable angle, keep spine long, hold.",
      "Can be done as ‚Äògood morning‚Äô position with hands on hips."
    ],
    cues:["Long spine","Hips back","Breathe"]
  },

  // --- Mobility / Recovery ---
  {
    id:"default_hip_flexor_mob",
    source:"default",
    category:"Mobility",
    name:"Hip Flexor Mobility (Half-Kneeling)",
    focus:"Hip extension ¬∑ arabesque line ¬∑ low back offload",
    defaultRx:"2√ó45‚Äì60s each side",
    how:[
      "Half-kneeling, tuck pelvis slightly, shift forward until stretch.",
      "Add gentle reach overhead for more line."
    ],
    cues:["Posterior pelvic tilt","Glute squeeze","Ribs stacked"]
  },
  {
    id:"default_ankle_dorsiflex",
    source:"default",
    category:"Mobility",
    name:"Ankle Dorsiflexion (Knee-to-Wall)",
    focus:"Pli√© depth ¬∑ landing mechanics ¬∑ ankle mobility",
    defaultRx:"2‚Äì3√ó8‚Äì12 controlled reps each side",
    how:[
      "Drive knee toward wall over toes without heel lifting.",
      "Pause at end range, return with control."
    ],
    cues:["Heel stays down","Knee tracks over toes","Slow"]
  },

  // --- Upper body (partnering + port de bras) ---
  {
    id:"default_serratus_wall_slide",
    source:"default",
    category:"Strength",
    name:"Serratus Wall Slide (Scap Control)",
    focus:"Shoulder stability ¬∑ overhead lines ¬∑ partnering",
    defaultRx:"3√ó8‚Äì12 slow reps",
    how:[
      "Forearms on wall, slide up while keeping ribs down.",
      "Feel shoulder blades rotate and wrap forward."
    ],
    cues:["Ribs down","Reach long","No shrug"]
  },
  {
    id:"default_rotator_cuff_er",
    source:"default",
    category:"Strength",
    name:"Rotator Cuff ER (Band, Elbow at Side)",
    focus:"Shoulder resilience ¬∑ partnering lifts",
    defaultRx:"3√ó12‚Äì15 each side",
    how:[
      "Elbow at side, rotate forearm out against band.",
      "Control return; avoid trunk rotation."
    ],
    cues:["Elbow pinned","Slow return","Shoulders relaxed"]
  },

  // --- Plyometrics progressions (more dance-specific) ---
  {
    id:"default_pogo_hops",
    source:"default",
    category:"Plyometrics",
    name:"Pogo Hops (Ankle Stiffness)",
    focus:"Jump prep ¬∑ Achilles tolerance ¬∑ elastic recoil",
    defaultRx:"3√ó10‚Äì20s bouts, 60‚Äì90s rest",
    how:[
      "Small quick hops, minimal knee bend, stay tall.",
      "Stop if pain increases; build time gradually."
    ],
    cues:["Quiet feet","Tall posture","Springy ankles"]
  },
  {
    id:"default_single_leg_hop_stick",
    source:"default",
    category:"Plyometrics",
    name:"Single-Leg Hop + Stick (Forward/Diagonal)",
    focus:"Return-to-jump control ¬∑ asymmetry awareness",
    defaultRx:"3√ó3‚Äì5 hops each direction per side",
    how:[
      "Hop and land quietly, stick 2 seconds, reset each rep.",
      "Keep knee aligned; start small distances."
    ],
    cues:["Stick the landing","Knee tracks","Control pelvis"]
  }
];

    /***********************
     * CHECKINS: load + metrics
     ***********************/
    function sessionLoad(entry){
      return Math.round((Number(entry.minutes)||0) * (Number(entry.rpe)||0));
    }
    function lastNDays(entries, days){
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - (days-1));
      cutoff.setHours(0,0,0,0);
      return entries.filter(e => new Date(e.date) >= cutoff);
    }
    function avgDailyLoad(entries, days){
      const total = lastNDays(entries, days).reduce((s,e)=> s + sessionLoad(e), 0);
      return total / days;
    }
function computeMetrics(entries){
  // Standard approach: 7d avg and 28d avg.
  // BUT early on, dividing by 28 when you only have a few entries makes chronic tiny,
  // which inflates ACWR and shows "HIGH" too often.
  const acute = avgDailyLoad(entries, 7);
  const chronic = avgDailyLoad(entries, 28);

  // Require meaningful history before calculating ACWR
  // - at least 10 entries OR at least 14 days since first entry
  // - and chronic must not be extremely tiny
  let acwr = null;

  if(entries && entries.length){
    const sorted = entries.slice().sort((a,b)=> (a.date < b.date ? -1 : 1));
    const first = new Date(sorted[0].date + "T00:00:00");
    const last = new Date(sorted[sorted.length-1].date + "T00:00:00");
    const spanDays = Math.round((last - first) / (1000*60*60*24)) + 1;

    const enoughHistory = (entries.length >= 10) || (spanDays >= 14);

    // If chronic is too low, ACWR becomes meaningless noise
    const chronicOk = (chronic >= 10);

    if(enoughHistory && chronicOk){
      acwr = acute / chronic;
    }
  }

  return { acute, chronic, acwr };
}
function riskFromACWR(acwr, entriesCount){
  const n = Number(entriesCount || 0);

  // Not enough data ‚Üí baseline phase
  if(n < 10){
    return { cls:"ok", label:"BASELINE" };
  }

  if(acwr === null || !isFinite(acwr)){
    return { cls:"ok", label:"BASELINE" };
  }

  if(acwr < 0.8){
    return { cls:"caution", label:"LOW" };
  }

  if(acwr <= 1.3){
    return { cls:"ok", label:"OK" };
  }

  if(acwr <= 1.5){
    return { cls:"caution", label:"CAUTION" };
  }

  return { cls:"high", label:"HIGH" };
}
function guidanceText(entries, metrics){
  if(!entries || entries.length === 0){
    return "Add check-ins to start building your personal load baseline.";
  }

  // Baseline-building phase
  if(entries.length < 10){
    return "Building your baseline. Early risk signals can look high until the app learns your normal training rhythm. Log consistently for ~2 weeks.";
  }

  const acwr = metrics && typeof metrics.acwr === "number" ? metrics.acwr : null;

  if(acwr === null){
    return "Keep logging daily to refine your baseline. Prioritize sleep and recovery on heavy days.";
  }

  if(acwr > 1.5){
    return "Recent load is much higher than your baseline. Protect the next 24‚Äì72h: avoid adding extra jumps or pointe volume.";
  }

  if(acwr > 1.3){
    return "Moderate increase in load. Keep rehearsal quality high and trim extra volume if fatigue rises.";
  }

  if(acwr < 0.8){
    return "Load is lower than your recent norm. Progress gradually to avoid a sudden spike.";
  }

  return "Load looks steady. Keep progressing and support recovery basics.";
}


    /***********************
     * FIRESTORE CRUD
     ***********************/
    async function loadAllCheckins(uid){
      const snaps = await getDocs(checkinsCol(uid));
      const arr = [];
      snaps.forEach(s => arr.push(s.data()));
      return arr.filter(e=>e && e.date).sort((a,b)=> (a.date < b.date ? 1 : -1));
    }

    async function upsertCheckin(uid, entry){
      await setDoc(checkinDoc(uid, entry.date), {
        ...entry,
        updatedAt: serverTimestamp()
      }, { merge:true });
    }

    async function deleteAllCheckins(uid){
      const snaps = await getDocs(checkinsCol(uid));
      const tasks = [];
      snaps.forEach(s => tasks.push(deleteDoc(s.ref)));
      await Promise.all(tasks);
    }

    async function loadUserExercises(uid){
      const snaps = await getDocs(exercisesCol(uid));
      const arr = [];
      snaps.forEach(s => arr.push(s.data()));
      return arr.filter(x=>x && x.id).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    }

    async function addUserExercise(uid, ex){
      await setDoc(exerciseDoc(uid, ex.id), {
        ...ex,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge:true });
    }

    /***********************
     * EXERCISE LIBRARY (merge defaults + user custom)
     ***********************/
    function mergeExerciseLibrary(userExercises){
      const map = new Map();
      DEFAULT_EXERCISES.forEach(ex => map.set(ex.id, ex));
      userExercises.forEach(ex => map.set(ex.id, ex));
      return Array.from(map.values()).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    }
async function refreshExercises(){
  if(!currentUser) return;

  const userExercises = await loadUserExercises(currentUser.uid);
  cachedExercises = mergeExerciseLibrary(userExercises);

  // Keep UI consistent after refresh:
  // - If the currently-selected category no longer exists, fall back to All
  if(selectedCategory && selectedCategory !== "All"){
    let exists = false;
    for(let i=0;i<cachedExercises.length;i++){
      const cat = cachedExercises[i].category || "Other";
      if(cat === selectedCategory){ exists = true; break; }
    }
    if(!exists) selectedCategory = "All";
  }

  // Rebuild chips if the container exists (wireUI defines the renderer)
  if(typeof window.__opp_renderCategoryChips === "function"){
    window.__opp_renderCategoryChips();
  }

  renderExerciseList();
}

function renderExerciseList(){
  const el = $("exerciseList");
  if(!el) return;

  el.innerHTML = "";

  if(!cachedExercises || cachedExercises.length === 0){
    el.innerHTML = `
      <div class="row">
        <div class="rowMain">
          <div class="rowTitle">No exercises found</div>
          <div class="rowSub">If this is unexpected, check Firestore rules and refresh.</div>
        </div>
      </div>`;
    return;
  }

  const q = (exSearchQuery || "").trim().toLowerCase();

  let list = cachedExercises.slice();

  if(selectedCategory && selectedCategory !== "All"){
    list = list.filter(ex => (ex.category || "Other") === selectedCategory);
  }

  if(showFavoritesOnly){
    list = list.filter(ex => isFav(ex.id));
  }

  if(q){
    list = list.filter(ex=>{
      const hay = [
        ex.name || "",
        ex.category || "",
        ex.focus || "",
        ex.defaultRx || "",
        (Array.isArray(ex.cues) ? ex.cues.join(" ") : (ex.cues || "")),
        (Array.isArray(ex.how) ? ex.how.join(" ") : (ex.how || ""))
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  list.sort((a,b)=>{
    const af = isFav(a.id) ? 0 : 1;
    const bf = isFav(b.id) ? 0 : 1;
    if(af !== bf) return af - bf;
    return (a.name || "").localeCompare(b.name || "");
  });

  if(list.length === 0){
    el.innerHTML = `
      <div class="row">
        <div class="rowMain">
          <div class="rowTitle">No matches</div>
          <div class="rowSub">Try changing category, search, or Favorites.</div>
        </div>
      </div>`;
    return;
  }

  const frag = document.createDocumentFragment();

  for(let i=0;i<list.length;i++){
    const ex = list[i];
    const row = document.createElement("div");
    row.className = "row";

    const favOn = isFav(ex.id);
    const cat = ex.category || "Other";

    row.innerHTML = `
      <div class="rowMain">
        <div class="rowTop">
          <div class="rowTitle">${escapeHTML(ex.name || "Exercise")}</div>
          <div class="rowMeta">${escapeHTML(cat)} ¬∑ ${escapeHTML(ex.focus || "")}</div>
        </div>
        <div class="rowSub">${escapeHTML(ex.defaultRx || "Tap to view details")}</div>
      </div>

      <div class="rowRight">
        <button class="iconBtn" type="button" data-fav="${ex.id}">
          ${favOn ? "‚≠ê" : "‚òÜ"}
        </button>

        <button class="iconBtn" type="button" data-open="${ex.id}">Open</button>

        ${
          ex.source === "user"
            ? `<button class="iconBtn danger" type="button" data-delete="${ex.id}">üóëÔ∏è</button>`
            : ``
        }
      </div>
    `;

    const favBtn = row.querySelector(`[data-fav="${ex.id}"]`);
    if(favBtn){
      favBtn.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        toggleFav(ex.id);
        renderExerciseList();
      });
    }

    const openBtn = row.querySelector(`[data-open="${ex.id}"]`);
    if(openBtn){
      openBtn.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        openExercise(ex);
      });
    }

    if(ex.source === "user"){
      const delBtn = row.querySelector(`[data-delete="${ex.id}"]`);
      if(delBtn){
        delBtn.addEventListener("click", async (ev)=>{
          ev.stopPropagation();
          await deleteExercise(ex);
        });
      }
    }

    row.addEventListener("click", ()=> openExercise(ex));
    frag.appendChild(row);
  }

  el.appendChild(frag);
}

function openExercise(ex){
  const cues = Array.isArray(ex.cues)
    ? ex.cues
    : (typeof ex.cues === "string" ? ex.cues.split(",").map(s=>s.trim()).filter(Boolean) : []);

  const how = Array.isArray(ex.how)
    ? ex.how
    : (typeof ex.how === "string" ? ex.how.split("\n").map(s=>s.trim()).filter(Boolean) : []);

  const cat = ex.category || "Other";
  const focus = ex.focus || "";

  $("exTitle").textContent = ex.name || "Exercise";
  $("exBody").innerHTML = `
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
      <div class="chip" style="display:inline-flex;">${escapeHTML(cat)}</div>
      ${focus ? `<div class="chip" style="display:inline-flex; opacity:.85;">${escapeHTML(focus)}</div>` : ``}
    </div>

    ${ex.defaultRx ? `
      <div class="rowSub" style="margin-top:4px;">
        <strong style="color:rgba(255,255,255,.9)">Default:</strong> ${escapeHTML(ex.defaultRx)}
      </div>` : ""}

    ${how.length ? `
      <div style="margin:14px 0 6px; font-weight:900;">How to do it</div>
      <div style="display:grid; gap:8px;">
        ${how.map(x=>`<div class="rowSub">‚Ä¢ ${escapeHTML(x)}</div>`).join("")}
      </div>` : ""}

    ${cues.length ? `
      <div style="margin:14px 0 6px; font-weight:900;">Coaching cues</div>
      <div style="display:grid; gap:8px;">
        ${cues.map(x=>`<div class="rowSub">‚Ä¢ ${escapeHTML(x)}</div>`).join("")}
      </div>` : ""}

    <div style="margin-top:16px;">
      <div class="hint">Use this exercise inside your check-in to log sets/reps.</div>
    </div>
  `;

  $("exerciseModal").classList.add("show");
}

async function deleteExercise(ex){
  if(!currentUser) { toast("Not logged in"); return; }
  if(!confirm("Delete this exercise?")) return;

  try{
    await deleteDoc(doc(db, "users", currentUser.uid, "exercises", ex.id));
    toast("Exercise deleted");

    // optional: close detail modal if it was open
    $("exerciseModal").classList.remove("show");

    await refreshExercises();
  }catch(e){
    console.error(e);
    alert("Failed to delete exercise");
  }
}
    /***********************
     * CHECK-IN EXERCISE PICKER
     * Stored in checkin.exercises = [{exerciseId, name, sets, repsOrTime, notes}]
     ***********************/
    function parseDefaultRxToSuggestion(defaultRx){
      // lightweight heuristic
      const rx = (defaultRx || "").toLowerCase();
      let sets = 3;
      let repsOrTime = "10";
      const mSets = rx.match(/(\d+)\s*√ó/);
      if(mSets) sets = Number(mSets[1]) || sets;
      const mReps = rx.match(/√ó\s*(\d+)\s*‚Äì\s*(\d+)/) || rx.match(/√ó\s*(\d+)\s*-\s*(\d+)/);
      if(mReps) repsOrTime = `${mReps[1]}-${mReps[2]}`;
      const mReps2 = rx.match(/√ó\s*(\d+)/);
      if(!mReps && mReps2) repsOrTime = `${mReps2[1]}`;
      const mSec = rx.match(/(\d+)\s*‚Äì\s*(\d+)\s*s/) || rx.match(/(\d+)\s*-\s*(\d+)\s*s/);
      if(mSec) repsOrTime = `${mSec[1]}-${mSec[2]}s`;
      const mSec2 = rx.match(/(\d+)\s*s/);
      if(!mSec && mSec2) repsOrTime = `${mSec2[1]}s`;
      return { sets, repsOrTime };
    }

    function getCheckinPicked(){
      try{
        return JSON.parse($("checkinForm").dataset.picked || "[]");
      }catch(e){
        return [];
      }
    }
    function setCheckinPicked(arr){
      $("checkinForm").dataset.picked = JSON.stringify(arr || []);
      $("pickedCount").textContent = `${(arr||[]).length} selected`;
    }

    function renderExercisePicker(){
      const wrap = $("pickWrap");
      wrap.innerHTML = "";

      const picked = getCheckinPicked();
      const pickedMap = new Map(picked.map(x=>[x.exerciseId, x]));

      cachedExercises.forEach(ex=>{
        const existing = pickedMap.get(ex.id);
        const suggestion = parseDefaultRxToSuggestion(ex.defaultRx);
        const setsVal = existing ? (existing.sets ?? suggestion.sets) : suggestion.sets;
        const repsVal = existing ? (existing.repsOrTime ?? suggestion.repsOrTime) : suggestion.repsOrTime;

        const row = document.createElement("div");
        row.className = "pickRow";
        row.innerHTML = `
          <div class="pickMain">
            <p class="pickTitle">${escapeHTML(ex.name)}</p>
            <p class="pickMeta">${escapeHTML(ex.defaultRx || ex.focus || "")}</p>
          </div>
          <div class="pickRight">
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <div style="display:grid; gap:6px;">
                <div class="miniLabel">Sets</div>
                <input class="miniInput" inputmode="numeric" pattern="[0-9]*" data-sets="${ex.id}" value="${setsVal}">
              </div>
              <div style="display:grid; gap:6px;">
                <div class="miniLabel">Reps/Time</div>
                <input class="miniInput" data-reps="${ex.id}" value="${escapeHTML(String(repsVal))}">
              </div>
            </div>
            <button class="iconBtn" type="button" data-toggle="${ex.id}">
              ${existing ? "Remove" : "Add"}
            </button>
          </div>
        `;

        row.querySelector(`[data-toggle="${ex.id}"]`).addEventListener("click", ()=>{
          const nowPicked = getCheckinPicked();
          const idx = nowPicked.findIndex(x=>x.exerciseId === ex.id);

          const sets = Number(row.querySelector(`[data-sets="${ex.id}"]`).value || suggestion.sets);
          const repsOrTime = row.querySelector(`[data-reps="${ex.id}"]`).value || suggestion.repsOrTime;

          if(idx >= 0){
            nowPicked.splice(idx, 1);
            setCheckinPicked(nowPicked);
            renderExercisePicker();
          }else{
            nowPicked.push({
              exerciseId: ex.id,
              name: ex.name,
              sets: isNaN(sets) ? suggestion.sets : sets,
              repsOrTime: repsOrTime,
              notes: ""
            });
            setCheckinPicked(nowPicked);
            renderExercisePicker();
          }
        });

        // update values if already selected and user edits inputs
        const setsInput = row.querySelector(`[data-sets="${ex.id}"]`);
        const repsInput = row.querySelector(`[data-reps="${ex.id}"]`);
        const syncIfSelected = ()=>{
          const nowPicked = getCheckinPicked();
          const idx = nowPicked.findIndex(x=>x.exerciseId === ex.id);
          if(idx >= 0){
            const s = Number(setsInput.value || suggestion.sets);
            nowPicked[idx].sets = isNaN(s) ? suggestion.sets : s;
            nowPicked[idx].repsOrTime = repsInput.value || suggestion.repsOrTime;
            setCheckinPicked(nowPicked);
          }
        };
        setsInput.addEventListener("input", syncIfSelected);
        repsInput.addEventListener("input", syncIfSelected);

        wrap.appendChild(row);
      });

      if(cachedExercises.length === 0){
        wrap.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No exercises yet</div><div class="rowSub">Go to Exercises tab and add your first one.</div></div></div>`;
      }
    }
async function getMyRole(){
  if(!currentUser) return "dancer";
  try{
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    return snap.exists() ? (snap.data().role || "dancer") : "dancer";
  }catch(e){
    console.error("[role] getMyRole failed", e);
    return "dancer";
  }
}
function applyRoleUI(role){
  // Tabs that are PT-only
  const ptOnlyTabs = ["dancers"];
  ptOnlyTabs.forEach(tab=>{
    const btn = document.querySelector(`.tab[data-tab="${tab}"]`);
    if(btn) btn.style.display = (role === "pt") ? "" : "none";
  });

  // PT-only cards inside dashboard (already exist in your HTML) :contentReference[oaicite:5]{index=5}
  const ptCards = ["ptAvailabilityCard","ptRecentCard","ptMessagesRosterCard"];
  ptCards.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.style.display = (role === "pt") ? "" : "none";
  });

   const dancerCards = ["smartFlagCard"];
  dancerCards.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.style.display = (role === "dancer") ? "" : "none";
  });

  // Dancer-only dashboard elements to hide for PT (keep dancer UI intact)
  const dancerOnlyIds = [
    "riskBadge","riskLabel","riskInfoBtn","riskInfoModal",
    "trendCanvas","trendHint",
    "guidanceText",
    "recentList",
    "historyList",
    "m_acute","m_chronic","m_acwr"
  ];

  dancerOnlyIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;

    // hide the whole card if possible, otherwise just the element
    const card = el.closest && el.closest(".card");
    if(role === "pt"){
      if(card) card.style.display = "none";
      else el.style.display = "none";
    } else {
      // dancer: show it back
      if(card) card.style.display = "";
      else el.style.display = "";
    }
  });

  // IMPORTANT: if we previously created a PT wrapper via JS, remove it when dancer logs in
  const wrap = document.getElementById("ptDashboardWrap");
  if(wrap && role === "dancer"){
    wrap.remove();
  }
}

/***********************
 * MESSAGING + ALERTS + SMART FLAGS
 ***********************/
let threadsUnsub = null;
let messagesUnsub = null;
let alertsUnsub = null;
let currentThreadId = null;
let currentChatDancerId = null;
let currentChatLabel = "";
let threadCache = new Map();
let ptLinkedDancersCache = [];
let ptAlertsCache = [];

function threadIdFor(ptUid, dancerUid){
  return `${ptUid}__${dancerUid}`;
}

function formatTime(ts){
  if(!ts) return "‚Äî";
  try{
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
  }catch(e){
    return "‚Äî";
  }
}

async function getLinkedPtIdForDancer(){
  if(!currentUser) return null;
  try{
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    if(snap.exists()){
      return snap.data().linkedPtId || null;
    }
  }catch(e){}
  try{
    const r = await callFn("getMyPt", "GET");
    return r?.data?.ptId || r?.ptId || null;
  }catch(e){
    return null;
  }
}

async function loadPtLinkedDancers(){
  try{
    const r = await callFn("getMyDancers", "GET");
    const dancers = Array.isArray(r?.data?.dancers) ? r.data.dancers : [];
    ptLinkedDancersCache = dancers.map(d=>({
      dancerId: d.dancerId,
      name: d.name || d.email || d.dancerId
    }));
    ptLinkedDancersCache.forEach(d=>{
      if(d?.dancerId) window.ptDancerNameMap = {
        ...(window.ptDancerNameMap || {}),
        [d.dancerId]: d.name || d.dancerId
      };
    });
  }catch(e){
    ptLinkedDancersCache = [];
  }
}

    let linkedPtProfileCache = null;

function getInitials(name){
  const parts = String(name || "")
    .trim()
    .split(/\s+/)
    .filter(Boolean);
  if(!parts.length) return "?";
  return parts.slice(0, 2).map(part => part[0].toUpperCase()).join("");
}

async function loadLinkedPtProfile(){
  const ptId = await getLinkedPtIdForDancer();
  if(!ptId){
    linkedPtProfileCache = null;
    return null;
  }
  if(linkedPtProfileCache?.id === ptId) return linkedPtProfileCache;
  try{
    const snap = await getDoc(doc(db, "users", ptId));
    const data = snap.exists() ? (snap.data() || {}) : {};
    linkedPtProfileCache = {
      id: ptId,
      name: data.name || data.email || ptId
    };
  }catch(e){
    linkedPtProfileCache = { id: ptId, name: ptId };
  }
  return linkedPtProfileCache;
}

function updateMessagesTabBadge(){
  const badge = $("messagesTabBadge");
  if(!badge) return;
  const uid = currentUser?.uid;
  if(!uid){
    badge.style.display = "none";
    return;
  }
  let total = 0;
  threadCache.forEach(t=>{
    const n = Number(t?.unreadFor?.[uid] || 0);
    total += n;
  });
  if(total > 0){
    badge.textContent = total > 99 ? "99+" : String(total);
    badge.style.display = "inline-flex";
  }else{
    badge.style.display = "none";
  }
}

function startThreadsListener(){
  if(!currentUser) return;
  if(threadsUnsub) threadsUnsub();
  const q = query(
    collection(db, "threads"),
    where("participants", "array-contains", currentUser.uid)
  );
  threadsUnsub = onSnapshot(q, (snap)=>{
    threadCache.clear();
    snap.forEach(docSnap=>{
      threadCache.set(docSnap.id, { id: docSnap.id, ...(docSnap.data() || {}) });
    });
    updateMessagesTabBadge();
    renderThreadsList();
  }, (err)=>{
    console.error("threads snapshot failed", err);
  });
}

function stopThreadsListener(){
  if(threadsUnsub) threadsUnsub();
  threadsUnsub = null;
}

function stopMessagesListener(){
  if(messagesUnsub) messagesUnsub();
  messagesUnsub = null;
}

async function renderThreadsList(){
  const list = $("messagesThreadList");
  const empty = $("messagesEmpty");
  if(!list || !empty) return;
  list.innerHTML = "";
  empty.textContent = "";

  if(!currentUser){
    empty.textContent = "Log in to view messages.";
    return;
  }

  if(currentRole === "pt"){
    if(!ptLinkedDancersCache.length){
      await loadPtLinkedDancers();
    }
    if(ptLinkedDancersCache.length === 0){
      empty.textContent = "No linked dancers yet.";
      return;
    }

    let html = "";
    ptLinkedDancersCache.forEach(d=>{
      const threadId = threadIdFor(currentUser.uid, d.dancerId);
      const thread = threadCache.get(threadId);
      const unread = Number(thread?.unreadFor?.[currentUser.uid] || 0);
      const lastMsg = thread?.lastMessage || "Start a conversation";
      const lastAt = thread?.lastAt ? formatTime(thread.lastAt) : "‚Äî";

      html += `
        <div class="row">
          <div class="threadRow">
            <div class="rowMain">
              <div class="rowTitle">${escapeHTML(d.name || "Dancer")}</div>
              <div class="threadMeta">${escapeHTML(lastMsg)}</div>
            </div>
            <div class="rowRight">
              <div class="threadMeta">${lastAt}</div>
              ${unread ? `<div class="unreadBadge">${unread}</div>` : ``}
              <button class="iconBtn" type="button" data-open-thread="${escapeHTML(d.dancerId)}">Open</button>
            </div>
          </div>
        </div>
      `;
    });
    list.innerHTML = html;
  } else {
    const ptProfile = await loadLinkedPtProfile();
    const ptId = ptProfile?.id || await getLinkedPtIdForDancer();
    if(!ptId){
      empty.textContent = "Link to a PT to message.";
      return;
    }

    const threadId = threadIdFor(ptId, currentUser.uid);
    const thread = threadCache.get(threadId);
    const unread = Number(thread?.unreadFor?.[currentUser.uid] || 0);
    const lastMsg = thread?.lastMessage || "Start a conversation";
    const lastAt = thread?.lastAt ? formatTime(thread.lastAt) : "‚Äî";
    const ptLabel = ptProfile?.name || "Your PT";
    
    list.innerHTML = `
      <div class="row">
        <div class="threadRow">
          <div class="rowMain">
            <div class="rowTitle">${escapeHTML(ptLabel)}</div>
            <div class="threadMeta">${escapeHTML(lastMsg)}</div>
          </div>
          <div class="rowRight">
            <div class="threadMeta">${lastAt}</div>
            ${unread ? `<div class="unreadBadge">${unread}</div>` : ``}
            <button class="iconBtn" type="button" data-open-thread="${escapeHTML(currentUser.uid)}">Open</button>
          </div>
        </div>
      </div>
    `;
  }

  if(!list.dataset.bound){
    list.dataset.bound = "1";
    list.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-open-thread]");
      if(!btn) return;
      const dancerId = btn.getAttribute("data-open-thread");
      if(!dancerId) return;
      if(currentRole === "pt"){
        const name = (window.ptDancerNameMap && window.ptDancerNameMap[dancerId]) || dancerId;
        openChatThread(dancerId, name);
      } else {
        const ptLabel = linkedPtProfileCache?.name || "Your PT";
        openChatThread(currentUser.uid, ptLabel);
      }
    });
  }
}

async function openChatThread(dancerId, label){
  if(!currentUser) return;
  const ptId = currentRole === "pt" ? currentUser.uid : await getLinkedPtIdForDancer();
  if(!ptId) return;

  currentChatDancerId = dancerId;
  currentChatLabel = label || "Chat";
  currentThreadId = threadIdFor(ptId, dancerId);

  $("chatTitle").textContent = currentChatLabel;
  $("chatSub").textContent = currentRole === "pt" ? "Dancer" : "Your PT";
  $("chatCard").style.display = "";

  await markThreadRead(currentThreadId);
  subscribeToMessages(currentThreadId);
}

function closeChatThread(){
  stopMessagesListener();
  currentThreadId = null;
  currentChatDancerId = null;
  $("chatCard").style.display = "none";
  $("chatMessages").innerHTML = "";
}

function subscribeToMessages(threadId){
  stopMessagesListener();
  const q = query(
    collection(db, "threads", threadId, "messages"),
    orderBy("createdAt", "asc"),
    limit(200)
  );
  messagesUnsub = onSnapshot(q, (snap)=>{
    const items = [];
    snap.forEach(docSnap=> items.push({ id: docSnap.id, ...(docSnap.data() || {}) }));
    renderMessages(items);
  }, (err)=>{
    console.error("messages snapshot failed", err);
  });
}

function renderMessages(items){
  const wrap = $("chatMessages");
  if(!wrap) return;
  if(!items || items.length === 0){
    wrap.innerHTML = `<div class="rowSub">No messages yet. Say hello.</div>`;
    return;
  }

  let html = "";
  items.forEach(m=>{
    const mine = m.senderId === currentUser.uid;
    const text = escapeHTML(m.text || "");
    const time = formatTime(m.createdAt);
    const label = mine ? "You" : (currentChatLabel || "PT");
    const initials = getInitials(label);
    html += `
      <div class="chatRow ${mine ? "me" : "them"}">
        <div class="chatAvatar" aria-hidden="true">${escapeHTML(initials)}</div>
        <div class="chatContent">
          <div class="chatBubble ${mine ? "me" : ""}">${text}</div>
          <div class="chatMeta">${escapeHTML(label)} ¬∑ ${time}${mine ? " ¬∑ Delivered" : ""}</div>
        </div>
        </div>
    `;
  });
  wrap.innerHTML = html;
  wrap.scrollTop = wrap.scrollHeight + 200;
}

async function sendChatMessage(text){
  if(!currentUser) return;
  const trimmed = (text || "").trim();
  if(!trimmed) return;
  if(!currentChatDancerId) return;
  try{
    await callFn("sendMessage", "POST", { dancerId: currentChatDancerId, text: trimmed });
  }catch(e){
    toast(e.message || "Send failed");
  }
}

async function markThreadRead(threadId){
  if(!threadId) return;
  try{
    await callFn("markThreadRead", "POST", { threadId });
  }catch(e){}
}

function startAlertsListener(){
  if(!currentUser || currentRole !== "pt") return;
  if(alertsUnsub) alertsUnsub();
  const q = query(
    collection(db, "alerts", currentUser.uid, "items"),
    orderBy("createdAt", "desc"),
    limit(20)
  );
  alertsUnsub = onSnapshot(q, (snap)=>{
    ptAlertsCache = [];
    snap.forEach(docSnap=>{
      ptAlertsCache.push({ id: docSnap.id, ...(docSnap.data() || {}) });
    });
    renderPtAlerts();
  }, (err)=>{
    console.error("alerts snapshot failed", err);
  });
}

function stopAlertsListener(){
  if(alertsUnsub) alertsUnsub();
  alertsUnsub = null;
}

function renderPtAlerts(){
  const list = $("ptAlertsList");
  const count = $("ptAlertsCountLabel");
  if(!list || !count) return;

  if(ptAlertsCache.length === 0){
    list.innerHTML = `<div class="rowSub">No alerts yet.</div>`;
    count.textContent = "0";
    return;
  }

  const unresolved = ptAlertsCache.filter(a=> !a.resolved).length;
  count.textContent = String(unresolved);

  list.innerHTML = ptAlertsCache.map(a=>{
    const severity = a.severity || "yellow";
    const dotCls = severity === "red" ? "red" : (severity === "orange" ? "orange" : "yellow");
    const dancerName = (window.ptDancerNameMap && window.ptDancerNameMap[a.dancerUid]) || a.dancerUid || "Dancer";
    const reason = Array.isArray(a.reasons) ? a.reasons.slice(0,2).join(" ¬∑ ") : "";
    const date = a.createdAt ? formatTime(a.createdAt) : "‚Äî";
    return `
      <div class="alertRow">
        <div class="rowMain">
          <div class="rowTop">
            <div class="rowTitle">${escapeHTML(dancerName)}</div>
            <div class="rowMeta">${escapeHTML(String(a.entryId || ""))}</div>
          </div>
          <div class="rowSub">${escapeHTML(reason || "View details")}</div>
        </div>
        <div class="alertActions">
          <div class="alertDot ${dotCls}"></div>
          <div class="threadMeta">${date}</div>
          <button class="iconBtn" type="button" data-alert-open="${escapeHTML(a.id)}">Open</button>
        </div>
      </div>
    `;
  }).join("");

  if(!list.dataset.bound){
    list.dataset.bound = "1";
    list.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-alert-open]");
      if(!btn) return;
      const id = btn.getAttribute("data-alert-open");
      const alert = ptAlertsCache.find(a=> a.id === id);
      if(alert) openAlertModal(alert);
    });
  }
}

function openAlertModal(alert){
  const modal = $("ptAlertModal");
  if(!modal) return;
  const title = $("ptAlertTitle");
  const sub = $("ptAlertSub");
  const body = $("ptAlertBody");
  const resolveBtn = $("ptAlertResolveBtn");

  const dancerName = (window.ptDancerNameMap && alert.dancerUid && window.ptDancerNameMap[alert.dancerUid]) || alert.dancerUid || "Dancer";
  if(title) title.textContent = `${dancerName} ¬∑ ${String(alert.severity || "").toUpperCase()}`;
  if(sub) sub.textContent = alert.entryId || "";

  const reasons = Array.isArray(alert.reasons) ? alert.reasons : [];
  const snapshot = alert.snapshot || {};

  body.innerHTML = `
    <div class="rowSub"><strong>Reasons:</strong> ${escapeHTML(reasons.join(" ¬∑ ") || "‚Äî")}</div>
    <div class="rowSub" style="margin-top:8px;"><strong>Metrics:</strong></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
      <div class="metric"><div class="k">Minutes</div><div class="v">${escapeHTML(String(snapshot.minutes ?? "‚Äî"))}</div></div>
      <div class="metric"><div class="k">RPE</div><div class="v">${escapeHTML(String(snapshot.rpe ?? "‚Äî"))}</div></div>
      <div class="metric"><div class="k">Load</div><div class="v">${escapeHTML(String(snapshot.load ?? "‚Äî"))}</div></div>
      <div class="metric"><div class="k">ACWR</div><div class="v">${escapeHTML(String(snapshot.acwr ?? "‚Äî"))}</div></div>
      <div class="metric"><div class="k">Fatigue</div><div class="v">${escapeHTML(String(snapshot.fatigue ?? "‚Äî"))}</div></div>
      <div class="metric"><div class="k">Soreness</div><div class="v">${escapeHTML(String(snapshot.sore ?? "‚Äî"))}</div></div>
    </div>
    <div class="rowSub" style="margin-top:10px;"><strong>Notes:</strong> ${escapeHTML(snapshot.notes || "‚Äî")}</div>
  `;

  if(resolveBtn){
    resolveBtn.disabled = !!alert.resolved;
    resolveBtn.textContent = alert.resolved ? "Reviewed ‚úì" : "Mark Reviewed";
    resolveBtn.onclick = async ()=>{
      try{
        await callFn("markAlertResolved", "POST", { alertId: alert.id });
        toast("Alert marked reviewed");
      }catch(e){
        toast("Failed to update alert");
      }
    };
  }

  modal.classList.add("show");
  const closeBtn = $("ptAlertCloseBtn");
  const closeFn = ()=> modal.classList.remove("show");
  if(closeBtn) closeBtn.onclick = closeFn;
  modal.onclick = (e)=>{ if(e.target === modal) closeFn(); };
}

function buildAdviceForSeverity(severity){
  const sev = severity || "green";
  if(sev === "red"){
    return [
      "Pause high-impact training today.",
      "Contact your PT now or seek urgent care if symptoms are severe.",
      "Focus on safety first; this is not a diagnosis."
    ];
  }
  if(sev === "orange"){
    return [
      "Reduce load in the next 24‚Äì72 hours.",
      "Prioritize sleep, hydration, and recovery.",
      "Check in with your PT for modifications."
    ];
  }
  if(sev === "yellow"){
    return [
      "Monitor symptoms and avoid adding extra volume.",
      "Keep technique quality high and recover well.",
      "Message your PT if symptoms persist."
    ];
  }
  return [
    "Load looks stable. Keep steady habits.",
    "Keep logging check-ins to refine guidance."
  ];
}

function updateSmartFlagCard(result){
  const card = $("smartFlagCard");
  if(!card) return;
  if(currentRole !== "dancer"){
    card.style.display = "none";
    return;
  }
  card.style.display = "";

  const badge = $("smartFlagBadge");
  const empty = $("smartFlagEmpty");
  const body = $("smartFlagBody");
  const reasonsEl = $("smartFlagReasons");
  const adviceEl = $("smartFlagAdvice");
  const msgBtn = $("smartFlagMessageBtn");

  if(!result){
    if(empty) empty.style.display = "";
    if(body) body.style.display = "none";
    return;
  }

  const severity = result.severity || "green";
  if(badge){
    badge.className = `flagBadge ${severity}`;
    badge.textContent = severity.toUpperCase();
  }
  if(empty) empty.style.display = "none";
  if(body) body.style.display = "";
  if(reasonsEl){
    const reasons = Array.isArray(result.reasons) ? result.reasons.slice(0,5) : [];
    reasonsEl.innerHTML = `<strong>Reasons:</strong> ${escapeHTML(reasons.join(" ¬∑ ") || "‚Äî")}`;
  }
  if(adviceEl){
    const advice = Array.isArray(result.advice) ? result.advice : buildAdviceForSeverity(severity);
    adviceEl.innerHTML = `<strong>Recommended:</strong> ${escapeHTML(advice.join(" ¬∑ "))}`;
  }
  if(msgBtn){
    msgBtn.style.display = (severity === "orange" || severity === "red") ? "" : "none";
  }
}

function evaluateLocalFlags(entry, history){
  const reasons = [];
  const load = computeSessionLoad(entry || {});
  const fatigue = safeNum(entry?.fatigue, 0);
  const sore = safeNum(entry?.sore, 0);
  const notes = String(entry?.notes || "");
  const lcNotes = notes.toLowerCase();

  if(fatigue >= 7 || sore >= 7){
    reasons.push("High fatigue or soreness");
  }

  const keywordsOrange = ["sharp pain","swelling","tingling","can‚Äôt bear weight","can't bear weight","cannot bear weight"];
  if(keywordsOrange.some(k => lcNotes.includes(k))){
    reasons.push("Notes mention concerning symptoms");
  }

  let severity = "green";
  if(fatigue >= 9 || sore >= 9){
    severity = "orange";
  }else if(fatigue >= 7 || sore >= 7){
    severity = "yellow";
  }

  if(load >= 500 && (fatigue >= 7 || sore >= 7)){
    severity = "orange";
    reasons.push("High load with fatigue/soreness");
  }

  return {
    severity,
    reasons,
    advice: buildAdviceForSeverity(severity)
  };
}

async function handleCheckinFeedback(entry){
  if(currentRole !== "dancer") return;
  try{
    const r = await callFn("evaluateCheckinFlags", "POST", { entry });
    const data = r?.data || r;
    const result = {
      severity: data?.severity || "green",
      reasons: data?.reasons || [],
      advice: data?.advice || buildAdviceForSeverity(data?.severity || "green")
    };
    updateSmartFlagCard(result);
  }catch(e){
    const result = evaluateLocalFlags(entry, cachedCheckins || []);
    updateSmartFlagCard(result);
  }
}    
    /***********************
     * UI RENDER (dashboard/history)
     ***********************/
function render(){
  const entries = cachedCheckins.slice().sort((a,b)=> (a.date < b.date ? 1 : -1));
  const metrics = computeMetrics(entries);

  $("m_acute").textContent = entries.length ? Math.round(metrics.acute) : "‚Äî";
  $("m_chronic").textContent = entries.length ? Math.round(metrics.chronic) : "‚Äî";
  $("m_acwr").textContent = (metrics.acwr === null) ? "‚Äî" : fmt1(metrics.acwr);

  // ‚úÖ FIX: pass entries.length so BASELINE isn‚Äôt stuck forever
  const risk = riskFromACWR(metrics.acwr, entries.length);
  const badge = $("riskBadge");
  badge.classList.remove("ok","caution","high");
  badge.classList.add(risk.cls);
  $("riskLabel").textContent = risk.label;

  $("guidanceText").textContent = guidanceText(entries, metrics);

  renderRecent(entries);
  renderHistory(entries);
  renderChart(entries);

  // ---- Risk info popup content (safe no-op if modal not present)
  const body = $("riskInfoBody");
  if(body){
    const acwrText = (metrics.acwr === null) ? "‚Äî" : fmt1(metrics.acwr);
    const acuteText = entries.length ? Math.round(metrics.acute) : "‚Äî";
    const chronicText = entries.length ? Math.round(metrics.chronic) : "‚Äî";

    let msg = "";
    if(entries.length < 10){
      msg =
        `You‚Äôre in BASELINE mode (less than 10 check-ins). ` +
        `Keep logging so the app can learn your normal training pattern.`;
    }else if(metrics.acwr === null){
      msg =
        `Not enough history for ACWR yet. ACWR needs more consistent data to compare short-term vs longer-term load.`;
    }else{
      msg =
        `ACWR compares your last 7 days vs your last 28 days. ` +
        `It‚Äôs a load trend signal‚Äînot a diagnosis.`;
    }

    body.innerHTML = `
      <div class="rowSub">
        <strong>What this badge means</strong><br/>
        It‚Äôs an estimate of <em>load-related injury risk</em> based on training-load trends.
      </div>

      <div class="rowSub" style="margin-top:10px;">
        <strong>How load is calculated</strong><br/>
        Session Load = minutes √ó RPE (0‚Äì10)
      </div>

      <div class="rowSub" style="margin-top:10px;">
        <strong>Your current numbers</strong><br/>
        Acute (7d avg): <strong style="color:rgba(255,255,255,.92)">${acuteText}</strong><br/>
        Chronic (28d avg): <strong style="color:rgba(255,255,255,.92)">${chronicText}</strong><br/>
        ACWR: <strong style="color:rgba(255,255,255,.92)">${acwrText}</strong>
      </div>

      <div class="rowSub" style="margin-top:10px;">
        <strong>Thresholds used</strong><br/>
        LOW: &lt; 0.8<br/>
        OK: 0.8‚Äì1.3<br/>
        CAUTION: 1.3‚Äì1.5<br/>
        HIGH: &gt; 1.5
      </div>

      <div class="rowSub" style="margin-top:10px;">
        <strong>Interpretation</strong><br/>
        ${escapeHTML(msg)}
      </div>

      <div class="rowSub" style="margin-top:10px;">
        <strong>What to do</strong><br/>
        HIGH: reduce extra jumps/pointe volume 24‚Äì72h, prioritize sleep, keep technique quality high.<br/>
        CAUTION: avoid stacking hard days; add recovery buffers.<br/>
        LOW: progress gradually to avoid a sudden spike next week.
      </div>

      <div class="hint" style="margin-top:12px;">
        Missing days can make ACWR less stable. Consistency improves accuracy.
      </div>
    `;
  }
}

function renderRecent(entries){
  const el = $("recentList");
  if(!el) return;

  const recent = lastNDays(entries || [], 7).slice().sort((a,b)=> (a.date < b.date ? 1 : -1));

  if(recent.length === 0){
    el.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No entries yet</div><div class="rowSub">Complete a check-in to populate your dashboard.</div></div></div>`;
    return;
  }

  // Build once (lighter than creating/appendChild per row)
  let html = "";
  for(let i=0;i<recent.length;i++){
    const e = recent[i];
    const load = sessionLoad(e);
    const exCount = Array.isArray(e.exercises) ? e.exercises.length : 0;

    const sleepNum = Number(e.sleep);
    const sleepText = isFinite(sleepNum) ? sleepNum.toFixed(1) : "‚Äî";

    html += `
      <div class="row">
        <div class="rowMain">
          <div class="rowTop">
            <div class="rowTitle">${prettyDate(e.date)}</div>
            <div class="rowMeta">${e.minutes} min ¬∑ RPE ${e.rpe}</div>
          </div>
          <div class="rowSub">
            Sleep ${sleepText}h ¬∑ Soreness ${e.sore} ¬∑ Fatigue ${e.fatigue}${exCount ? ` ¬∑ Exercises ${exCount}` : ``}
          </div>
        </div>
        <div class="rowRight">
          <div class="chip">Load ${load}</div>
        </div>
      </div>
    `;
  }

  el.innerHTML = html;
}
    
function formatJumpVolume(value){
  const v = Number(value || 0);
  if(!Number.isFinite(v) || v <= 0) return "None";
  if(v === 1) return "Low";
  if(v === 2) return "Moderate";
  return "High";
}
    
function renderHistory(entries){
  const el = $("historyList");
  el.innerHTML = "";

  if(!entries || entries.length === 0){
    el.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No saved check-ins</div><div class="rowSub">Use the Check-In tab to add your first entry.</div></div></div>`;
    return;
  }

  entries.forEach(e=>{
    const load = sessionLoad(e);
    const ex = Array.isArray(e.exercises) ? e.exercises : [];
    const exLine = ex.length
      ? `Exercises: ${ex.slice(0,3).map(x=>escapeHTML(x.name)).join(", ")}${ex.length>3 ? "‚Ä¶" : ""}`
      : "Exercises: ‚Äî";

    // dancer toggles (safe defaults if missing)
    const pointe = !!e.pointe;
    const partner = !!e.partner;
    const jumps = Number(e.jumps || 0);

    const chips = [];
    if(pointe) chips.push("ü©∞ Pointe");
    if(partner) chips.push("ü§ù Partnering");
    chips.push(`‚¨ÜÔ∏è Jumps: ${formatJumpVolume(jumps)}`);

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="rowMain">
        <div class="rowTop">
          <div class="rowTitle">${prettyDate(e.date)}</div>
          <div class="rowMeta">${e.minutes} min ¬∑ RPE ${e.rpe} ¬∑ Load ${load}</div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
          ${chips.map(c=>`<div class="chip">${c}</div>`).join("")}
        </div>

        <div class="rowSub" style="margin-top:8px;">${exLine}</div>
        <div class="rowSub" style="margin-top:4px;">${(e.notes||"").trim() ? escapeHTML(e.notes) : "‚Äî"}</div>
      </div>

      <div class="rowRight">
        <button class="iconBtn" type="button" data-edit="${e.date}">Edit</button>
      </div>
    `;

    row.querySelector('[data-edit]').addEventListener("click", ()=>{
      openCheckinModal(e);
    });

    el.appendChild(row);
  });
}

    function renderChart(entries){
      const canvas = $("trendCanvas");
      const ctx = canvas.getContext("2d");
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      const last14 = entries.slice().reverse().slice(-14);
      const loads = last14.map(sessionLoad);

      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;
      for(let i=1;i<4;i++){
        const y = (h/4)*i;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }

      if(loads.length === 0){
        ctx.fillStyle = "rgba(255,255,255,.55)";
        ctx.font = "14px " + getComputedStyle(document.body).fontFamily;
        ctx.fillText("No data yet", 18, 38);
        return;
      }

      const max = Math.max(100, ...loads);
      const min = 0;
      const padX = 18;
      const padY = 22;
      const plotW = w - padX*2;
      const plotH = h - padY*2;
      const x = (i)=> padX + (plotW * (loads.length===1 ? 0.5 : (i/(loads.length-1))));
      const y = (v)=> padY + plotH * (1 - ((v - min) / (max - min)));

      ctx.strokeStyle = "rgba(255,255,255,.80)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      loads.forEach((v,i)=>{
        const px=x(i), py=y(v);
        if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      });
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,.90)";
      loads.forEach((v,i)=>{
        ctx.beginPath(); ctx.arc(x(i), y(v), 3, 0, Math.PI*2); ctx.fill();
      });

      const latest = loads[loads.length-1];
      ctx.fillStyle = "rgba(255,255,255,.70)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText("Latest: " + latest, 18, 18);
    }

    /***********************
     * MODALS
     ***********************/
function openCheckinModal(existing=null){
  $("checkinModal").classList.add("show");

  const fallback = existing || cachedCheckins.find(x=> x.date === todayISO()) || null;
  const d = fallback ? fallback.date : todayISO();
  $("f_date").value = d;

  $("f_minutes").value = fallback ? fallback.minutes : 60;
  $("f_rpe").value     = fallback ? fallback.rpe : 6;
  $("f_sleep").value   = fallback ? fallback.sleep : 7;
  $("f_sore").value    = fallback ? fallback.sore : 3;
  $("f_fatigue").value = fallback ? fallback.fatigue : 4;
  $("f_notes").value   = fallback ? (fallback.notes||"") : "";

  // NEW dancer markers (safe defaults if missing)
  $("f_pointe").checked = !!(fallback && fallback.pointe);
  $("f_partner").checked = !!(fallback && fallback.partner);

  const jumpsVal = (fallback && typeof fallback.jumps !== "undefined") ? Number(fallback.jumps) : 0;
  $("f_jumps").value = String(isNaN(jumpsVal) ? 0 : Math.max(0, Math.min(3, jumpsVal)));

  // exercise picks
  setCheckinPicked(Array.isArray(fallback?.exercises) ? fallback.exercises : []);

  // keep picker collapsed by default
  $("exercisePicker").style.display = "none";

  syncVals();
  renderExercisePicker();
}

    function closeCheckinModal(){ $("checkinModal").classList.remove("show"); }

    function syncVals(){
      $("v_minutes").textContent = $("f_minutes").value;
      $("v_rpe").textContent = $("f_rpe").value;
      $("v_sleep").textContent = Number($("f_sleep").value).toFixed(1);
      $("v_sore").textContent = $("f_sore").value;
      $("v_fatigue").textContent = $("f_fatigue").value;
    }

    function openAddExerciseModal(){
      $("addExerciseModal").classList.add("show");
      $("ae_name").value = "";
      $("ae_focus").value = "";
      $("ae_presc").value = "";
      $("ae_how").value = "";
      $("ae_cues").value = "";
    }
function closeAddExerciseModal(){ $("addExerciseModal").classList.remove("show"); }

/***********************
 * ROUTINES UI
 ***********************/
function renderRoutineList(){
  const el = $("routineList");
  if(!el) return;
  el.innerHTML = "";

  if(!currentUser){
    el.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">Not logged in</div><div class="rowSub">Log in to use routines.</div></div></div>`;
    return;
  }

  if(!cachedRoutines || cachedRoutines.length === 0){
    el.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No routines yet</div><div class="rowSub">Tap ‚ÄúNew Routine‚Äù to save a warm-up, prehab, recovery, etc.</div></div></div>`;
    return;
  }

  const frag = document.createDocumentFragment();

  for(let i=0;i<cachedRoutines.length;i++){
    const r = cachedRoutines[i];
    const count = Array.isArray(r.exerciseIds) ? r.exerciseIds.length : 0;

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="rowMain">
        <div class="rowTop">
          <div class="rowTitle">${escapeHTML(r.name || "Routine")}</div>
          <div class="rowMeta">${count} exercise${count===1?"":"s"}</div>
        </div>
        <div class="rowSub">Apply this routine in Today‚Äôs Check-In.</div>
      </div>
      <div class="rowRight">
        <button class="iconBtn" type="button" data-use="${r.id}">Use</button>
        <button class="iconBtn" type="button" data-edit="${r.id}">Edit</button>
      </div>
    `;

    row.querySelector(`[data-use="${r.id}"]`).addEventListener("click", ()=>{
      setTab("checkin");
      openCheckinModal(null);
      applyRoutineToToday(r.id);
      toast("Routine added ‚úì");
      // picker stays collapsed; user can open to view
    });

    row.querySelector(`[data-edit="${r.id}"]`).addEventListener("click", ()=>{
      showRoutineEditor(r.id);
    });

    frag.appendChild(row);
  }

  el.appendChild(frag);
}

function renderRoutinePickerList(){
  const el = $("routinePickerList");
  if(!el) return;
  el.innerHTML = "";

  if(!currentUser){
    el.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">Not logged in</div><div class="rowSub">Log in to use routines.</div></div></div>`;
    return;
  }

  if(!cachedRoutines || cachedRoutines.length === 0){
    el.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No routines yet</div><div class="rowSub">Create one in the Exercises tab.</div></div></div>`;
    return;
  }

  const frag = document.createDocumentFragment();

  for(let i=0;i<cachedRoutines.length;i++){
    const r = cachedRoutines[i];
    const count = Array.isArray(r.exerciseIds) ? r.exerciseIds.length : 0;

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="rowMain">
        <div class="rowTop">
          <div class="rowTitle">${escapeHTML(r.name || "Routine")}</div>
          <div class="rowMeta">${count} exercise${count===1?"":"s"}</div>
        </div>
        <div class="rowSub">Tap to add to today.</div>
      </div>
      <div class="rowRight">
        <button class="iconBtn" type="button" data-add="${r.id}">Add</button>
      </div>
    `;

    row.querySelector(`[data-add="${r.id}"]`).addEventListener("click", ()=>{
      applyRoutineToToday(r.id);
      toast("Routine added ‚úì");
      $("routinePickerModal").classList.remove("show");
    });

    frag.appendChild(row);
  }

  el.appendChild(frag);
}

function showRoutineEditor(routineIdOrNull){
  const modal = $("routineEditorModal");
  if(!modal) return;

  const existing = routineIdOrNull ? getRoutineById(routineIdOrNull) : null;
  routineEditingId = existing ? existing.id : null;
  routineSelectedIds = new Set(existing ? (existing.exerciseIds || []) : []);
  $("routineEditorTitle").textContent = existing ? "Edit Routine" : "New Routine";
  $("r_name").value = existing ? (existing.name || "") : "";

  $("deleteRoutineBtn").style.display = existing ? "" : "none";

  renderRoutineExercisePicker();
  modal.classList.add("show");
}

function renderRoutineExercisePicker(){
  const wrap = $("routineExercisePicker");
  if(!wrap) return;
  wrap.innerHTML = "";

  if(!cachedExercises || cachedExercises.length === 0){
    wrap.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No exercises yet</div><div class="rowSub">Add exercises first, then build a routine.</div></div></div>`;
    return;
  }

  const frag = document.createDocumentFragment();

  for(let i=0;i<cachedExercises.length;i++){
    const ex = cachedExercises[i];
    const selected = routineSelectedIds.has(ex.id);

    const row = document.createElement("div");
    row.className = "pickRow";
    row.innerHTML = `
      <div class="pickMain">
        <p class="pickTitle">${escapeHTML(ex.name || "Exercise")}</p>
        <p class="pickMeta">${escapeHTML(ex.category || "Other")} ¬∑ ${escapeHTML(ex.defaultRx || ex.focus || "")}</p>
      </div>
      <div class="pickRight">
        <button class="iconBtn" type="button" data-toggle="${ex.id}">
          ${selected ? "Remove" : "Add"}
        </button>
      </div>
    `;

    row.querySelector(`[data-toggle="${ex.id}"]`).addEventListener("click", ()=>{
      if(routineSelectedIds.has(ex.id)) routineSelectedIds.delete(ex.id);
      else routineSelectedIds.add(ex.id);
      renderRoutineExercisePicker();
    });

    frag.appendChild(row);
  }

  wrap.appendChild(frag);
}

function saveRoutineFromEditor(){
  if(!currentUser) { toast("Not logged in"); return; }

  const name = ($("r_name").value || "").trim();
  const ids = Array.from(routineSelectedIds);

  if(!name){
    toast("Add a routine name");
    return;
  }
  if(ids.length === 0){
    toast("Pick at least 1 exercise");
    return;
  }

  const routine = {
    id: routineEditingId || makeRoutineId(),
    name,
    exerciseIds: ids
  };

  upsertRoutine(currentUser.uid, routine);
  $("routineEditorModal").classList.remove("show");
  renderRoutineList();
  toast("Routine saved ‚úì");
}

function deleteRoutineFromEditor(){
  if(!currentUser) return;
  if(!routineEditingId) return;

  if(!confirm("Delete this routine?")) return;

  deleteRoutineById(currentUser.uid, routineEditingId);
  routineEditingId = null;
  routineSelectedIds = new Set();
  $("routineEditorModal").classList.remove("show");
  renderRoutineList();
  toast("Routine deleted");
}

function applyRoutineToToday(routineId){
  const r = getRoutineById(routineId);
  if(!r || !Array.isArray(r.exerciseIds)) return;

  const picked = getCheckinPicked();
  const pickedIds = new Set(picked.map(x=>x.exerciseId));

  for(let i=0;i<r.exerciseIds.length;i++){
    const exId = r.exerciseIds[i];
    if(pickedIds.has(exId)) continue;

    const ex = (cachedExercises || []).find(x=> x.id === exId);
    if(!ex) continue;

    const suggestion = parseDefaultRxToSuggestion(ex.defaultRx);
    picked.push({
      exerciseId: ex.id,
      name: ex.name,
      sets: suggestion.sets,
      repsOrTime: suggestion.repsOrTime,
      notes: ""
    });
    pickedIds.add(exId);
  }

  setCheckinPicked(picked);
  // If picker is open, refresh it so user sees additions
  const panel = $("exercisePicker");
  if(panel && panel.style.display !== "none"){
    renderExercisePicker();
  }
}
function openPtCheckinModal(entry){
  const modal = document.getElementById("ptCheckinModal");
  const title = document.getElementById("ptCheckinTitle");
  const sub   = document.getElementById("ptCheckinSub");
  const body  = document.getElementById("ptCheckinBody");
  const close = document.getElementById("ptCheckinCloseBtn");
  if(!modal || !body) return;

  const safe = (v)=>{
    if(v === undefined || v === null || v === "") return "‚Äî";
    return escapeHTML(String(v));
  };

  const dancerName =
    (window.ptDancerNameMap && entry?.dancerId && window.ptDancerNameMap[entry.dancerId]) ||
    entry?.dancerId ||
    "Dancer";

  const load = computeSessionLoad(entry);

  if(title) title.textContent = dancerName;
  if(sub) sub.textContent = `${safe(entry?.date)} ¬∑ ${safe(entry?.minutes)} min ¬∑ RPE ${safe(entry?.rpe)} ¬∑ Load ${safe(load)}`;

  // Normalize fields (older check-ins may not have these)
  const pointe = entry?.pointe ? "Yes" : "No";
  const partner = entry?.partner ? "Yes" : "No";
  const jumps = (entry?.jumps === undefined || entry?.jumps === null)
    ? "‚Äî"
    : formatJumpVolume(entry.jumps);

  // Exercises (array)
  const exArr = Array.isArray(entry?.exercises) ? entry.exercises : [];
  const exHtml = exArr.length
    ? exArr.map((x)=>{
        const nm = safe(x?.name || x?.exerciseName || x?.title || "Exercise");
        const parts = [];
        if(x?.sets) parts.push(`${x.sets} sets`);
        if(x?.reps) parts.push(`${x.reps} reps`);
        if(x?.seconds) parts.push(`${x.seconds}s`);
        if(x?.minutes) parts.push(`${x.minutes} min`);
        const dose = parts.length ? safe(parts.join(" ¬∑ ")) : "";
        const note = safe(x?.note || x?.notes || "");

        return `
          <div style="border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:10px; margin-bottom:8px;">
            <div style="font-weight:900;">${nm}</div>
            ${dose ? `<div style="opacity:.7; font-size:12px; margin-top:2px;">${dose}</div>` : ``}
            ${(note && note !== "‚Äî") ? `<div style="opacity:.85; margin-top:6px;">${note}</div>` : ``}
          </div>
        `;
      }).join("")
    : `<div style="opacity:.6;">‚Äî</div>`;

  const metricCard = (label, value)=>`
    <div style="border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:10px;">
      <div style="opacity:.65; font-size:12px;">${label}</div>
      <div style="font-weight:900;">${value}</div>
    </div>
  `;

  body.innerHTML = `
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
      ${metricCard("Sleep", safe(entry?.sleep))}
      ${metricCard("Soreness", safe(entry?.sore))}
      ${metricCard("Fatigue", safe(entry?.fatigue))}
      ${metricCard("Pointe", safe(pointe))}
      ${metricCard("Partnering", safe(partner))}
      ${metricCard("Jumps", safe(jumps))}
    </div>

    <div style="border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:10px; margin-bottom:10px;">
      <div style="opacity:.65; font-size:12px; margin-bottom:6px;">Exercises</div>
      ${exHtml}
    </div>

    <div style="border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:10px;">
      <div style="opacity:.65; font-size:12px; margin-bottom:6px;">Notes</div>
      <div>${safe(entry?.notes)}</div>
    </div>
        ${
      entry?.redFlag
        ? `
          <div style="border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:10px; margin-top:10px;">
            <div style="opacity:.65; font-size:12px; margin-bottom:6px;">Red Flag Summary</div>
            <div><strong>${safe(entry.redFlag.severity || "").toUpperCase()}</strong></div>
            <div style="margin-top:6px;">${safe(Array.isArray(entry.redFlag.reasons) ? entry.redFlag.reasons.join(" ¬∑ ") : "")}</div>
          </div>
        `
        : ""
    }
  `;

  // Show + close
  modal.classList.add("show");
  const closeFn = ()=> modal.classList.remove("show");

  if(close) close.onclick = closeFn;
  modal.onclick = (e)=> { if(e.target === modal) closeFn(); };
  window.onkeydown = (e)=> { if(e.key === "Escape") closeFn(); };
}

function closePtCheckinModal(){
  const modal = document.getElementById("ptCheckinModal");
  if(modal) modal.classList.remove("show");
}

    /***********************
     * TABS
     ***********************/
function setTab(tab){
  // Block PT-only tabs if dancer (prevents ‚ÄúMy Dancers‚Äù empty screen for dancers)
  if(currentRole !== "pt" && tab === "dancers"){
    tab = "dashboard";
  }

  const screens = ["dashboard","checkin","dancers","messages","exercises","history"];
  screens.forEach(s=>{
    const el = document.getElementById("screen-"+s);
    if(el) el.style.display = (s===tab) ? "" : "none";
  });

  document.querySelectorAll(".tab").forEach(b=>{
    b.classList.toggle("active", b.dataset.tab === tab);
  });

  // Only render what‚Äôs needed
  if(tab === "dashboard"){
    if(currentRole === "pt"){
      // PT dashboard render (do NOT call dancer render())
      renderPtDashboard();
    } else {
      render();
    }
  } else if(tab === "history"){
    if(currentRole === "dancer"){
      const entries = cachedCheckins.slice().sort((a,b)=> (a.date < b.date ? 1 : -1));
      renderHistory(entries);
    }
  } else if(tab === "exercises"){
    renderRoutineList();
    renderExerciseList();
  } else if(tab === "dancers"){
    // PT-only
    if(currentRole === "pt"){
      refreshMyDancersUI();
    }
      } else if(tab === "messages"){
    renderThreadsList();
  }
}

    /***********************
     * CSV
     ***********************/
function exportCSV(){
  const entries = cachedCheckins.slice().sort((a,b)=> (a.date < b.date ? 1 : -1));
  const header = [
    "date","minutes","rpe","session_load",
    "sleep_hours","soreness","fatigue",
    "pointe","partnering","jumps",
    "notes","exercises"
  ];

  const rows = entries.map(e=>{
    const ex = Array.isArray(e.exercises) ? e.exercises : [];
    const exText = ex.map(x=> `${x.name} (${x.sets}x${x.repsOrTime})`).join("; ");
    const row = [
      e.date,
      e.minutes,
      e.rpe,
      sessionLoad(e),
      Number(e.sleep).toFixed(1),
      e.sore,
      e.fatigue,
      e.pointe ? "yes" : "no",
      e.partner ? "yes" : "no",
      Number(e.jumps || 0),
      (e.notes||"").replace(/\n/g," ").replace(/"/g,'""'),
      exText.replace(/"/g,'""')
    ];
    return row.map(x=> `"${x}"`).join(",");
  });

  const csv = header.join(",") + "\n" + rows.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "on-pointe-prevention_checkins.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("Exported CSV");
}

    /***********************
     * PWA (Android + iOS)
     ***********************/
    function setupPWA(){
      const manifest = {
        name: "On Pointe Prevention",
        short_name: "On Pointe",
        start_url: "./",
        display: "standalone",
        background_color: "#0B0B0D",
        theme_color: "#0B0B0D",
        icons: [
          { src: "logo.png", sizes: "192x192", type: "image/png" },
          { src: "logo.png", sizes: "512x512", type: "image/png" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement("link");
      link.rel = "manifest";
      link.href = url;
      document.head.appendChild(link);

      if("serviceWorker" in navigator){
        const sw = `
          const CACHE="opp-cache-v3";
          const ASSETS=["./","./index.html","./logo.png"];
          self.addEventListener("install", e=>{
            e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).catch(()=>{}));
            self.skipWaiting();
          });
          self.addEventListener("activate", e=>e.waitUntil(self.clients.claim()));
          self.addEventListener("fetch", e=>{
            e.respondWith(
              caches.match(e.request).then(r=> r || fetch(e.request).then(res=>{
                const copy=res.clone();
                caches.open(CACHE).then(c=>c.put(e.request, copy)).catch(()=>{});
                return res;
              }).catch(()=>r))
            );
          });
        `;
        const swURL = URL.createObjectURL(new Blob([sw], {type:"text/javascript"}));
        navigator.serviceWorker.register(swURL).catch(()=>{});
      }
    }

    /***********************
     * AUTH UI
     ***********************/
    let authMode = "login";
function setAuthMode(mode){
  authMode = mode;

  const creating = (mode === "create");

  $("authModeTitle").textContent = creating ? "CREATE ACCOUNT" : "ONPOINTE LOGIN";
  $("authPrimaryBtn").textContent = creating ? "Create" : "Log in";
  $("authAltText").textContent = creating ? "Already have an account?" : "Don‚Äôt have an account?";
  $("authToggle").textContent = creating ? "Log in" : "Create";

  // NEW: show name + confirm password only when creating
  $("authNameWrap").style.display = creating ? "" : "none";
  $("authPassword2Wrap").style.display = creating ? "" : "none";

  // clear messages
  setAuthMessage("");
}
    function setAuthMessage(msg){ $("authMsg").textContent = msg || ""; }

    async function doAuthPrimary(){
      const email = ($("authEmail").value || "").trim();
      const pass = $("authPassword").value || "";
      if(!email || !pass){ setAuthMessage("Enter email + password."); return; }
      try{
        if(authMode === "login") await signInWithEmailAndPassword(auth, email, pass);
else {
  const name = ($("authName").value || "").trim();
  const pass2 = $("authPassword2").value || "";

  if(!name){ setAuthMessage("Enter your name."); return; }
  if(pass !== pass2){ setAuthMessage("Passwords don‚Äôt match."); return; }

  const cred = await createUserWithEmailAndPassword(auth, email, pass);

  // Save email + name now. Role will be chosen on Finish Setup screen.
  await ensureUserProfile(cred.user.uid, cred.user.email, null, name);
}
      }catch(err){
        const code = err?.code || "";
        let m = err?.message || "Auth error";
        if(code.includes("invalid-credential")) m = "Incorrect email or password.";
        if(code.includes("email-already-in-use")) m = "That email is already in use. Try logging in.";
        if(code.includes("weak-password")) m = "Password should be at least 6 characters.";
        if(code.includes("invalid-email")) m = "Invalid email format.";
        setAuthMessage(m);
      }
    }

    async function doResetPassword(){
      const email = ($("authEmail").value || "").trim();
      if(!email){ setAuthMessage("Enter your email first."); return; }
      try{
        await sendPasswordResetEmail(auth, email);
        setAuthMessage("Password reset email sent.");
      }catch(err){
        setAuthMessage(err?.message || "Could not send reset email.");
      }
    }

    function showAuth(){ $("authScreen").style.display=""; $("appShell").style.display="none"; setAuthMode("login"); }
    function showApp(){ $("authScreen").style.display="none"; $("appShell").style.display=""; }

    /***********************
     * BOOT PER USER
     ***********************/
async function onUserSignedIn(user){
  console.log("[auth] onUserSignedIn()", { uid: user?.uid, email: user?.email });
  currentUser = user;

  await ensureUserProfile(user.uid, user.email);

  // If role missing, stop here (role gate will show)
  const blocked = await gateRoleIfMissing(user);
  if(blocked) return;

  // Load role once and store globally
  currentRole = await getMyRole();
  console.log("[role] currentRole =", currentRole);

  // Role-aware tab visibility + dashboard visibility
  applyRoleUI(currentRole);

  // Load local user preferences FIRST
  loadFavorites(user.uid);
  loadRoutines(user.uid);

  // Load dancer checkins only if dancer (PT does NOT need this)
  if(currentRole === "dancer"){
    cachedCheckins = await loadAllCheckins(user.uid);
  } else {
    cachedCheckins = []; // prevent dancer render code from misfiring
  }

  // load custom exercises + merge with defaults (both roles can use exercise library if you want)
  const userExercises = await loadUserExercises(user.uid);
  cachedExercises = mergeExerciseLibrary(userExercises);

  renderExerciseList();
  renderRoutineList();

  // Role-aware dashboard render
  if(currentRole === "pt"){
    await renderPtDashboard();   // PT dashboard only
    setTab("dashboard");
  } else {
    render();                   // Dancer dashboard only
    setTab("dashboard");
  }

  // linking card is useful for both (dancer links to PT, PT sees code etc)
  await initLinkingUI();
  
  // messaging + alerts listeners
  startThreadsListener();
  if(currentRole === "pt"){
    startAlertsListener();
  }else{
    stopAlertsListener();
  }

  // smart flag card on load (use latest check-in if available)
  if(currentRole === "dancer" && cachedCheckins.length){
    const latest = cachedCheckins.slice().sort((a,b)=> (a.date < b.date ? 1 : -1))[0];
    if(latest?.redFlag){
      updateSmartFlagCard({
        severity: latest.redFlag.severity || "green",
        reasons: latest.redFlag.reasons || [],
        advice: buildAdviceForSeverity(latest.redFlag.severity || "green")
      });
    }else{
      updateSmartFlagCard(null);
    }
  }
}

    /***********************
     * EVENTS / WIRES
     ***********************/
function wireUI(){
  // helper: build category chips
  function getAllCategories(){
    const set = new Set(["All"]);
    (cachedExercises || []).forEach(ex => set.add(ex.category || "Other"));
    return Array.from(set);
  }

  function renderCategoryChips(){
    const wrap = $("categoryChips");
    if(!wrap) return;

    const cats = getAllCategories();
    wrap.innerHTML = "";

    cats.forEach(cat=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "mutedBtn";
      btn.textContent = cat;

      const active = (selectedCategory === cat);
      btn.style.borderColor = active ? "rgba(255,255,255,.22)" : "rgba(255,255,255,.12)";
      btn.style.background = active ? "rgba(255,255,255,.08)" : "rgba(255,255,255,.02)";
      btn.style.color = active ? "rgba(255,255,255,.95)" : "rgba(255,255,255,.85)";

      btn.addEventListener("click", ()=>{
        selectedCategory = cat;
        renderCategoryChips();
        renderExerciseList();
      });

      wrap.appendChild(btn);
    });
  }

  // ---- Rest Day modal helpers ----
  function syncRestVals(){
    const p = $("r_pain");
    const s = $("r_sleep");
    const so = $("r_sore");
    const f = $("r_fatigue");
    if(p) $("rv_pain").textContent = p.value;
    if(s) $("rv_sleep").textContent = Number(s.value).toFixed(1);
    if(so) $("rv_sore").textContent = so.value;
    if(f) $("rv_fatigue").textContent = f.value;
  }

  function openRestModal(prefill){
    $("restModal").classList.add("show");

    $("restReason").value = "Deload / planned recovery";
    $("restNotes").value = "";
    $("restPainLocation").value = "";

    // Prefill recovery markers from today's existing check-in if present, else defaults
    const baseSleep = (prefill && prefill.sleep != null) ? Number(prefill.sleep) : 7;
    const baseSore  = (prefill && prefill.sore != null) ? Number(prefill.sore) : 3;
    const baseFat   = (prefill && prefill.fatigue != null) ? Number(prefill.fatigue) : 4;

    $("r_pain").value = 0;
    $("r_sleep").value = isNaN(baseSleep) ? 7 : baseSleep;
    $("r_sore").value = isNaN(baseSore) ? 3 : baseSore;
    $("r_fatigue").value = isNaN(baseFat) ? 4 : baseFat;

    syncRestVals();
  }

  function closeRestModal(){
    $("restModal").classList.remove("show");
  }

  // auth
  $("authPrimaryBtn").addEventListener("click", doAuthPrimary);
  $("authToggle").addEventListener("click", ()=> setAuthMode(authMode === "login" ? "create" : "login"));
  $("authReset").addEventListener("click", doResetPassword);

  // Risk info modal open/close
const riskBtn = $("riskInfoBtn");
const riskModal = $("riskInfoModal");
const closeRisk = $("closeRiskInfo");

if(riskBtn && riskModal){
  riskBtn.addEventListener("click", ()=> riskModal.classList.add("show"));
}
if(closeRisk && riskModal){
  closeRisk.addEventListener("click", ()=> riskModal.classList.remove("show"));
}
if(riskModal){
  riskModal.addEventListener("click", (e)=>{
    if(e.target === riskModal) riskModal.classList.remove("show");
  });
}

  // Role Gate button wiring
$("chooseDancerBtn").addEventListener("click", async ()=>{
  await setUserRole("dancer");
  hideRoleGate();
  toast("Setup complete");
  // optional: call whatever loads your dashboard
  // loadDashboard();
});

$("choosePtBtn").addEventListener("click", ()=>{
  $("ptCodeWrap").style.display = "";
  $("ptCodeError").style.display = "none";
  $("ptSecretCode").value = "";
  $("ptSecretCode").focus();
});

$("cancelPtRoleBtn").addEventListener("click", ()=>{
  $("ptCodeWrap").style.display = "none";
  $("ptCodeError").style.display = "none";
  $("ptSecretCode").value = "";
});

$("savePtRoleBtn").addEventListener("click", async ()=>{
  const code = ($("ptSecretCode").value || "").trim();
  if(code !== "secret"){
    $("ptCodeError").style.display = "";
    return;
  }
  $("ptCodeError").style.display = "none";
  await setUserRole("pt");
  hideRoleGate();
  toast("Setup complete");
});
  
  // tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      setTab(btn.dataset.tab);
      if(btn.dataset.tab === "exercises"){
        renderCategoryChips();
        renderExerciseList();
      }
    });
  });

  // buttons
  $("openCheckin").addEventListener("click", ()=> openCheckinModal());
  $("openCheckin2").addEventListener("click", ()=> openCheckinModal());
  $("openExercises").addEventListener("click", ()=> setTab("exercises"));
    const routinePickerBtn = $("openRoutinePicker");
  if(routinePickerBtn){
    routinePickerBtn.addEventListener("click", ()=>{
      if(!currentUser){ toast("Not logged in"); return; }
      renderRoutinePickerList();
      $("routinePickerModal").classList.add("show");
    });
  }

  const newRoutineBtn = $("newRoutineBtn");
  if(newRoutineBtn){
    newRoutineBtn.addEventListener("click", ()=>{
      if(!currentUser){ toast("Not logged in"); return; }
      showRoutineEditor(null);
    });
  }

  const closeRoutinePicker = $("closeRoutinePicker");
  if(closeRoutinePicker){
    closeRoutinePicker.addEventListener("click", ()=> $("routinePickerModal").classList.remove("show"));
  }

  const closeRoutineEditor = $("closeRoutineEditor");
  if(closeRoutineEditor){
    closeRoutineEditor.addEventListener("click", ()=> $("routineEditorModal").classList.remove("show"));
  }

  const saveRoutineBtn = $("saveRoutineBtn");
  if(saveRoutineBtn){
    saveRoutineBtn.addEventListener("click", saveRoutineFromEditor);
  }

  const deleteRoutineBtn = $("deleteRoutineBtn");
  if(deleteRoutineBtn){
    deleteRoutineBtn.addEventListener("click", deleteRoutineFromEditor);
  }

  const routinePickerModal = $("routinePickerModal");
  if(routinePickerModal){
    routinePickerModal.addEventListener("click", (e)=>{
      if(e.target === routinePickerModal) routinePickerModal.classList.remove("show");
    });
  }

  const routineEditorModal = $("routineEditorModal");
  if(routineEditorModal){
    routineEditorModal.addEventListener("click", (e)=>{
      if(e.target === routineEditorModal) routineEditorModal.classList.remove("show");
    });
  }
  const refreshDancersBtn = $("refreshDancersBtn");
  if(refreshDancersBtn){
    refreshDancersBtn.addEventListener("click", ()=> refreshMyDancersUI());
  }
   const refreshMessagesBtn = $("refreshMessagesBtn");
  if(refreshMessagesBtn){
    refreshMessagesBtn.addEventListener("click", ()=> renderThreadsList());
  }

  const chatBackBtn = $("chatBackBtn");
  if(chatBackBtn){
    chatBackBtn.addEventListener("click", closeChatThread);
  }

  const chatForm = $("chatForm");
  if(chatForm){
    chatForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const input = $("chatInput");
      if(!input) return;
      const text = input.value;
      input.value = "";
      await sendChatMessage(text);
    });
  }

  const smartFlagMessageBtn = $("smartFlagMessageBtn");
  if(smartFlagMessageBtn){
    smartFlagMessageBtn.addEventListener("click", async ()=>{
      setTab("messages");
      if(currentRole !== "dancer") return;
      const ptProfile = await loadLinkedPtProfile();
      const ptId = ptProfile?.id || await getLinkedPtIdForDancer();
      if(!ptId){
        toast("Link to a PT first");
        return;
      }
      openChatThread(currentUser.uid, "Your PT");
    });
  }

  // ‚úÖ Rest Day button (expects an element with id="restDayBtn" to exist)
  const restBtn = $("restDayBtn");
  if(restBtn){
    restBtn.addEventListener("click", ()=>{
      if(!currentUser){ toast("Not logged in"); return; }

      const date = todayISO();
      const existing = cachedCheckins.find(x=> x.date === date);

      if(existing){
        const ok = confirm("You already have a check-in saved for today. Replace it with a Rest Day (minutes 0, RPE 0)?");
        if(!ok) return;
      }

      openRestModal(existing || null);
    });
  }

  // Rest modal close
  $("closeRest").addEventListener("click", closeRestModal);
  $("cancelRest").addEventListener("click", closeRestModal);
  $("restModal").addEventListener("click", (e)=>{ if(e.target === $("restModal")) closeRestModal(); });

  // Rest modal sliders
  ["r_pain","r_sleep","r_sore","r_fatigue"].forEach(id=>{
    const el = $(id);
    if(el) el.addEventListener("input", syncRestVals);
  });

  // Rest day save
  $("restForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!currentUser){ toast("Not logged in"); return; }

    const date = todayISO();
    const reason = ($("restReason").value || "Other").trim();
    const extra = ($("restNotes").value || "").trim();

    const pain = Number($("r_pain").value);
    const painLoc = ($("restPainLocation").value || "").trim();

    const sleep = Number($("r_sleep").value);
    const sore = Number($("r_sore").value);
    const fatigue = Number($("r_fatigue").value);

    const painLine = (pain > 0 || painLoc)
      ? ` Pain: ${isNaN(pain) ? 0 : pain}/10${painLoc ? ` @ ${painLoc}` : ""}.`
      : "";

    const notes = extra
      ? `Rest day ‚Äî ${reason}.${painLine} ${extra}`.trim()
      : `Rest day ‚Äî ${reason}.${painLine}`.trim();

    const entry = {
      date,
      minutes: 0,
      rpe: 0,
      sleep: isNaN(sleep) ? 7 : sleep,
      sore: isNaN(sore) ? 3 : sore,
      fatigue: isNaN(fatigue) ? 4 : fatigue,
      pointe: false,
      partner: false,
      jumps: 0,
      pointe: false,
      partner: false,
      jumps: 0,
      notes: notes,
      exercises: []
    };

    try{
      await upsertCheckin(currentUser.uid, entry);

      const idx = cachedCheckins.findIndex(x=> x.date === date);
      if(idx >= 0) cachedCheckins[idx] = entry;
      else cachedCheckins.push(entry);

      toast("Rest Day saved ‚úì");
      await handleCheckinFeedback(entry);
      closeRestModal();
      render();
      setTab("dashboard");
    }catch(err){
      console.error(err);
      toast("Save failed");
    }
  });

  $("exportBtn").addEventListener("click", exportCSV);
  $("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

  $("clearData").addEventListener("click", async ()=>{
    if(!currentUser) return;
    if(confirm("Clear all check-ins for this account?")){
      await deleteAllCheckins(currentUser.uid);
      cachedCheckins = [];
      toast("Cleared");
      render();
    }
  });

  // check-in modal close
  $("closeCheckin").addEventListener("click", closeCheckinModal);
  $("cancelCheckin").addEventListener("click", closeCheckinModal);
  $("checkinModal").addEventListener("click", (e)=>{ if(e.target === $("checkinModal")) closeCheckinModal(); });

  // exercise modal close
  $("closeExercise").addEventListener("click", ()=> $("exerciseModal").classList.remove("show"));
  $("exerciseModal").addEventListener("click", (e)=>{ if(e.target === $("exerciseModal")) $("exerciseModal").classList.remove("show"); });

  // add-exercise modal
  $("openAddExercise").addEventListener("click", ()=>{
    openAddExerciseModal();
    const cat = $("ae_category");
    if(cat) cat.value = "Foot/Ankle";
  });
  $("closeAddExercise").addEventListener("click", closeAddExerciseModal);
  $("cancelAddExercise").addEventListener("click", closeAddExerciseModal);
  $("addExerciseModal").addEventListener("click", (e)=>{ if(e.target === $("addExerciseModal")) closeAddExerciseModal(); });

  // check-in picker toggle
  $("toggleExercisePicker").addEventListener("click", ()=>{
    const panel = $("exercisePicker");
    const open = panel.style.display !== "none";
    panel.style.display = open ? "none" : "";
    if(!open) renderExercisePicker();
  });

  // sliders
  ["f_minutes","f_rpe","f_sleep","f_sore","f_fatigue"].forEach(id=>{
    $(id).addEventListener("input", syncVals);
  });

  // search + favorites (Exercises tab)
  const searchEl = $("exSearch");
  const favBtn = $("toggleFavorites");
  const clearBtn = $("clearSearch");

  if(searchEl){
    searchEl.addEventListener("input", ()=>{
      exSearchQuery = searchEl.value || "";
      renderExerciseList();
    });
  }

  if(favBtn){
    favBtn.addEventListener("click", ()=>{
      showFavoritesOnly = !showFavoritesOnly;
      favBtn.textContent = showFavoritesOnly ? "‚≠ê Favorites: On" : "‚≠ê Favorites: Off";
      renderExerciseList();
    });
  }

  if(clearBtn){
    clearBtn.addEventListener("click", ()=>{
      exSearchQuery = "";
      if(searchEl) searchEl.value = "";
      selectedCategory = "All";
      renderCategoryChips();
      renderExerciseList();
    });
  }

  // save check-in
  $("checkinForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!currentUser){ toast("Not logged in"); return; }

    const entry = {
      date: $("f_date").value,
      minutes: Number($("f_minutes").value),
      rpe: Number($("f_rpe").value),
      sleep: Number($("f_sleep").value),
      sore: Number($("f_sore").value),
      fatigue: Number($("f_fatigue").value),
      pointe: $("f_pointe").checked,
      partner: $("f_partner").checked,
      jumps: Number($("f_jumps").value),
      notes: $("f_notes").value || "",
      exercises: getCheckinPicked()
    };

    try{
      await upsertCheckin(currentUser.uid, entry);

      const idx = cachedCheckins.findIndex(x=> x.date === entry.date);
      if(idx >= 0) cachedCheckins[idx] = entry;
      else cachedCheckins.push(entry);

      toast("Saved ‚úì");
      closeCheckinModal();
      await handleCheckinFeedback(entry);
      render();
    }catch(err){
      console.error(err);
      toast("Save failed");
    }
  });

  // add custom exercise
  $("addExerciseForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!currentUser){ toast("Not logged in"); return; }

    const name = ($("ae_name").value || "").trim();
    const category = ($("ae_category")?.value || "Other").trim();
    const focus = ($("ae_focus").value || "").trim();
    const defaultRx = ($("ae_presc").value || "").trim();
    const howText = ($("ae_how").value || "").trim();
    const cuesText = ($("ae_cues").value || "").trim();

    if(!name || !focus || !defaultRx){
      toast("Fill name + focus + default");
      return;
    }

    const ex = {
      id: makeId(),
      source: "user",
      category,
      name,
      focus,
      defaultRx,
      how: howText ? howText.split("\n").map(s=>s.trim()).filter(Boolean) : [],
      cues: cuesText ? cuesText.split(",").map(s=>s.trim()).filter(Boolean) : []
    };

    try{
      await addUserExercise(currentUser.uid, ex);

      const userExercises = await loadUserExercises(currentUser.uid);
      cachedExercises = mergeExerciseLibrary(userExercises);

      renderCategoryChips();
      renderExerciseList();

      toast("Exercise added");
      closeAddExerciseModal();
    }catch(err){
      console.error(err);
      toast("Add failed");
    }
  });

  // initial chips
  renderCategoryChips();
}

    /***********************
     * INIT
     ***********************/
    (function init(){
  setupPWA();
  wireUI();
  wireRoleGate();      // <-- ADD THIS
  setAuthMode("login");

      onAuthStateChanged(auth, async (user)=>{
        if(user){
          const gated = await gateRoleIfMissing(user);
if(gated) return; // stop here until user chooses role
          showApp();
          currentUser = user;
          await loadCurrentRole();
          if(currentRole === "pt"){
      await initLinkingUI();        // keep PT connection UI alive
      await renderPtDashboard();    // your new PT dashboard renderer
      startThreadsListener();
      startAlertsListener();
      return;
    }
          await onUserSignedIn(user);
        }else{
          currentUser = null;
          cachedCheckins = [];
          cachedExercises = [];
          stopThreadsListener();
          stopMessagesListener();
          stopAlertsListener();
          showAuth();
        }
      });
    })();

    /***********************
     * FIRESTORE RULES UPDATE (IMPORTANT)
     *
     * Add exercises subcollection permissions:
     * -------------------------------------------------
     * rules_version = '2';
     * service cloud.firestore {
     *   match /databases/{database}/documents {
     *     match /users/{userId} {
     *       allow read, write: if request.auth != null && request.auth.uid == userId;
     *       match /checkins/{docId} {
     *         allow read, write: if request.auth != null && request.auth.uid == userId;
     *       }
     *       match /exercises/{exId} {
     *         allow read, write: if request.auth != null && request.auth.uid == userId;
     *       }
     *     }
     *   }
     * }
     * -------------------------------------------------
     *
     ***********************/
    
/***********************
 * ROLE GATE (single source of truth)
 ***********************/
function showRoleGate(){
  const gate = $("roleGate");
  if(gate) gate.style.display = "";
  $("authScreen").style.display = "";   // keep auth visible
  $("appShell").style.display = "none";
}

function hideRoleGate(){
  const gate = $("roleGate");
  if(gate) gate.style.display = "none";
}

async function setUserRole(role){
  if(!auth.currentUser) throw new Error("Not logged in");
  if(role !== "pt" && role !== "dancer") throw new Error("Invalid role");

  const uid = auth.currentUser.uid;
  await setDoc(doc(db, "users", uid), {
    role,
    roleSetAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  }, { merge: true });
}

function wireRoleGate(){
  const dancerBtn = $("chooseDancerBtn"); // Dancer
  const ptBtn = $("choosePtBtn");          // PT (requires code)
  const ptWrap = $("ptCodeWrap");
  const ptErr  = $("ptCodeError");
  const ptCode = $("ptSecretCode");
  const savePt = $("savePtRoleBtn");
  const cancel = $("cancelPtRoleBtn");

  // Hide PT code UI by default
  if(ptWrap) ptWrap.style.display = "none";
  if(ptErr)  ptErr.style.display  = "none";

  // Dancer: one click
  if(dancerBtn){
    dancerBtn.onclick = async ()=>{
      try{
        await setUserRole("dancer");
        hideRoleGate();
        showApp();
        await onUserSignedIn(auth.currentUser);
      }catch(e){
        console.error(e);
        toast("Could not set role. Try again.");
        showRoleGate();
      }
    };
  }

  // PT: show code box only (DO NOT set role here)
  if(ptBtn){
    ptBtn.onclick = ()=>{
      if(ptWrap) ptWrap.style.display = "";
      if(ptErr)  ptErr.style.display  = "none";
      if(ptCode) ptCode.value = "";
      if(ptCode) ptCode.focus();

      // UX: disable Continue until typed something
      if(savePt){
        savePt.disabled = true;
        savePt.style.opacity = "0.6";
      }
    };
  }

  // Enable Continue when code is typed
  if(ptCode && savePt){
    ptCode.addEventListener("input", ()=>{
      const has = !!(ptCode.value || "").trim();
      savePt.disabled = !has;
      savePt.style.opacity = has ? "" : "0.6";
    });
  }

  // Back button hides code UI
  if(cancel){
    cancel.onclick = ()=>{
      if(ptWrap) ptWrap.style.display = "none";
      if(ptErr)  ptErr.style.display  = "none";
      if(ptCode) ptCode.value = "";
    };
  }

  // Continue as PT requires secret code (UI gate)
  if(savePt){
    savePt.onclick = async ()=>{
      const code = (ptCode?.value || "").trim();

      // TODO: replace "secret" with your real secret/Cloud Function check
      if(code !== "secret"){
        if(ptErr) ptErr.style.display = "";
        return;
      }

      try{
        if(ptErr) ptErr.style.display = "none";
        await setUserRole("pt");
        hideRoleGate();
        showApp();
        await onUserSignedIn(auth.currentUser);
        toast("Setup complete");
      }catch(e){
        console.error(e);
        toast("Could not set PT role.");
        showRoleGate();
      }
    };
  }
}

async function gateRoleIfMissing(user){
  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);
  const data = snap.exists() ? (snap.data() || {}) : {};

  if(!snap.exists() || !data.role){
    showRoleGate();
    return true;
  }

  hideRoleGate();
  return false;
}
async function renderPtDashboard(){
  try{
    const availCard = document.getElementById("ptAvailabilityCard");
    const recentCard = document.getElementById("ptRecentCard");
    const alertsCard = document.getElementById("ptAlertsCard");
    if(availCard) availCard.style.display = "";
    if(recentCard) recentCard.style.display = "";
    if(alertsCard) alertsCard.style.display = "";
    
    applyRoleUI("pt");

    // IMPORTANT: wire + init calendar before loading data
    if(typeof wirePtAvailabilityUI === "function") wirePtAvailabilityUI();
    if(typeof initPtCalendarUI === "function") initPtCalendarUI();

    if(typeof loadPtAvailability === "function") await loadPtAvailability();
    if(typeof loadPtRecentCheckins === "function") await loadPtRecentCheckins();
    startAlertsListener();

  }catch(e){
    console.error("renderPtDashboard crashed:", e);
    toast("PT dashboard failed to load.");
  }
}

function hideDancerDashboardForPt(){
  // These ids exist inside dancer-only cards:
  const idsInsideDancerCards = [
    "riskBadge", "riskLabel", "riskInfoBtn", "riskInfoModal",
    "trendCanvas", "trendHint",
    "recentList",            // ‚úÖ Last 7 Days card contains #recentList
    "openCheckin", "restDayBtn", "openExercises", "clearData",
    "m_acwr", "m_acute", "m_chronic", "guidanceText"
  ];

  idsInsideDancerCards.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;

    // Prefer hiding the whole card
    const card = el.closest && el.closest(".card");
    if(card) card.style.display = "none";
    else el.style.display = "none";
  });

  // Extra safety: if a card title matches these, hide that card too
  const titleMatches = ["Last 7 Days", "Trends", "Guidance"];
  document.querySelectorAll(".card").forEach(card=>{
    const txt = (card.innerText || "").trim();
    if(titleMatches.some(t => txt.includes(t))){
      card.style.display = "none";
    }
  });
}
    function wirePtDashboardUI(){
  const goBtn = document.getElementById("goToDancersBtn");
  if(goBtn){
    goBtn.onclick = ()=> setTab("dancers");
  }

  const copyBtn = document.getElementById("copyPtCodeBtn");
  if(copyBtn){
    copyBtn.onclick = async ()=>{
      try{
        const snap = await getDoc(doc(db, "users", currentUser.uid));
        const code = snap.exists() ? snap.data().ptCode : null;
        if(!code){ toast("No PT code yet"); return; }

        await navigator.clipboard.writeText(code);
        toast("PT code copied ‚úì");
      }catch(e){
        toast("Copy failed");
      }
    };
  }
}
function safeNum(n, fallback=0){
  const v = Number(n);
  return isFinite(v) ? v : fallback;
}

function computeSessionLoad(entry){
  return Math.round(safeNum(entry.minutes,0) * safeNum(entry.rpe,0));
}

function shortDate(iso){
  try{
    const d = new Date(iso + "T00:00:00");
    return d.toLocaleDateString(undefined, { month:"short", day:"numeric" });
  }catch(e){
    return iso || "";
  }
}

// Fetch dancer names (best effort) using Firestore (PT can't read dancer user doc by your rules).
// So we display a fallback label unless you decide later to allow PT read of linked dancer profile
function dancerLabelFallback(uid){
  return "Dancer " + String(uid).slice(0,6);
}

async function loadPtRecentCheckins(){
  const wrap = document.getElementById("ptRecentCheckins");
  if(!wrap) return;

  wrap.innerHTML = `<div class="rowSub">Loading‚Ä¶</div>`;
  window.ptDancerNameMap = window.ptDancerNameMap || {};

  try{
    const r = await callFn("getMyDancers", "GET");
    const dancers = Array.isArray(r?.data?.dancers) ? r.data.dancers : [];
    const dancerIds = dancers.map(d => d.dancerId).filter(Boolean);

    dancers.forEach(d=>{
      if(d?.dancerId) window.ptDancerNameMap[d.dancerId] = d.name || d.email || d.dancerId;
    });

    if(dancerIds.length === 0){
      wrap.innerHTML = `<div class="rowSub">No dancers linked yet.</div>`;
      return;
    }

    const all = [];
    for(const dancerId of dancerIds){
      const rr = await callFn("getDancerRecentCheckins", "GET", null, { dancerId, limit: 3 });
      const items = Array.isArray(rr?.items) ? rr.items : [];
      items.forEach(it => all.push({ ...it, dancerId }));
    }

    all.sort((a,b)=> (String(a.date) < String(b.date) ? 1 : -1));

    if(all.length === 0){
      wrap.innerHTML = `<div class="rowSub">No dancer check-ins yet.</div>`;
      return;
    }

    let html = "";
    all.slice(0, 12).forEach(e=>{
      const name = window.ptDancerNameMap[e.dancerId] || e.dancerId;
      const load = computeSessionLoad(e);
      html += `
        <div class="row" data-pt-open="${escapeHTML(e.dancerId)}|${escapeHTML(e.date || "")}">
          <div class="rowMain">
            <div class="rowTitle">${escapeHTML(name)} ¬∑ ${escapeHTML(shortDate(e.date || ""))}</div>
            <div class="rowSub">${e.minutes || 0} min ¬∑ RPE ${e.rpe || 0} ¬∑ Load ${load}</div>
          </div>
          <div class="rowRight"><button class="iconBtn" type="button">Open</button></div>
        </div>
      `;
    });

    wrap.innerHTML = html;

    wrap.querySelectorAll("[data-pt-open]").forEach(row=>{
      row.addEventListener("click", ()=>{
        const key = row.getAttribute("data-pt-open") || "";
        const [dancerId, date] = key.split("|");
        const entry = all.find(x=> x.dancerId === dancerId && String(x.date) === String(date));
        if(entry) openPtCheckinModal(entry);
      });
    });

  }catch(e){
    console.error(e);
    wrap.innerHTML = `<div class="rowSub">Failed to load dancer check-ins.</div>`;
  }
}

// ---------------- PT AVAILABILITY + CALENDAR (FIXED) ----------------
window.ptAvailCache = window.ptAvailCache || [];
window.ptCalState = window.ptCalState || {
  year: new Date().getFullYear(),
  month: new Date().getMonth(),      // 0-11
  selected: null                    // "YYYY-MM-DD"
};

function showModal(id){
  const m = $(id);
  if(!m) return;
  m.classList.add("show");
  m.style.display = "flex"; // belt + suspenders
}

function hideModal(id){
  const m = $(id);
  if(!m) return;
  m.classList.remove("show");
  m.style.display = "none";
}

function isoDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function parseISO(yyyy_mm_dd){
  const [y,m,d] = (yyyy_mm_dd || "").split("-").map(Number);
  if(!y || !m || !d) return null;
  return new Date(y, m-1, d);
}

function fmtTime(t){ return (t || "").trim(); }

function openPtAvailModal(prefillDate){
  const m = $("ptAvailModal");
  if(!m) return;

  const msg = $("ptAvailMsg");
  if(msg) msg.textContent = "";

  // prefill date from calendar selection, or today
  const date = prefillDate || window.ptCalState.selected || isoDate(new Date());
  const dateEl = $("ptAvailDate");
  if(dateEl){
    dateEl.value = date;
    dateEl.disabled = true; // IMPORTANT: prevents iOS date picker overlay
  }

  const s = $("ptAvailStart"); if(s) s.value = "";
  const e = $("ptAvailEnd");   if(e) e.value = "";
  const n = $("ptAvailNote");  if(n) n.value = "";

  showModal("ptAvailModal");
  if(s) setTimeout(()=>s.focus(), 0);
}

function closePtAvailModal(){
  hideModal("ptAvailModal");
}

async function loadPtAvailability(){
  // show loading in calendar day slots (preferred), else legacy list
  const daySlots = document.getElementById("ptCalDaySlots");
  const itemsWrap = document.getElementById("ptAvailList");

  if(daySlots) daySlots.innerHTML = `<div class="rowSub">Loading‚Ä¶</div>`;
  else if(itemsWrap) itemsWrap.innerHTML = `<div class="rowSub">Loading‚Ä¶</div>`;

  try{
    const r = await callFn("getMyAvailability", "GET");
    const items = Array.isArray(r.items) ? r.items : [];

    window.ptAvailCache = items.map(it=>({
      id: it.id,
      date: it.date,         // "YYYY-MM-DD"
      start: it.start,       // "HH:MM"
      end: it.end,
      note: it.note || ""
    }));

    // refresh calendar if present
    if(document.getElementById("ptCalGrid")){
      renderPtCalendarMonth();
      renderPtCalendarSelectedDay();
    }else if(itemsWrap){
      // fallback legacy rendering if calendar not mounted
      if(window.ptAvailCache.length === 0){
        itemsWrap.innerHTML = `<div class="rowSub">No availability set yet.</div>`;
      }else{
        itemsWrap.innerHTML = window.ptAvailCache.map(it=>{
          const label = `${shortDate(it.date)} ¬∑ ${fmtTime(it.start)}‚Äì${fmtTime(it.end)}`;
          const note = (it.note || "").trim();
          return `
            <div class="row">
              <div class="rowMain">
                <div class="rowTop">
                  <div class="rowTitle">${escapeHTML(label)}</div>
                  <div class="rowMeta">${note ? escapeHTML(note) : ""}</div>
                </div>
              </div>
            </div>
          `;
        }).join("");
      }
    }
  }catch(e){
    console.error(e);
    if(daySlots) daySlots.innerHTML = `<div class="rowSub">Failed to load availability.</div>`;
    if(itemsWrap) itemsWrap.innerHTML = `<div class="rowSub">Failed to load availability.</div>`;
  }
}

function initPtCalendarUI(){
  const grid = document.getElementById("ptCalGrid");
  if(!grid) return; // calendar HTML not mounted

  // initialize selected day (today by default)
  if(!window.ptCalState.selected){
    window.ptCalState.selected = isoDate(new Date());
  }

  const prev = $("ptCalPrev");
  const next = $("ptCalNext");
  if(prev) prev.onclick = ()=>{
    window.ptCalState.month--;
    if(window.ptCalState.month < 0){ window.ptCalState.month = 11; window.ptCalState.year--; }
    renderPtCalendarMonth();
    renderPtCalendarSelectedDay();
  };
  if(next) next.onclick = ()=>{
    window.ptCalState.month++;
    if(window.ptCalState.month > 11){ window.ptCalState.month = 0; window.ptCalState.year++; }
    renderPtCalendarMonth();
    renderPtCalendarSelectedDay();
  };

  // main "+ Add availability" button should add for the selected day
  const addBtn = $("addAvailBtn");
  if(addBtn){
    addBtn.onclick = ()=> openPtAvailModal(window.ptCalState.selected);
  }

  renderPtCalendarMonth();
  renderPtCalendarSelectedDay();
}

function countSlotsOn(dateISO){
  return window.ptAvailCache.filter(x => x.date === dateISO).length;
}

function renderPtCalendarMonth(){
  const grid = document.getElementById("ptCalGrid");
  const label = document.getElementById("ptCalMonthLabel");
  if(!grid || !label) return;

  const y = window.ptCalState.year;
  const m = window.ptCalState.month;

  const first = new Date(y, m, 1);
  const startDay = first.getDay(); // 0-6
  const daysInMonth = new Date(y, m+1, 0).getDate();

  const monthName = first.toLocaleString(undefined, { month:"long" });
  label.textContent = `${monthName} ${y}`;

  // build cells (pad with blanks)
  let cells = [];
  for(let i=0;i<startDay;i++){
    cells.push(`<div class="calCell calBlank"></div>`);
  }

  for(let d=1; d<=daysInMonth; d++){
    const dateISO = isoDate(new Date(y, m, d));
    const isSel = (dateISO === window.ptCalState.selected);
    const slotCount = countSlotsOn(dateISO);

    const cls = `calCell ${isSel ? "calSelected" : ""}`;
    const badge = slotCount ? `<div class="calCount">${slotCount}</div>` : "";

    cells.push(`
      <button class="${cls}" type="button" data-caldate="${dateISO}">
        <div class="calNum">${d}</div>
        ${badge}
      </button>
    `);
  }

  grid.innerHTML = cells.join("");

  // click handlers
  grid.querySelectorAll("[data-caldate]").forEach(btn=>{
    btn.onclick = ()=>{
      window.ptCalState.selected = btn.getAttribute("data-caldate");
      renderPtCalendarMonth();
      renderPtCalendarSelectedDay();
    };
  });
}

async function deleteAvailSlot(slotId){
  try{
    await callFn("deleteMyAvailability", "POST", { slotId });
    await loadPtAvailability();
  }catch(e){
    console.error(e);
    toast("Delete failed");
  }
}

function renderPtCalendarSelectedDay(){
  const label = document.getElementById("ptCalSelectedLabel");
  const wrap = document.getElementById("ptCalDaySlots");
  if(!label || !wrap) return;

  const sel = window.ptCalState.selected;
  if(!sel){
    label.textContent = "Select a day";
    wrap.innerHTML = `<div class="rowSub">Pick a date to see / add time slots.</div>`;
    return;
  }

  label.textContent = `Selected: ${shortDate(sel)}`;

  const slots = window.ptAvailCache
    .filter(x => x.date === sel)
    .sort((a,b)=> (a.start||"").localeCompare(b.start||""));

  if(slots.length === 0){
    wrap.innerHTML = `
      <div class="rowSub">No availability for this day.</div>
      <button class="pillBtn" type="button" style="width:100%; justify-content:center; margin-top:10px;"
        id="ptCalAddForDayBtn">+ Add time slot</button>
    `;
  }else{
    wrap.innerHTML = `
      <div style="display:flex; flex-direction:column; gap:10px;">
        ${slots.map(it=>{
          const note = (it.note || "").trim();
          return `
            <div class="row">
              <div class="rowMain">
                <div class="rowTop">
                  <div class="rowTitle">${escapeHTML(fmtTime(it.start))}‚Äì${escapeHTML(fmtTime(it.end))}</div>
                  <div class="rowMeta">${note ? escapeHTML(note) : ""}</div>
                </div>
              </div>
              <div class="rowActions">
                <button class="iconBtn" type="button" data-del="${escapeHTML(it.id)}" aria-label="Delete slot">üóëÔ∏è</button>
              </div>
            </div>
          `;
        }).join("")}
        <button class="pillBtn" type="button" style="width:100%; justify-content:center;"
          id="ptCalAddForDayBtn">+ Add another slot</button>
      </div>
    `;
  }

  const add = document.getElementById("ptCalAddForDayBtn");
  if(add) add.onclick = ()=> openPtAvailModal(sel);

  wrap.querySelectorAll("[data-del]").forEach(b=>{
    b.onclick = ()=> deleteAvailSlot(b.getAttribute("data-del"));
  });
}

function wirePtAvailabilityUI(){
  // Fix ID mismatches: your HTML uses ptAvailSaveBtn + ptAvailCloseBtn
  const saveBtn = $("ptAvailSaveBtn");
  const closeBtn = $("ptAvailCloseBtn");
  const modal = $("ptAvailModal");

  if(closeBtn) closeBtn.onclick = closePtAvailModal;
  if(modal){
    modal.onclick = (e)=>{ if(e.target === modal) closePtAvailModal(); };
  }

  if(saveBtn){
    saveBtn.onclick = async ()=>{
      const msg = $("ptAvailMsg");
      const date = ($("ptAvailDate")?.value || "").trim();
      const start = ($("ptAvailStart")?.value || "").trim();
      const end = ($("ptAvailEnd")?.value || "").trim();
      const note = ($("ptAvailNote")?.value || "").trim();

      if(!date || !start || !end){
        if(msg) msg.textContent = "Please pick start + end time.";
        return;
      }

      if(msg) msg.textContent = "Saving‚Ä¶";
      try{
        await callFn("setMyAvailability", "POST", { date, start, end, note });
        closePtAvailModal();
        await loadPtAvailability();
      }catch(e){
        console.error(e);
        if(msg) msg.textContent = e?.message || "Save failed.";
      }
    };
  }
}
// ---------------- /PT AVAILABILITY + CALENDAR (FIXED) ----------------

function toISODate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

  </script>

</body>
</html>
