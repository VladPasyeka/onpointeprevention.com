<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Untitled</title>
    

  </head>
    
  <body>
  <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0B0B0D" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>On Pointe Prevention</title>

  <link rel="icon" href="logo.png" />
  <link rel="apple-touch-icon" href="logo.png" />

  <style>
    :root{
      --bg:#0B0B0D;
      --text:#F4F5F7;
      --muted:#9AA0A6;
      --line:rgba(255,255,255,.10);
      --shadow: 0 16px 38px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --pad:16px;
      --pad2:20px;
      --ok:#39d98a;
      --caution:#ffb020;
      --high:#ff5c5c;
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text", Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 65% 15%, rgba(255, 214, 222, .45), transparent 60%),
        radial-gradient(900px 700px at 25% 5%, rgba(234, 200, 210, .35), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(190, 120, 140, .20), transparent 55%),
        linear-gradient(180deg, #2a1018 0%, #12080c 60%, #0b0b0d 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    /* ===== Top bar ===== */
    .top{
      position:sticky;
      top:0;
      z-index:20;
      padding: calc(env(safe-area-inset-top) + 10px) var(--pad) 12px;
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom, rgba(11,11,13,.92), rgba(11,11,13,.55));
      border-bottom:1px solid var(--line);
    }
    .brandRow{
      display:grid;
      grid-template-columns: 44px 1fr auto;
      align-items:center;
      column-gap:12px;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: url("logo.png") center/cover no-repeat;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .title{
      font-weight:800; letter-spacing:.2px; font-size:16px; line-height:1.1; margin:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .subtitle{
      margin:2px 0 0; font-size:12px; color:var(--muted);
      overflow:hidden; display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical;
      line-height:1.2;
    }
    .topActions{display:flex; gap:10px; align-items:center; justify-self:end;}
    .pillBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .pillBtn:active{transform:scale(.98)}
    .tinyDot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.75);opacity:.9;}

    /* ===== Layout ===== */
    main{min-height:100vh;}
    .container{
      padding: 14px var(--pad);
      padding-bottom: calc(env(safe-area-inset-bottom) + 220px);
    }
    .grid{display:grid; gap:12px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardInner{padding: var(--pad2);}
    .cardHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .h{margin:0; font-size:14px; font-weight:800; letter-spacing:.2px;}
    .small{font-size:12px; color:var(--muted); margin-top:3px; line-height:1.25;}

    .badge{
      padding:8px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);
      display:flex; align-items:center; gap:8px; white-space:nowrap;
      background: rgba(255,255,255,.04); flex:0 0 auto;
    }
    .badgeDot{width:8px;height:8px;border-radius:999px}
    .badge.ok .badgeDot{background:var(--ok)}
    .badge.caution .badgeDot{background:var(--caution)}
    .badge.high .badgeDot{background:var(--high)}

    .metrics{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 380px){
      .metrics{grid-template-columns:1fr; }
    }
    .metric{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px 12px;
      min-width:0;
    }
    .metric .k{font-size:11px;color:var(--muted)}
    .metric .v{margin-top:4px;font-size:16px;font-weight:800; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .metric .s{margin-top:3px;font-size:11px;color:rgba(255,255,255,.70)}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:12px 14px;
      border-radius: 14px;
      font-size:13px;
      font-weight:750;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn.primary{ background: rgba(255,255,255,.10); }
    .btn.ghost{ background: rgba(255,255,255,.03); }
    .btn.danger{ border-color: rgba(255,92,92,.35); background: rgba(255,92,92,.08); }
    .btn:active{transform:scale(.99)}
    .btn.full{width:100%}

    /* ===== Lists ===== */
    .list{display:grid; gap:10px; margin-top:10px}
    .row{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .rowMain{min-width:0}
    .rowTop{display:flex; gap:10px; align-items:baseline; flex-wrap:wrap; margin-bottom:2px;}
    .rowTitle{font-weight:850; font-size:13px}
    .rowMeta{font-size:12px;color:rgba(255,255,255,.70)}
    .rowSub{font-size:12px;color:var(--muted); line-height:1.3}
    .rowRight{display:flex; flex-direction:column; align-items:flex-end; gap:8px; flex:0 0 auto;}
    .chip{
      padding:6px 8px;border-radius:999px;border:1px solid var(--line);
      background: rgba(0,0,0,.12);font-size:11px;color: rgba(255,255,255,.88);
      font-variant-numeric: tabular-nums; white-space:nowrap;
    }
    .iconBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }

    /* ===== Tabs ===== */
    .tabs{
      position:fixed; bottom:0; left:0; right:0; z-index:30;
      padding: 8px 12px calc(env(safe-area-inset-bottom) + 8px);
      background: linear-gradient(to top, rgba(11,11,13,.94), rgba(11,11,13,.65));
      border-top:1px solid var(--line);
      backdrop-filter: blur(16px);
    }
    .tabRow{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;}
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.88);
      border-radius: 16px;
      padding:10px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size:11px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.20);
      color: var(--text);
    }
    .tab .emoji{font-size:16px; line-height:1}

    /* ===== Chart ===== */
    canvas{
      width:100%;
      height:160px;
      display:block;
      background: rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius: 16px;
    }

    /* ===== Modal ===== */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:50;
      padding: 12px 12px calc(env(safe-area-inset-bottom) + 120px);
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:100%;
      max-width:520px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,18,24,.96), rgba(18,18,24,.90));
      border-radius: 22px;
      box-shadow: 0 25px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalTop{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalTitle{font-weight:900; font-size:14px; margin:0}
    .modalBody{padding: 14px 16px; max-height: calc(75vh - 80px); overflow:auto}

    .form{display:grid; gap:12px}
    .field{display:grid; gap:6px}
    .labelRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:12px;
      color: rgba(255,255,255,.90);
    }
    .val{font-variant-numeric: tabular-nums; color: rgba(255,255,255,.90); font-weight:800}
    input[type="range"]{width:100%; accent-color: rgba(255,255,255,.85)}
    input[type="date"], input[type="text"], input[type="email"], input[type="password"], textarea{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{min-height:70px; resize:vertical}
    .hint{font-size:11px;color:var(--muted); line-height:1.25}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 120px;
      z-index:60;
      background: rgba(18,18,24,.92);
      border:1px solid var(--line);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      display:none;
      box-shadow: 0 15px 40px rgba(0,0,0,.55);
      white-space:nowrap;
      max-width: calc(100vw - 24px);
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{display:block}

    /* ===== Auth screen styled like your mock ===== */
    .authWrap{
      min-height: 100dvh;
      display:grid;
      place-items:center;
      padding: calc(env(safe-area-inset-top) + 18px) 16px calc(env(safe-area-inset-bottom) + 24px);
    }
    .authCard{
      width:min(520px, 100%);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius: 26px;
      box-shadow: 0 25px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .authHero{
      padding: 18px 18px 6px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .authLogo{
      width:54px;height:54px;border-radius:18px;
      background:url("logo.png") center/cover no-repeat;
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .authBrandTitle{
      margin:0;
      font-size:18px;
      font-weight:900;
      letter-spacing:.3px;
      line-height:1.1;
    }
    .authBrandSub{
      margin:4px 0 0;
      font-size:12px;
      color:rgba(255,255,255,.75);
      line-height:1.25;
    }
    .authBody{padding: 12px 18px 18px;}
    .authSwitch{
      display:flex; gap:10px; margin:10px 0 14px;
    }
    .seg{
      flex:1;
      text-align:center;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      font-size:12px;
      font-weight:800;
      color:rgba(255,255,255,.85);
    }
    .seg.active{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.22);
      color: var(--text);
    }
    .authFine{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-top:10px;
      font-size:12px;
      color:rgba(255,255,255,.70);
    }
    .link{
      color:rgba(255,255,255,.88);
      text-decoration:underline;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }

    .hide{display:none !important;}
  </style>
</head>

<body>
  <!-- AUTH SCREEN -->
  <div id="authScreen" class="authWrap">
    <div class="authCard">
      <div class="authHero">
        <div class="authLogo" aria-label="On Pointe Prevention logo"></div>
        <div>
          <p class="authBrandTitle">ONPOINTE PREVENTION</p>
          <p class="authBrandSub">Your leap, safely landed.<br/>PT-guided injury prevention + load monitoring.</p>
        </div>
      </div>

      <div class="authBody">
        <div class="authSwitch">
          <div class="seg active" id="segLogin">Log in</div>
          <div class="seg" id="segCreate">Create</div>
        </div>

        <div class="form">
          <div class="field">
            <div class="labelRow"><span>Email</span></div>
            <input id="authEmail" type="email" autocomplete="email" placeholder="you@example.com" />
          </div>

          <div class="field">
            <div class="labelRow"><span>Password</span></div>
            <input id="authPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            <div class="hint" id="pwHint">Use at least 6 characters.</div>
          </div>

          <button class="btn primary full" id="authMainBtn" type="button">Log in</button>

          <div class="authFine">
            <span class="link" id="forgotLink">Forgot password</span>
            <span id="authStatus" style="color:rgba(255,255,255,.75)"></span>
          </div>

          <div class="hint" style="margin-top:10px;">
            After login, your check-ins are saved to your account (works on iPhone + Android).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appShell" class="hide">
    <div class="top">
      <div class="brandRow">
        <div class="logo" aria-label="On Pointe Prevention logo"></div>

        <div class="brand">
          <p class="title">On Pointe Prevention‚Ñ¢</p>
          <p class="subtitle">PT-guided load monitoring + conditioning</p>
        </div>

        <div class="topActions">
          <button class="pillBtn" id="exportBtn" type="button">
            <span class="tinyDot"></span>
            <span>Export CSV</span>
          </button>
          <button class="pillBtn" id="logoutBtn" type="button" title="Log out">
            <span class="tinyDot"></span>
            <span>Logout</span>
          </button>
        </div>
      </div>
    </div>

    <main>
      <div class="container" id="screen-dashboard">
        <div class="grid">
          <div class="card">
            <div class="cardInner">
              <div class="cardHeader">
                <div>
                  <p class="h">Injury Risk Snapshot</p>
                  <div class="small">Based on acute/chronic load + recovery markers.</div>
                </div>
                <div class="badge ok" id="riskBadge">
                  <span class="badgeDot"></span>
                  <span id="riskLabel">OK</span>
                </div>
              </div>

              <div class="metrics">
                <div class="metric">
                  <div class="k">ACWR</div>
                  <div class="v" id="m_acwr">‚Äî</div>
                  <div class="s">acute / chronic</div>
                </div>
                <div class="metric">
                  <div class="k">Acute (7d avg)</div>
                  <div class="v" id="m_acute">‚Äî</div>
                  <div class="s">session load</div>
                </div>
                <div class="metric">
                  <div class="k">Chronic (28d avg)</div>
                  <div class="v" id="m_chronic">‚Äî</div>
                  <div class="s">session load</div>
                </div>
              </div>

              <div style="margin-top:12px">
                <p class="h">Guidance</p>
                <div class="small" id="guidanceText">Add check-ins to generate guidance.</div>

                <div class="btnRow">
                  <button class="btn primary" id="openCheckin" type="button">üìù Today‚Äôs Check-In</button>
                  <button class="btn" id="openExercises" type="button">ü©∞ Exercise Library</button>
                  <button class="btn danger" id="clearData" type="button">üóëÔ∏è Clear Data</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="cardInner">
              <div class="cardHeader">
                <div>
                  <p class="h">Trends</p>
                  <div class="small">Last 14 sessions (session load).</div>
                </div>
                <div class="badge" id="trendHint">Add more check-ins for trends</div>
              </div>
              <canvas id="trendCanvas" width="800" height="240"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="cardInner">
              <p class="h">Last 7 Days</p>
              <div class="small">Quick view of recent entries.</div>
              <div class="list" id="recentList"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="container" id="screen-checkin" style="display:none">
        <div class="card">
          <div class="cardInner">
            <p class="h">Today‚Äôs Check-In</p>
            <div class="small">Track load + recovery markers. Session load = minutes √ó RPE.</div>
            <div class="btnRow">
              <button class="btn primary" id="openCheckin2" type="button">üìù Open Check-In Form</button>
            </div>
          </div>
        </div>
      </div>

      <div class="container" id="screen-exercises" style="display:none">
        <div class="card">
          <div class="cardInner">
            <p class="h">Exercise Library</p>
            <div class="small">Dance-specific strength, neuromuscular control, and load-tolerance work.</div>
            <div class="list" id="exerciseList"></div>
          </div>
        </div>
      </div>

      <div class="container" id="screen-history" style="display:none">
        <div class="card">
          <div class="cardInner">
            <p class="h">History</p>
            <div class="small">All check-ins saved to your account.</div>
            <div class="list" id="historyList"></div>
          </div>
        </div>
      </div>
    </main>

    <div class="tabs">
      <div class="tabRow">
        <button class="tab active" data-tab="dashboard" type="button"><div class="emoji">üìä</div>Dashboard</button>
        <button class="tab" data-tab="checkin" type="button"><div class="emoji">üìù</div>Check-In</button>
        <button class="tab" data-tab="exercises" type="button"><div class="emoji">ü©∞</div>Exercises</button>
        <button class="tab" data-tab="history" type="button"><div class="emoji">üóìÔ∏è</div>History</button>
      </div>
    </div>

    <!-- Modal: Check-in -->
    <div class="modalBackdrop" id="checkinModal">
      <div class="modal">
        <div class="modalTop">
          <p class="modalTitle">Today‚Äôs Check-In</p>
          <button class="iconBtn" id="closeCheckin" type="button">‚óè Close</button>
        </div>
        <div class="modalBody">
          <form class="form" id="checkinForm">
            <div class="field">
              <div class="labelRow"><span>Date</span></div>
              <input type="date" id="f_date" required />
            </div>

            <div class="field">
              <div class="labelRow"><span>Dance minutes</span> <span class="val" id="v_minutes">60</span></div>
              <input type="range" id="f_minutes" min="0" max="240" value="60" />
              <div class="hint">Include class + rehearsal + performance time.</div>
            </div>

            <div class="field">
              <div class="labelRow"><span>RPE (0‚Äì10)</span> <span class="val" id="v_rpe">6</span></div>
              <input type="range" id="f_rpe" min="0" max="10" step="1" value="6" />
              <div class="hint">0 = rest, 10 = maximal effort.</div>
            </div>

            <div class="field">
              <div class="labelRow"><span>Sleep (hours)</span> <span class="val" id="v_sleep">7.0</span></div>
              <input type="range" id="f_sleep" min="0" max="10" step="0.5" value="7" />
            </div>

            <div class="field">
              <div class="labelRow"><span>Soreness (0‚Äì10)</span> <span class="val" id="v_sore">3</span></div>
              <input type="range" id="f_sore" min="0" max="10" step="1" value="3" />
            </div>

            <div class="field">
              <div class="labelRow"><span>Fatigue (0‚Äì10)</span> <span class="val" id="v_fatigue">4</span></div>
              <input type="range" id="f_fatigue" min="0" max="10" step="1" value="4" />
            </div>

            <div class="field">
              <div class="labelRow"><span>Notes (optional)</span></div>
              <textarea id="f_notes" placeholder="Pain location, jumps, pointe work, travel, stress, etc."></textarea>
            </div>

            <div class="btnRow">
              <button class="btn primary" type="submit">üíæ Save ‚úì</button>
              <button class="btn ghost" id="cancelCheckin" type="button">Close</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal: Exercise detail -->
    <div class="modalBackdrop" id="exerciseModal">
      <div class="modal">
        <div class="modalTop">
          <p class="modalTitle" id="exTitle">Exercise</p>
          <button class="iconBtn" id="closeExercise" type="button">‚óè Close</button>
        </div>
        <div class="modalBody" id="exBody"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Saved</div>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      getDocs,
      collection,
      query,
      orderBy,
      limit,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // ‚úÖ Your config (already correct)
    const firebaseConfig = {
      apiKey: "AIzaSyBmgTapl6qs29Cdr_WlNOKTq_yttO9kqW8",
      authDomain: "on-pointe-prevention.firebaseapp.com",
      projectId: "on-pointe-prevention",
      storageBucket: "on-pointe-prevention.firebasestorage.app",
      messagingSenderId: "235349964683",
      appId: "1:235349964683:web:0b1a3b3e494bd86fc0a18e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const fmt1 = (n) => (Math.round(n * 10) / 10).toFixed(1);
    const todayISO = () => new Date().toISOString().slice(0,10);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1400);
    }

    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function prettyDate(iso){
      try{
        const d = new Date(iso + "T00:00:00");
        return d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" });
      }catch(e){ return iso; }
    }

    function sessionLoad(entry){
      return Math.round((Number(entry.minutes)||0) * (Number(entry.rpe)||0));
    }

    // ---------- Auth UI ----------
    let authMode = "login"; // "login" | "create"

    function setAuthMode(mode){
      authMode = mode;
      $("segLogin").classList.toggle("active", mode === "login");
      $("segCreate").classList.toggle("active", mode === "create");
      $("authMainBtn").textContent = mode === "login" ? "Log in" : "Create";
      $("pwHint").textContent = mode === "create" ? "Use at least 6 characters." : " ";
      $("authStatus").textContent = "";
    }

    $("segLogin").addEventListener("click", ()=> setAuthMode("login"));
    $("segCreate").addEventListener("click", ()=> setAuthMode("create"));

    $("forgotLink").addEventListener("click", async ()=>{
      const email = ($("authEmail").value || "").trim();
      if(!email){
        toast("Enter your email first");
        return;
      }
      try{
        await sendPasswordResetEmail(auth, email);
        toast("Password reset email sent");
      }catch(err){
        toast(err?.message || "Reset failed");
      }
    });

    $("authMainBtn").addEventListener("click", async ()=>{
      const email = ($("authEmail").value || "").trim();
      const pass  = ($("authPass").value || "").trim();

      if(!email || !pass){
        toast("Enter email + password");
        return;
      }

      $("authStatus").textContent = "Working‚Ä¶";
      try{
        if(authMode === "login"){
          await signInWithEmailAndPassword(auth, email, pass);
          toast("Logged in");
        }else{
          await createUserWithEmailAndPassword(auth, email, pass);
          toast("Account created");
        }
      }catch(err){
        toast(err?.message || "Auth error");
      }finally{
        $("authStatus").textContent = "";
      }
    });

    $("logoutBtn").addEventListener("click", async ()=>{
      await signOut(auth);
    });

    // ---------- Firestore storage (per-user) ----------
    function userCheckinsCol(uid){
      return collection(db, "users", uid, "checkins");
    }

    async function upsertCheckin(uid, entry){
      // doc id = date, so it "updates" when same date is saved again
      const ref = doc(db, "users", uid, "checkins", entry.date);
      await setDoc(ref, entry, { merge:true });
    }

    async function getAllCheckins(uid){
      // newest first
      const q = query(userCheckinsCol(uid), orderBy("date", "desc"));
      const snap = await getDocs(q);
      return snap.docs.map(d => d.data());
    }

    async function clearAllCheckins(uid){
      const q = query(userCheckinsCol(uid), orderBy("date", "desc"), limit(500));
      const snap = await getDocs(q);
      await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
    }

    // ---------- App logic ----------
    const EXERCISES = [
      {
        name: "Calf Capacity (Eccentric/Isometric)",
        focus: "Foot/ankle load tolerance ¬∑ pointe/jumps",
        how: [
          "Isometric: 3√ó30‚Äì45s single-leg calf hold (mid-range), pain ‚â§3/10.",
          "Eccentric: 3√ó8‚Äì12 slow lowers off step, 3‚Äì4 sec down.",
          "Progress: add load (backpack), increase range, add pogo hops when tolerated."
        ],
        cues: ["Tripod foot", "Control the lowering", "No collapsing arch"]
      },
      {
        name: "Hip Abductor Strength (Side Plank + Clamshell)",
        focus: "Pelvic control ¬∑ single-limb stability",
        how: [
          "Side plank (knees or feet): 3√ó20‚Äì30s each side.",
          "Clamshell: 3√ó12‚Äì15 slow reps, add band when easy.",
          "Progress: lateral step-down, single-leg RDL patterns."
        ],
        cues: ["Ribs down", "Stack pelvis", "Control knee alignment"]
      },
      {
        name: "Single-Leg Control (Step-down)",
        focus: "Knee/hip alignment ¬∑ landing mechanics",
        how: [
          "3√ó6‚Äì10 reps each side, slow 3 sec down, light tap, return.",
          "Progress: higher step, add load, add reach patterns."
        ],
        cues: ["Knee over 2nd toe", "Quiet pelvis", "No trunk sway"]
      },
      {
        name: "Core + Rotation Control (Dead Bug / Pallof Press)",
        focus: "Lumbar load management",
        how: [
          "Dead bug: 3√ó6‚Äì10 controlled reps.",
          "Pallof press: 3√ó10‚Äì12 each side.",
          "Progress: longer lever arms, unstable stance."
        ],
        cues: ["Breathe", "Maintain neutral spine", "Slow + controlled"]
      }
    ];

    function renderExerciseList(){
      const el = $("exerciseList");
      el.innerHTML = "";
      EXERCISES.forEach((ex)=>{
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="rowMain">
            <div class="rowTop">
              <div class="rowTitle">${ex.name}</div>
              <div class="rowMeta">${ex.focus}</div>
            </div>
            <div class="rowSub">Tap to view sets, reps, progressions.</div>
          </div>
          <div class="rowRight">
            <button class="iconBtn" type="button">Open</button>
          </div>
        `;
        row.querySelector("button").addEventListener("click", ()=> openExercise(ex));
        row.addEventListener("click", (ev)=>{
          if(ev.target.tagName.toLowerCase() !== "button") openExercise(ex);
        });
        el.appendChild(row);
      });
    }

    function openExercise(ex){
      $("exTitle").textContent = ex.name;
      $("exBody").innerHTML = `
        <div class="chip" style="display:inline-flex; margin-bottom:10px;">${escapeHTML(ex.focus)}</div>
        <div style="margin:10px 0 6px; font-weight:850;">How to do it</div>
        <div style="display:grid; gap:8px;">
          ${ex.how.map(x=>`<div class="rowSub">‚Ä¢ ${escapeHTML(x)}</div>`).join("")}
        </div>
        <div style="margin:14px 0 6px; font-weight:850;">Coaching cues</div>
        <div style="display:grid; gap:8px;">
          ${ex.cues.map(x=>`<div class="rowSub">‚Ä¢ ${escapeHTML(x)}</div>`).join("")}
        </div>
      `;
      $("exerciseModal").classList.add("show");
    }

    // ---------- Metrics ----------
    function lastNDays(entries, days){
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - (days-1));
      cutoff.setHours(0,0,0,0);
      return entries.filter(e => new Date(e.date) >= cutoff);
    }

    function avgDailyLoad(entries, days){
      const total = lastNDays(entries, days).reduce((s,e)=> s + sessionLoad(e), 0);
      return total / days;
    }

    function computeMetrics(entries){
      const acute = avgDailyLoad(entries, 7);
      const chronic = avgDailyLoad(entries, 28);
      const acwr = (chronic > 0) ? (acute / chronic) : null;
      return { acute, chronic, acwr };
    }

    function riskFromACWR(acwr){
      if(acwr === null) return { cls:"ok", label:"OK" };
      if(acwr < 0.8) return { cls:"caution", label:"LOW" };
      if(acwr <= 1.3) return { cls:"ok", label:"OK" };
      if(acwr <= 1.5) return { cls:"caution", label:"CAUTION" };
      return { cls:"high", label:"HIGH" };
    }

    function guidanceText(entries, metrics){
      if(entries.length === 0) return "Add check-ins to generate guidance.";
      const { acwr } = metrics;
      if(acwr === null) return "Not enough history for ACWR. Keep logging daily load for the next 1‚Äì2 weeks.";
      if(acwr > 1.5) return "High workload spike detected. Reduce volume/intensity for 24‚Äì72h, prioritize sleep, and avoid high-impact jumps/pointe volume until recovery improves.";
      if(acwr > 1.3) return "Moderate spike. Maintain technique work, but cap additional conditioning volume and monitor soreness/fatigue closely.";
      if(acwr < 0.8) return "Load is low relative to recent baseline. Progress gradually to avoid a sudden jump next week.";
      return "Workload appears stable. Continue progressive conditioning and monitor recovery.";
    }

    // ---------- Render (Firestore-backed) ----------
    let currentUID = null;
    let cachedEntries = [];

    async function refreshFromCloud(){
      if(!currentUID) return;
      cachedEntries = await getAllCheckins(currentUID);
      render();
    }

    function render(){
      const entries = cachedEntries.slice().sort((a,b)=> (a.date < b.date ? 1 : -1));

      const metrics = computeMetrics(entries);
      const acute = metrics.acute;
      const chronic = metrics.chronic;
      const acwr = metrics.acwr;

      $("m_acute").textContent = entries.length ? Math.round(acute) : "‚Äî";
      $("m_chronic").textContent = entries.length ? Math.round(chronic) : "‚Äî";
      $("m_acwr").textContent = (acwr === null) ? "‚Äî" : fmt1(acwr);

      const risk = riskFromACWR(acwr);
      const badge = $("riskBadge");
      badge.classList.remove("ok","caution","high");
      badge.classList.add(risk.cls);
      $("riskLabel").textContent = risk.label;

      $("guidanceText").textContent = guidanceText(entries, metrics);

      renderRecent(entries);
      renderHistory(entries);
      renderChart(entries);
    }

    function renderRecent(entries){
      const el = $("recentList");
      el.innerHTML = "";
      const recent = lastNDays(entries, 7).slice(0,7);
      if(recent.length === 0){
        el.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No entries yet</div><div class="rowSub">Complete a check-in to populate your dashboard.</div></div></div>`;
        return;
      }
      recent.forEach(e=>{
        const load = sessionLoad(e);
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="rowMain">
            <div class="rowTop">
              <div class="rowTitle">${prettyDate(e.date)}</div>
              <div class="rowMeta">${e.minutes} min ¬∑ RPE ${e.rpe}</div>
            </div>
            <div class="rowSub">Sleep ${Number(e.sleep).toFixed(1)}h ¬∑ Soreness ${e.sore} ¬∑ Fatigue ${e.fatigue}</div>
          </div>
          <div class="rowRight">
            <div class="chip">Load ${load}</div>
          </div>
        `;
        el.appendChild(row);
      });
    }

    function renderHistory(entries){
      const el = $("historyList");
      el.innerHTML = "";
      if(entries.length === 0){
        el.innerHTML = `<div class="row"><div class="rowMain"><div class="rowTitle">No saved check-ins</div><div class="rowSub">Use the Check-In tab to add your first entry.</div></div></div>`;
        return;
      }
      entries.forEach(e=>{
        const load = sessionLoad(e);
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="rowMain">
            <div class="rowTop">
              <div class="rowTitle">${prettyDate(e.date)}</div>
              <div class="rowMeta">${e.minutes} min ¬∑ RPE ${e.rpe}</div>
            </div>
            <div class="rowSub">${(e.notes||"").trim() ? escapeHTML(e.notes) : "‚Äî"}</div>
          </div>
          <div class="rowRight">
            <div class="chip">Load ${load}</div>
            <button class="iconBtn" type="button" data-edit="${e.date}">Edit</button>
          </div>
        `;
        row.querySelector('[data-edit]').addEventListener("click", ()=>{
          openCheckinModal(e);
        });
        el.appendChild(row);
      });
    }

    function renderChart(entries){
      const canvas = $("trendCanvas");
      const ctx = canvas.getContext("2d");
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      const last14 = entries.slice().reverse().slice(-14);
      const loads = last14.map(sessionLoad);

      ctx.globalAlpha = 1;
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;
      for(let i=1;i<4;i++){
        const y = (h/4)*i;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }

      if(loads.length === 0){
        ctx.fillStyle = "rgba(255,255,255,.55)";
        ctx.font = "14px " + getComputedStyle(document.body).fontFamily;
        ctx.fillText("No data yet", 18, 38);
        return;
      }

      const max = Math.max(100, ...loads);
      const min = 0;

      const padX = 18, padY = 22;
      const plotW = w - padX*2;
      const plotH = h - padY*2;

      const x = (i)=> padX + (plotW * (loads.length===1 ? 0.5 : (i/(loads.length-1))));
      const y = (v)=> padY + plotH * (1 - ((v - min) / (max - min)));

      ctx.strokeStyle = "rgba(255,255,255,.80)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      loads.forEach((v,i)=>{
        const px=x(i), py=y(v);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
      });
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,.90)";
      loads.forEach((v,i)=>{
        ctx.beginPath();
        ctx.arc(x(i), y(v), 3, 0, Math.PI*2);
        ctx.fill();
      });

      const latest = loads[loads.length-1];
      ctx.fillStyle = "rgba(255,255,255,.70)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText("Latest: " + latest, 18, 18);
    }

    // ---------- Check-in modal ----------
    function syncVals(){
      $("v_minutes").textContent = $("f_minutes").value;
      $("v_rpe").textContent = $("f_rpe").value;
      $("v_sleep").textContent = Number($("f_sleep").value).toFixed(1);
      $("v_sore").textContent = $("f_sore").value;
      $("v_fatigue").textContent = $("f_fatigue").value;
    }

    function openCheckinModal(existing=null){
      $("checkinModal").classList.add("show");
      $("f_date").value = existing ? existing.date : todayISO();
      $("f_minutes").value = existing ? existing.minutes : 60;
      $("f_rpe").value     = existing ? existing.rpe : 6;
      $("f_sleep").value   = existing ? existing.sleep : 7;
      $("f_sore").value    = existing ? existing.sore : 3;
      $("f_fatigue").value = existing ? existing.fatigue : 4;
      $("f_notes").value   = existing ? (existing.notes||"") : "";
      syncVals();
    }
    function closeCheckinModal(){ $("checkinModal").classList.remove("show"); }

    // ---------- Export CSV ----------
    function exportCSV(){
      const entries = cachedEntries.slice().sort((a,b)=> (a.date < b.date ? 1 : -1));
      const header = ["date","minutes","rpe","session_load","sleep_hours","soreness","fatigue","notes"];
      const rows = entries.map(e=>{
        const row = [
          e.date,
          e.minutes,
          e.rpe,
          sessionLoad(e),
          Number(e.sleep).toFixed(1),
          e.sore,
          e.fatigue,
          (e.notes||"").replace(/\n/g," ").replace(/"/g,'""')
        ];
        return row.map(x=> `"${x}"`).join(",");
      });
      const csv = header.join(",") + "\n" + rows.join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "on-pointe-prevention_checkins.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exported CSV");
    }

    // ---------- Tabs ----------
    function setTab(tab){
      const screens = ["dashboard","checkin","exercises","history"];
      screens.forEach(s=>{
        document.getElementById("screen-"+s).style.display = (s===tab) ? "" : "none";
      });
      document.querySelectorAll(".tab").forEach(b=>{
        b.classList.toggle("active", b.dataset.tab === tab);
      });
      render();
    }

    // ---------- PWA (Android + iOS friendly) ----------
    function setupPWA(){
      const manifest = {
        name: "On Pointe Prevention",
        short_name: "On Pointe",
        start_url: "./",
        display: "standalone",
        background_color: "#0B0B0D",
        theme_color: "#0B0B0D",
        icons: [
          { src: "logo.png", sizes: "192x192", type: "image/png" },
          { src: "logo.png", sizes: "512x512", type: "image/png" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement("link");
      link.rel = "manifest";
      link.href = url;
      document.head.appendChild(link);

      if("serviceWorker" in navigator){
        const sw = `
          const CACHE="opp-cache-v2";
          const ASSETS=["./","./index.html","./logo.png"];
          self.addEventListener("install", e=>{
            e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).catch(()=>{}));
            self.skipWaiting();
          });
          self.addEventListener("activate", e=>{ e.waitUntil(self.clients.claim()); });
          self.addEventListener("fetch", e=>{
            e.respondWith(
              caches.match(e.request).then(r=> r || fetch(e.request).then(res=>{
                const copy=res.clone();
                caches.open(CACHE).then(c=>c.put(e.request, copy)).catch(()=>{});
                return res;
              }).catch(()=>r))
            );
          });
        `;
        const swURL = URL.createObjectURL(new Blob([sw], {type:"text/javascript"}));
        navigator.serviceWorker.register(swURL).catch(()=>{});
      }
    }

    // ---------- Wire events ----------
    function wireApp(){
      document.querySelectorAll(".tab").forEach(btn=>{
        btn.addEventListener("click", ()=> setTab(btn.dataset.tab));
      });

      $("openCheckin").addEventListener("click", ()=> openCheckinModal());
      $("openCheckin2").addEventListener("click", ()=> openCheckinModal());
      $("openExercises").addEventListener("click", ()=> setTab("exercises"));

      $("exportBtn").addEventListener("click", exportCSV);

      $("clearData").addEventListener("click", async ()=>{
        if(!currentUID) return;
        if(confirm("Clear all saved check-ins for this account?")){
          await clearAllCheckins(currentUID);
          toast("Cleared");
          await refreshFromCloud();
        }
      });

      $("closeCheckin").addEventListener("click", closeCheckinModal);
      $("cancelCheckin").addEventListener("click", closeCheckinModal);
      $("checkinModal").addEventListener("click", (e)=>{
        if(e.target === $("checkinModal")) closeCheckinModal();
      });

      $("closeExercise").addEventListener("click", ()=> $("exerciseModal").classList.remove("show"));
      $("exerciseModal").addEventListener("click", (e)=>{
        if(e.target === $("exerciseModal")) $("exerciseModal").classList.remove("show");
      });

      ["f_minutes","f_rpe","f_sleep","f_sore","f_fatigue"].forEach(id=>{
        $(id).addEventListener("input", syncVals);
      });

      $("checkinForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        if(!currentUID){
          toast("Not logged in");
          return;
        }

        const entry = {
          date: $("f_date").value,
          minutes: Number($("f_minutes").value),
          rpe: Number($("f_rpe").value),
          sleep: Number($("f_sleep").value),
          sore: Number($("f_sore").value),
          fatigue: Number($("f_fatigue").value),
          notes: $("f_notes").value || ""
        };

        try{
          await upsertCheckin(currentUID, entry);
          toast("Saved ‚úì");
          closeCheckinModal();
          await refreshFromCloud();
        }catch(err){
          toast(err?.message || "Save failed");
        }
      });
    }

    // ---------- Auth state -> show correct screen ----------
    function showAuth(){ $("authScreen").classList.remove("hide"); $("appShell").classList.add("hide"); }
    function showApp(){ $("authScreen").classList.add("hide"); $("appShell").classList.remove("hide"); }

    // ---------- Init ----------
    (function init(){
      setupPWA();
      renderExerciseList();
      wireApp();
      setAuthMode("login");
      setTab("dashboard");

      onAuthStateChanged(auth, async (user)=>{
        if(user){
          currentUID = user.uid;
          showApp();
          toast("Welcome");
          await refreshFromCloud();
        }else{
          currentUID = null;
          cachedEntries = [];
          showAuth();
        }
      });
    })();
  </script>
</body>
</html>
    
  </body>
  
</html>
